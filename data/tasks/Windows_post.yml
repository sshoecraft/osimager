---
- name: Disable Automatic Updates
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
    name: NoAutoUpdate
    type: dword
    data: 1

- name: Enable console QuickEdit mode
  win_regedit:
    path: HKCU:\Console
    name: QuickEdit
    type: dword
    data: 1

- name: Show Administrative Tools in Start Menu
  win_regedit:
    path: HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced
    name: StartMenuAdminTools
    type: dword
    data: 1

- name: Show file extensions in Explorer
  win_regedit:
    path: HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced
    name: HideFileExt
    type: dword
    data: 0

- name: Show Run command in Start Menu
  win_regedit:
    path: HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced
    name: Start_ShowRun
    type: dword
    data: 1

- name: Disable Screensaver
  win_regedit:
    path: HKCU:\Control Panel\Desktop
    name: ScreenSaveActive
    type: dword
    data: 0

- name: Disable Monitor Timeout (AC)
  win_command: powercfg -x -monitor-timeout-ac 0

- name: Disable Monitor Timeout (DC)
  win_command: powercfg -x -monitor-timeout-dc 0

#- name: Disable Logon Background Image
#  win_regedit:
#    path: 'HKLM:\Software\Policies\Microsoft\Windows\System'
#    name: DisableLogonBackgroundImage
#    data: 1
#    type: dword

- name: Enable Administrator account
  win_user:
    name: Administrator
    account_disabled: false
  when: ansible_distribution is search("Microsoft Windows 10")

#- name: Enable telnet
#  win_feature:
#    name: telnet-client
#  when: ansible_distribution is not search("Microsoft Windows 10")

- name: Enable UAC
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableLUA
    type: dword
    data: 1

- name: Enable RDP (Registry)
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server
    name: fDenyTSConnections
    type: dword
    data: 0

- name: Enable RDP (Firewall)
  win_firewall_rule:
    name: Allow Remote Desktop
    localport: 3389
    action: allow
    direction: in
    protocol: tcp
    profiles: private
    state: present
    enabled: true

- name: Enable RDP Connections from any computers (Registry)
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-TCP
    name: UserAuthentication
    type: dword
    data: 0

- name: Disable Hibernation Mode
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Power
    name: HibernateEnabled
    type: dword
    data: 0

- name: Zero Hibernation file
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Power
    name: HibernateFileSizePercent
    type: dword
    data: 0

- name: Disable Network Discovery (Registry)
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Network\NewNetworkWindowOff

- name: Disable Network Discovery (Firewall)
  win_firewall_rule:
    group: "Network Discovery"
    enabled: false

- name: Disable firewall for Domain, Public and Private profiles
  win_firewall:
    state: disabled
    profiles:
      - Domain
      - Private
      - Public
  when: disable_firewall is defined

- name: Disable password expiration for Administrator user
  win_command: wmic useraccount where "name='Administrator'" set PasswordExpires=FALSE

- include_tasks: windows_updates.yml

- name: Find installers
  win_find: paths=c:/install/ patterns='install_*.ps1'
  register: found

- name: Install software
  win_shell: "{{item}}"
  with_items: "{{ found.files | map(attribute='path') | list }}"
  register: install
- debug: var=install

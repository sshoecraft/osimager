%post

# grub config
if test -f /boot/grub/grub.conf; then
    sed -i -e 's:^default=[1-9]:default=0:' /boot/grub/grub.conf
    sed -i -e 's: rhgb quiet::' /boot/grub/grub.conf
    sed -i -e 's:^splashimage=:#splashimage=:' /boot/grub/grub.conf
    sed -i -e 's:^hiddenmenu:#hiddenmenu:' /boot/grub/grub.conf
    sed -i -e 's:^timeout=5:timeout=15:' /boot/grub/grub.conf
fi

# UEK crashes after reboot on vsphere
# If user wants it they can install later
yum -y remove kernel-uek kernel-uek-firmware
grub2-mkconfig -o /boot/grub/grub.conf

sed -i 's/^.*PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config
sed -i "s/^.*requiretty/#Defaults requiretty/" /etc/sudoers

# Install vmware tools, if found on an attached CD
install_vmw_tools() {
    set -x
    done=0
    for nm in cdrom sr0 sr1 sr2 sr3 hda hdb hdc hdd
    do
        if test -e /dev/$nm; then
            mount /dev/$nm /mnt || continue
            ls /mnt/
            arc=$(ls /mnt/VMwareTools* 2>/dev/null)
            if test -n "$arc"; then
                cd /tmp
                tar -zxf $arc
                cd vmware-tools-distrib && ./vmware-install.pl -d
                done=1
            fi
            umount /mnt
        fi
        test $done -eq 1 && break
    done
}
install_vmw_tools > /root/tools.log 2>&1

exit 0

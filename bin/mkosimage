#!/usr/bin/env python3
"""
mkosimage - Main OSImager CLI script.

This script provides the primary interface for building OS images
using the OSImager system.
"""

import sys
import os
from typing import List, Optional

# Add the lib directory to the path to import osimager
# Handle both development and installation environments
script_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(script_dir)

if os.path.exists('/opt/osimager/lib'):
    # Installation environment
    sys.path.insert(0, '/opt/osimager/lib')
else:
    # Development environment - lib directory is in project root
    lib_path = os.path.join(project_root, 'lib')
    sys.path.insert(0, lib_path)

from osimager.core import OSImager
from osimager.constants import EXIT_SUCCESS, EXIT_GENERAL_ERROR


def main(argv: Optional[List[str]] = None) -> int:
    """
    Main entry point for mkosimage CLI script.
    
    Args:
        argv: Command line arguments (defaults to sys.argv[1:])
        
    Returns:
        int: Exit code (0 for success, non-zero for failure)
    """
    if argv is None:
        argv = sys.argv[1:]
    
    try:
        # Create OSImager instance with full functionality
        osimager = OSImager(argv=argv, which="full")
        
        # Handle list mode
        if osimager.list:
            index = osimager.get_index()
            if index:
                print("Available specs:")
                for spec_key in sorted(index.keys()):
                    entry = index[spec_key]
                    provides = entry.get('provides', {})
                    dist = provides.get('dist', 'unknown')
                    version = provides.get('version', 'unknown')
                    arch = provides.get('arch', 'unknown')
                    iso_flag = " *" if entry.get('iso_local', False) else ""
                    print(f"  {spec_key} ({dist} {version} {arch}){iso_flag}")
            else:
                print("No specs found.")
            return EXIT_SUCCESS
        
        # Version is handled in core.py's init_settings and exits there if requested
        # No need to handle it here
        
        # Check if target was provided
        if not osimager.target:
            print("Usage: mkosimage [OPTIONS] PLATFORM/LOCATION/SPEC [NAME] [IP]")
            print("Use --help for more information.")
            return EXIT_SUCCESS
        
        # Build the image
        build_config = osimager.make_build(
            osimager.target, 
            name=osimager.name, 
            ip=osimager.ip or ""
        )
        
        if osimager.dump_defs or osimager.dump_build:
            # Dumping was handled in make_build
            return EXIT_SUCCESS
        
        # Run packer
        osimager.run_packer()
        
        return EXIT_SUCCESS
        
    except SystemExit as e:
        return e.code if e.code is not None else EXIT_GENERAL_ERROR
    except KeyboardInterrupt:
        print("\nOperation cancelled by user.")
        return EXIT_GENERAL_ERROR
    except Exception as e:
        print(f"Error: {e}")
        if hasattr(osimager, 'debug') and osimager.debug:
            import traceback
            traceback.print_exc()
        return EXIT_GENERAL_ERROR


if __name__ == "__main__":
    sys.exit(main())

{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"OSImager","text":"<p>Multi-platform OS image builder using HashiCorp Packer. Build VM images for any OS from a single command.</p> <pre><code>mkosimage &lt;platform&gt;/&lt;location&gt;/&lt;spec&gt; [name] [ip]\n</code></pre> <p>OSImager merges three configuration layers into a complete Packer build:</p> <ul> <li>Platform -- your hypervisor or cloud provider (ships with the package)</li> <li>Location -- your environment: network, DNS, storage paths, credentials (you create this)</li> <li>Spec -- the OS to build: distro, version, arch, install method (ships with the package)</li> </ul>"},{"location":"#feature-highlights","title":"Feature Highlights","text":"Area Details OS specs 339+ covering 12 distributions, from RHEL 2.1 (2002) to current releases Platforms 13: VirtualBox, VMware, vSphere, Proxmox, QEMU/KVM, libvirt, Hyper-V, XenServer, Azure, GCP, AWS, none Config merging Hierarchical with deep inheritance and 6 types of specific overrides Template engine 12-action substitution system with typed markers Credentials Two backends: HashiCorp Vault or local secrets file Install methods Kickstart, preseed, cloud-init, AutoYaST, Autounattend Post-install Ansible provisioning with per-distro and per-version task selection"},{"location":"#distributions","title":"Distributions","text":"<p>RHEL, CentOS, AlmaLinux, Rocky Linux, Oracle Enterprise Linux, Debian, Ubuntu, SLES, ESXi, SysVR4, Windows, Windows Server</p>"},{"location":"#configuration-merge-flow","title":"Configuration Merge Flow","text":"<p>Every build starts from <code>all.json</code> (global defaults) and layers configs on top. After the base merge, each layer's <code>*_specific</code> sections are applied when their condition matches the current build context.</p> <pre><code>all.json                          Global defaults (CPU, memory, disk)\n  |\n  v\nplatform/&lt;name&gt;.json              Builder type, platform settings\n  |\n  v\nlocation/&lt;name&gt;.json|toml         Network, DNS, NTP, storage paths\n  |\n  v\nspec/&lt;name&gt;/spec.json             OS-specific: iso, boot, install config\n  |                               (may chain via \"include\" to a parent spec)\n  v\n+-------------------------------+\n| Specific Overrides (per layer)|\n|   platform_specific            |\n|   location_specific            |\n|   dist_specific                |\n|   version_specific             |\n|   arch_specific                |\n|   firmware_specific            |\n+-------------------------------+\n  |\n  v\nTemplate substitution (12 actions)\n  |\n  v\nPacker build JSON\n</code></pre> <p>Each <code>*_specific</code> section uses regex matching (<code>re.fullmatch</code>) against the current build's value for that dimension. This lets a single spec cover dozens of versions with targeted overrides where needed.</p>"},{"location":"#template-engine","title":"Template Engine","text":"<p>The substitution engine processes all config values through 12 marker-delimited actions:</p> Action Markers Purpose 1 <code>%&gt;..&lt;%</code> Replace entire value with defs variable 2 <code>&gt;&gt;..&lt;&lt;</code> Inline substitution from defs 3 <code>+&gt;..&lt;+</code> Basename of defs variable 4 <code>*&gt;..&lt;*</code> DNS lookup (resolve to IP) 5 <code>\\|&gt;..&lt;\\|</code> Secret from Vault or local secrets 6 <code>#&gt;..&lt;#</code> Numeric expression evaluation 7 <code>$&gt;..&lt;$</code> Environment variable 8 <code>1&gt;..&lt;1</code> MD5 password hash of secret 9 <code>5&gt;..&lt;5</code> SHA-256 password hash of secret 10 <code>6&gt;..&lt;6</code> SHA-512 password hash of secret 11 <code>E&gt;..&lt;E</code> Python expression evaluation 12 <code>[&gt;..&lt;]</code> Insert list items (space-separated)"},{"location":"#quick-links","title":"Quick Links","text":"<p>Getting started</p> <ul> <li>Installation -- install from PyPI or source</li> <li>Getting Started -- first build walkthrough</li> </ul> <p>Configuration</p> <ul> <li>Location Setup -- create your environment config</li> <li>Credential Setup -- Vault or local secrets</li> </ul> <p>Reference</p> <ul> <li>CLI Reference -- all command-line options</li> <li>Supported OS -- full distro/version matrix</li> <li>Platform Reference -- platform configs and capabilities</li> <li>Spec Reference -- spec file format and fields</li> </ul> <p>Architecture</p> <ul> <li>Build Pipeline -- end-to-end build flow</li> <li>Configuration Merging -- how layers compose</li> <li>Template Engine -- substitution actions in detail</li> </ul>"},{"location":"getting-started/","title":"Getting Started","text":"<p>A quickstart walkthrough for building your first OS image with OSImager and VirtualBox.</p> <p>Prerequisites: OSImager installed (<code>pip install osimager</code>), Packer, Ansible, VirtualBox, and mkisofs. See Installation for details.</p>"},{"location":"getting-started/#step-1-create-a-location","title":"Step 1: Create a Location","text":"<p>A location defines your build environment: network settings, DNS, NTP, and where ISOs and VMs live on disk.</p> <p>Copy the quickstart template into your user config directory:</p> <pre><code>mkdir -p ~/.config/osimager/locations\ncp $(python3 -c \"import osimager; import os; print(os.path.join(os.path.dirname(osimager.__file__), 'data', 'examples', 'quickstart-location.toml'))\") \\\n   ~/.config/osimager/locations/local.toml\n</code></pre> <p>Edit <code>~/.config/osimager/locations/local.toml</code> to match your network:</p> <pre><code>platforms = [\"virtualbox\"]\n\n[defs]\ndomain = \"home.local\"\ngateway = \"192.168.1.1\"\ncidr = \"192.168.1.0/24\"\nvms_path = \"/vms\"\niso_path = \"/iso\"\n\n[defs.dns]\nservers = [\"192.168.1.1\"]\n\n[defs.ntp]\nservers = [\"pool.ntp.org\"]\n</code></pre> <p>Field reference:</p> Field Description <code>platforms</code> Hypervisors this location supports. Must match a platform name OSImager knows about (e.g. <code>virtualbox</code>, <code>vmware</code>, <code>vsphere</code>, <code>proxmox</code>). <code>domain</code> DNS domain suffix appended to hostnames to form FQDNs (e.g. <code>myvm.home.local</code>). <code>gateway</code> Default network gateway for built VMs. <code>cidr</code> Network CIDR. OSImager derives the subnet, prefix length, and netmask from this automatically. <code>vms_path</code> Directory where built VM images are stored. <code>iso_path</code> Directory containing OS installation ISO files. Point this at wherever you download ISOs. <code>dns.servers</code> List of DNS servers injected into kickstart/preseed/autoinst configs. <code>ntp.servers</code> List of NTP servers for time synchronization during and after install."},{"location":"getting-started/#step-2-set-up-credentials","title":"Step 2: Set Up Credentials","text":"<p>OS image builds need credentials for SSH access during the build and for setting the root/admin password in the installed OS.</p> <p>Switch to local secrets mode:</p> <pre><code>mkosimage --set credential_source=config\n</code></pre> <p>Create <code>~/.config/osimager/secrets</code> with your credentials:</p> <pre><code>images/linux username=root password=YourPassword\nimages/windows username=Administrator password=YourPassword\n</code></pre> <p>The <code>images/linux</code> path is referenced by Linux spec files. During the build, OSImager uses these credentials for SSH access to the VM and injects them into kickstart/preseed templates to set the root password. The <code>images/windows</code> path works the same way for Windows builds via WinRM and Autounattend.xml.</p> <p>For HashiCorp Vault integration instead of local secrets, see Credential Setup.</p>"},{"location":"getting-started/#step-3-install-the-virtualbox-packer-plugin","title":"Step 3: Install the VirtualBox Packer Plugin","text":"<pre><code>packer plugins install github.com/hashicorp/virtualbox\npacker plugins install github.com/hashicorp/ansible\n</code></pre>"},{"location":"getting-started/#step-4-list-available-specs","title":"Step 4: List Available Specs","text":"<pre><code>mkosimage --list\n</code></pre> <p>Output shows every spec OSImager knows about. Specs with a <code>*</code> suffix have a matching ISO found in your <code>iso_path</code>:</p> <pre><code>Available specs:\n  alma-8.10-x86_64 (alma 8.10 x86_64)\n  alma-9.5-x86_64 (alma 9.5 x86_64) *\n  centos-7.9-x86_64 (centos 7.9 x86_64)\n  debian-12-amd64 (debian 12 amd64) *\n  rocky-9.5-x86_64 (rocky 9.5 x86_64)\n  ...\n</code></pre> <p>Download the ISO for the spec you want to build and place it in your <code>iso_path</code> directory.</p>"},{"location":"getting-started/#step-5-build-an-image","title":"Step 5: Build an Image","text":"<pre><code>mkosimage virtualbox/local/alma-9.5-x86_64\n</code></pre> <p>The target format is <code>platform/location/spec</code>. OSImager:</p> <ol> <li>Loads the <code>virtualbox</code> platform config (builder type, VM settings).</li> <li>Loads the <code>local</code> location config (network, paths, DNS, NTP).</li> <li>Loads the <code>alma-9.5-x86_64</code> spec (ISO, kickstart template, provisioners).</li> <li>Merges all three into a unified defs dictionary.</li> <li>Generates a kickstart file from the spec template with the merged values.</li> <li>Produces a Packer build JSON and executes <code>packer build</code>.</li> </ol> <p>To assign a hostname and static IP:</p> <pre><code>mkosimage virtualbox/local/alma-9.5-x86_64 myvm 192.168.1.100\n</code></pre>"},{"location":"getting-started/#step-6-explore","title":"Step 6: Explore","text":"<p>Inspect what OSImager will do before committing to a full build:</p> <pre><code># Dry run -- shows the Packer command without executing it\nmkosimage -n virtualbox/local/alma-9.5-x86_64\n\n# Dump the resolved defs dictionary -- see all merged variables\nmkosimage -x virtualbox/local/alma-9.5-x86_64\n\n# Dump the Packer build JSON -- see exactly what gets sent to Packer\nmkosimage -u virtualbox/local/alma-9.5-x86_64\n</code></pre> <p>These are useful for debugging location or spec issues, and for understanding how platform + location + spec configs merge together.</p>"},{"location":"getting-started/#next-steps","title":"Next Steps","text":"<ul> <li>Location Setup -- multi-platform locations, vSphere/Proxmox network configs</li> <li>Credential Setup -- HashiCorp Vault integration</li> <li>Platform Reference -- all 13 supported platforms and their options</li> <li>Spec Reference -- spec file format, version ranges, template substitution</li> <li>Supported Operating Systems -- full list of distributions and versions</li> </ul>"},{"location":"installation/","title":"Installation","text":""},{"location":"installation/#quick-install","title":"Quick Install","text":"<pre><code>pip install osimager\n</code></pre>"},{"location":"installation/#prerequisites","title":"Prerequisites","text":"<ul> <li>Python 3.8+</li> <li>HashiCorp Packer -- install instructions</li> <li>Ansible -- <code>pip install ansible</code></li> <li>A hypervisor -- VirtualBox is free and easiest to start with</li> <li>mkisofs -- <code>brew install cdrtools</code> (macOS) or <code>apt install genisoimage</code> (Linux)</li> </ul>"},{"location":"installation/#packer-plugins","title":"Packer Plugins","text":"<p>OSImager supports 13 platforms. Each requires its corresponding Packer plugin:</p> Platform Builder Type Plugin Install VirtualBox virtualbox-iso <code>packer plugins install github.com/hashicorp/virtualbox</code> VMware vmware-iso <code>packer plugins install github.com/hashicorp/vmware</code> vSphere vsphere-iso <code>packer plugins install github.com/hashicorp/vsphere</code> Proxmox proxmox-iso <code>packer plugins install github.com/hashicorp/proxmox</code> QEMU/KVM qemu <code>packer plugins install github.com/hashicorp/qemu</code> libvirt qemu (libvirt) <code>packer plugins install github.com/thomasklein94/libvirt</code> Hyper-V hyperv-iso Built-in (no plugin needed) XenServer xenserver-iso <code>packer plugins install github.com/ddelnano/xenserver</code> Azure azure-arm <code>packer plugins install github.com/hashicorp/azure</code> GCP googlecompute <code>packer plugins install github.com/hashicorp/googlecompute</code> AWS amazon-ebs <code>packer plugins install github.com/hashicorp/amazon</code> none null Built-in <p>The Ansible provisioner plugin is required for all platforms:</p> <pre><code>packer plugins install github.com/hashicorp/ansible\n</code></pre> <p>You only need to install plugins for the platforms you intend to use.</p>"},{"location":"installation/#verification","title":"Verification","text":"<pre><code>mkosimage --version\n</code></pre>"},{"location":"architecture/build-pipeline/","title":"OSImager Build Pipeline","text":"<p>Technical reference for the complete build pipeline executed when a user runs a command such as:</p> <pre><code>mkosimage vmware/lab/rhel-9.5-x86_64 myhost 192.168.1.100\n</code></pre> <p>All line numbers reference the source as of v1.3.0.</p>"},{"location":"architecture/build-pipeline/#pipeline-overview","title":"Pipeline Overview","text":"<p>The build pipeline proceeds through these phases in order:</p> <ol> <li>CLI parsing and OSImager initialization</li> <li>Target parsing and index lookup</li> <li>Platform loading</li> <li>Location loading</li> <li>Spec loading (recursive include chain)</li> <li>Defs computation (networking, DNS, NTP, CIDR, FQDN, user overrides)</li> <li>ISO resolution</li> <li>Credential loading</li> <li>Template substitution (<code>do_sub()</code> pass)</li> <li>Installer file generation (<code>gen_files()</code>)</li> <li>Required file check</li> <li>Packer JSON assembly</li> <li>Packer execution</li> </ol>"},{"location":"architecture/build-pipeline/#step-1-cli-parsing","title":"Step 1: CLI Parsing","text":"<p>File: <code>osimager/cli.py</code> lines 15-123 Entry point: <code>main_mkosimage()</code></p> <p>The console script entry point creates an <code>OSImager</code> instance with <code>which=\"full\"</code>, which triggers full argument parsing including positional arguments (<code>target</code>, <code>name</code>, <code>ip</code>) and all build flags (<code>--force</code>, <code>--keep</code>, <code>--dry</code>, <code>--on_error</code>, <code>--define</code>, <code>--dump-defs</code>, <code>--dump-config</code>, <code>--temp</code>, <code>--local-only</code>).</p> <pre><code>osimager = OSImager(argv=argv, which=\"full\")\n</code></pre> <p>File: <code>osimager/core.py</code> lines 20-200 Method: <code>OSImager.__init__()</code> -&gt; <code>init_vars()</code> -&gt; <code>init_settings()</code></p> <p><code>init_vars()</code> (line 29) zeroes all instance state: <code>vault</code>, <code>secrets</code>, <code>platform</code>, <code>location</code>, <code>spec</code>, <code>defs</code>, <code>evars</code>, <code>variables</code>, <code>pre_provisioners</code>, <code>provisioners</code>, <code>post_provisioners</code>, <code>config</code>, <code>files</code>, <code>fqdn</code>.</p> <p><code>init_settings()</code> (line 45) performs: - Default settings initialization (line 48-61): <code>base_dir</code>, <code>user_dir</code>, <code>data_dir</code>, <code>packer_cmd</code>, <code>venv_dir</code>, <code>ansible_playbook</code>, <code>packer_cache_dir</code>, <code>local_only</code>, <code>save_index</code>, <code>credential_source</code>, <code>vault_addr</code>, <code>vault_token</code> - argparse setup with base args and full args (lines 64-106) - Positional argument extraction: <code>target</code>, <code>name</code>, <code>ip</code> (lines 120-127) - Config file loading via <code>load_settings()</code> from <code>~/.config/osimager/osimager.conf</code> (line 156) - <code>--set</code> overrides applied and persisted if changed (lines 160-189) - <code>base_path</code> set from <code>base_dir</code> setting (line 192) - User config directory <code>~/.config/osimager/locations/</code> created (line 194) - All settings seeded into <code>self.defs</code> (line 196)</p> <p>If <code>--list</code> is set, <code>main_mkosimage()</code> calls <code>get_index()</code> and prints available specs (cli.py lines 23-37), then returns.</p> <p>If no target is provided, usage information and available platforms/locations are printed (cli.py lines 39-102).</p> <p>Otherwise, the pipeline continues:</p> <pre><code>build_config = osimager.make_build(osimager.target, name=osimager.name, ip=osimager.ip or \"\")\n</code></pre>"},{"location":"architecture/build-pipeline/#step-2-parse-target","title":"Step 2: Parse Target","text":"<p>File: <code>osimager/core.py</code> lines 964-991 Method: <code>make_build(target, name, ip)</code></p> <p>The target string <code>vmware/lab/rhel-9.5-x86_64</code> is split on <code>/</code>:</p> <pre><code>tuple = target.split('/')  # ['vmware', 'lab', 'rhel-9.5-x86_64']\n</code></pre> <p>If fewer than 3 parts, raises <code>ValueError</code>.</p> <p>Extracts and stores: - <code>platform_name</code> = <code>\"vmware\"</code> -&gt; <code>self.defs['platform']</code> - <code>location_name</code> = <code>\"lab\"</code> -&gt; <code>self.defs['location']</code> - <code>spec_name</code> = <code>\"rhel-9.5-x86_64\"</code></p> <p>Index lookup (lines 980-991): Calls <code>self.get_index(spec_name)</code> which either reads the cached index from <code>~/.config/osimager/specs/index.json</code> or builds it via <code>make_index()</code> (line 814-872). The index maps spec keys like <code>rhel-9.5-x86_64</code> to their spec file path and provides metadata.</p> <p>From the index entry, extracts and stores in <code>self.defs</code>: - <code>dist</code> = <code>\"rhel\"</code> - <code>version</code> = <code>\"9.5\"</code> - <code>arch</code> = <code>\"x86_64\"</code></p> <p>Sets <code>instance_name</code> = <code>name</code> if provided, else <code>spec_name</code> (line 993). For our example: <code>\"myhost\"</code>.</p> <p>Initializes default Ansible environment variables (lines 999-1005): <pre><code>self.evars = {\n    \"ANSIBLE_RETRY_FILES_ENABLED\": \"False\",\n    \"ANSIBLE_WARNINGS\": \"False\",\n    \"ANSIBLE_NOCOWS\": \"1\",\n    \"ANSIBLE_DISPLAY_SKIPPED_HOSTS\": \"False\",\n    \"ANSIBLE_STDOUT_CALLBACK\": \"minimal\"\n}\n</code></pre></p> <p>Creates the default Ansible provisioner (lines 1010-1020) with template markers for <code>ansible_playbook</code>, <code>ansible_extra_args</code>, and <code>ansible_extra_vars</code>.</p>"},{"location":"architecture/build-pipeline/#step-3-load-platform","title":"Step 3: Load Platform","text":"<p>File: <code>osimager/core.py</code> line 1026 Method: <code>load_data_file(\"platforms\", \"vmware\")</code></p> <p>Resolves to <code>&lt;data_dir&gt;/platforms/vmware.json</code>.</p> <p>The VMware platform file includes <code>\"all\"</code>, triggering the recursive include mechanism:</p>"},{"location":"architecture/build-pipeline/#include-chain-for-vmware-platform","title":"Include Chain for VMware Platform","text":"<p><code>vmware.json</code> -&gt; <code>include: \"all\"</code> -&gt; <code>all.json</code></p> <p><code>all.json</code> provides base hardware defaults: <pre><code>{ \"defs\": { \"cpu_sockets\": 1, \"cpu_cores\": 2, \"memory\": 2048, \"boot_disk_size\": 16385 } }\n</code></pre></p> <p><code>vmware.json</code> adds VMware-specific builder config: - <code>type</code>: <code>\"vmware-iso\"</code> - <code>vm_name</code>, <code>output_directory</code>, <code>cpus</code>, <code>cores</code>, <code>memory</code>, <code>firmware</code>, <code>iso_url</code>, <code>disk_size</code>, <code>network_adapter_type</code>, etc. - All values use template markers (<code>&gt;&gt;name&lt;&lt;</code>, <code>#&gt;cpu_cores&lt;#</code>, <code>E&gt;...&lt;E</code>) for deferred substitution.</p> <p>The <code>load_data_file()</code> method (line 444) calls <code>load_file()</code> (line 421), which calls <code>read_data()</code> to parse JSON/TOML, then processes <code>include</code> keys recursively via <code>load_inc()</code> (line 404). Each level calls <code>load_data()</code> (line 315) which merges <code>files</code>, <code>evars</code>, <code>defs</code>, <code>variables</code>, <code>pre_provisioners</code>, <code>provisioners</code>, <code>post_provisioners</code>, and <code>config</code> into the OSImager instance. After merging, <code>load_specific()</code> (line 294) processes any <code>platform_specific</code>, <code>location_specific</code>, <code>dist_specific</code>, <code>version_specific</code>, <code>arch_specific</code>, and <code>firmware_specific</code> sections using <code>re.fullmatch()</code> against the current defs.</p> <p>After loading, <code>platform_type</code> is extracted from <code>self.config['type']</code> (line 1030), yielding <code>\"vmware-iso\"</code> for the VMware platform.</p>"},{"location":"architecture/build-pipeline/#step-4-load-location","title":"Step 4: Load Location","text":"<p>File: <code>osimager/core.py</code> line 1035 Method: <code>load_data_file(\"locations\", \"lab\")</code></p> <p>Locations are loaded from <code>~/.config/osimager/locations/</code>. The method checks for <code>lab.json</code> first, then <code>lab.toml</code> (line 453-461).</p> <p>A typical location file provides: - <code>platforms</code>: list of supported platform names - <code>defs</code>: network configuration (<code>cidr</code>, <code>gateway</code>, <code>domain</code>, <code>dns</code>, <code>ntp</code>, <code>iso_path</code>, <code>vms_path</code>, etc.) - <code>platform_specific</code>: per-platform overrides (e.g., vSphere datacenter/cluster, Proxmox node settings)</p> <p>After loading, <code>load_specific()</code> processes <code>platform_specific</code> entries, matching <code>vmware</code> against the current <code>platform</code> def. This is where platform-location intersection config (e.g., VMware datastore paths specific to a lab) gets merged.</p> <p>Validation at lines 1053-1058 checks: - Location supports the requested platform - Spec supports the requested platform - Spec supports the requested location</p>"},{"location":"architecture/build-pipeline/#step-5-load-spec","title":"Step 5: Load Spec","text":"<p>File: <code>osimager/core.py</code> lines 1039-1042</p> <p>The spec path comes from the index entry (line 1039). For <code>rhel-9.5-x86_64</code>, this resolves to the full filesystem path of <code>specs/rhel/spec.json</code>.</p> <pre><code>self.spec = self.load_file('specs', spec_path)\n</code></pre>"},{"location":"architecture/build-pipeline/#include-chain-for-rhel-spec","title":"Include Chain for RHEL Spec","text":"<p>The recursive include chain for RHEL is:</p> <pre><code>rhel/spec.json\n  -&gt; include: \"linux\"\n     linux/spec.json\n       -&gt; include: \"ssh\"\n          ssh/spec.json  (base \u2014 no further includes)\n</code></pre> <p>Loading order (deepest first due to recursion in <code>load_file()</code>, line 421):</p> <ol> <li> <p><code>ssh/spec.json</code> -- Sets <code>config.communicator</code> = <code>\"ssh\"</code>, <code>ssh_host</code>, <code>ssh_port</code>, <code>ssh_username</code>, <code>ssh_password</code>, <code>ssh_timeout</code>. The <code>ssh_host</code> value uses a Python eval expression (<code>E&gt;...&lt;E</code>) that dynamically selects the SSH target based on <code>platform_type</code> and whether an IP was provided.</p> </li> <li> <p><code>linux/spec.json</code> -- Sets <code>defs.boot_disk_size</code> = 16384, <code>variables.ssh-username</code> and <code>variables.ssh-password</code> as Packer vault references (<code>{{vault \\</code>images/linux` `username`}}`).</p> </li> <li> <p><code>rhel/spec.json</code> -- The main RHEL spec. Loaded last so its values take precedence. Provides:</p> </li> <li><code>provides</code> section (dist, versions, arches) -- used only for indexing</li> <li><code>platforms</code> list restricting supported platforms</li> <li><code>files</code> array defining kickstart generation: concatenation of <code>rhel/kickstart_&gt;&gt;major&lt;&lt;.cfg</code>, <code>rhel/ks-part.sh</code>, <code>rhel/kickstart_end.cfg</code>, <code>rhel/kickstart_post.cfg</code>, <code>rhel/install_vmwtools.sh</code>, <code>rhel/kickstart_end.cfg</code> -&gt; output as <code>ks.cfg</code></li> <li><code>defs</code>: <code>cd_files</code>, <code>cd_label</code> = <code>\"OEMDRV\"</code>, <code>ansible_extra_args</code></li> <li><code>config</code>: <code>boot_wait</code>, <code>shutdown_command</code></li> <li><code>version_specific</code> array with regex-matched overrides</li> </ol> <p>Version-specific processing (via <code>load_specific()</code> at line 378): For version <code>9.5</code>, the <code>\"9.*\"</code> version_specific entry matches via <code>re.fullmatch(\"9.*\", \"9.5\")</code>. This sets: - <code>defs.cpu_cores</code> = 4, <code>defs.memory</code> = 4096 - <code>defs.spec_config</code> = <code>\"specs/rhel/config_9.yml\"</code> - <code>defs.ansible_extra_vars</code> with python3 interpreter - <code>defs.iso_url</code> with archive.org template - Cloud provider image references (Azure, GCP, AWS) - <code>config.firmware</code> = <code>\"efi\"</code> - <code>config.boot_command</code> for EFI kickstart boot</p> <p>Platform-specific within version-specific: The <code>9.*</code> entry also has <code>platform_specific</code> entries. The <code>vmware</code> match sets <code>defs.cpu_sockets</code> = 2, <code>config.guest_os_type</code> = <code>\"rhel9-64\"</code>, and merges <code>vmx_data</code> with <code>scsi0.virtualdev</code> = <code>\"pvscsi\"</code>.</p> <p>After spec loading, venv activation is checked (lines 1047-1051) -- if the spec declares a <code>venv</code>, the PATH environment variable is modified to prioritize the venv bin directory.</p>"},{"location":"architecture/build-pipeline/#step-6-build-defs","title":"Step 6: Build Defs","text":"<p>File: <code>osimager/core.py</code> lines 1062-1178</p>"},{"location":"architecture/build-pipeline/#spec-name-decomposition-lines-1062-1076","title":"Spec Name Decomposition (lines 1062-1076)","text":"<p>The spec name <code>rhel-9.5-x86_64</code> is split on <code>-</code>: - <code>dist</code> = <code>\"rhel\"</code> - <code>version</code> = <code>\"9.5\"</code> -&gt; <code>major</code> = <code>\"9\"</code>, <code>minor</code> = <code>\"5\"</code> - <code>arch</code> = <code>\"x86_64\"</code></p>"},{"location":"architecture/build-pipeline/#bootshutdown-conditional-removal-lines-1078-1082","title":"Boot/Shutdown Conditional Removal (lines 1078-1082)","text":"<p>If <code>defs.boot</code> is falsy, <code>boot_command</code> and <code>boot_wait</code> are removed from config. If <code>defs.shutcmd</code> is falsy, <code>shutdown_command</code> is removed from config.</p>"},{"location":"architecture/build-pipeline/#temp-directory-lines-1084-1089","title":"Temp Directory (lines 1084-1089)","text":"<p>If <code>--temp</code> was specified, uses that directory. Otherwise creates a new <code>tempfile.mkdtemp()</code>.</p>"},{"location":"architecture/build-pipeline/#core-defs-update-lines-1094-1106","title":"Core Defs Update (lines 1094-1106)","text":"<pre><code>self.defs.update({\n    \"base_path\": ..., \"data_path\": ..., \"user_dir\": ...,\n    \"temp_dir\": ..., \"tmpdir\": ..., \"spec_dir\": ...,\n    \"dist\": ..., \"version\": ..., \"major\": ..., \"minor\": ..., \"arch\": ...\n})\n</code></pre>"},{"location":"architecture/build-pipeline/#path-normalization-lines-1108-1112","title":"Path Normalization (lines 1108-1112)","text":"<p>Strips trailing slashes from <code>iso_path</code> and <code>vms_path</code> defs so templates can append their own separators.</p>"},{"location":"architecture/build-pipeline/#packer-variables-lines-1114-1119","title":"Packer Variables (lines 1114-1119)","text":"<p>Sets <code>platform-name</code>, <code>location-name</code>, <code>spec-name</code>, <code>spec-config</code> in <code>self.variables</code> (these become Packer <code>{{user \\</code>...`}}` variables).</p>"},{"location":"architecture/build-pipeline/#dns-expansion-lines-1121-1124","title":"DNS Expansion (lines 1121-1124)","text":"<p>Extracts <code>dns</code> dict from defs. Expands: - <code>dns.search</code> list -&gt; <code>dns_search</code> (space-joined string) - <code>dns.servers</code> list -&gt; <code>dns1</code>, <code>dns2</code>, <code>dns3</code>, ... (numbered individual entries)</p>"},{"location":"architecture/build-pipeline/#ntp-expansion-lines-1126-1128","title":"NTP Expansion (lines 1126-1128)","text":"<p>Extracts <code>ntp</code> dict. Expands <code>ntp.servers</code> list -&gt; <code>ntp1</code>, <code>ntp2</code>, ...</p>"},{"location":"architecture/build-pipeline/#instance-name-and-fqdn-lines-1130-1142","title":"Instance Name and FQDN (lines 1130-1142)","text":"<ul> <li><code>defs.name</code> = instance_name (<code>\"myhost\"</code>)</li> <li>FQDN computation priority:</li> <li><code>--fqdn</code> flag if specified</li> <li>If <code>name</code> contains a dot, use it as FQDN directly</li> <li>Otherwise: <code>instance_name + \".\" + defs['domain']</code></li> <li>Sets both <code>defs.fqdn</code> and <code>variables.fqdn</code></li> </ul>"},{"location":"architecture/build-pipeline/#cidr-splitting-lines-1144-1159","title":"CIDR Splitting (lines 1144-1159)","text":"<p>Splits <code>defs.cidr</code> (e.g., <code>\"192.168.1.0/24\"</code>) into: - <code>subnet</code> = <code>\"192.168.1.0\"</code> - <code>prefix</code> = <code>\"24\"</code> - <code>gateway</code> = computed from last usable address if not explicitly set (<code>ipaddress.IPv4Network</code>) - <code>gw</code> = alias for <code>gateway</code> - <code>netmask</code> = converted from prefix via <code>prefix_to_netmask()</code> (e.g., <code>\"255.255.255.0\"</code>)</p>"},{"location":"architecture/build-pipeline/#ip-resolution-lines-1161-1165","title":"IP Resolution (lines 1161-1165)","text":"<p>If no IP was provided on the command line, attempts DNS resolution via <code>get_ip(fqdn, location_dns_config)</code> using the location's DNS servers and search domains. Falls back to empty string.</p> <p>For our example, IP = <code>\"192.168.1.100\"</code> (provided directly).</p>"},{"location":"architecture/build-pipeline/#user-define-overrides-lines-1167-1178","title":"User --define Overrides (lines 1167-1178)","text":"<p>If <code>--define</code> was used (e.g., <code>-D memory=8192,firmware=bios</code>), splits on commas, then on <code>=</code>, and overwrites <code>self.defs</code> entries. This allows command-line override of any def value.</p>"},{"location":"architecture/build-pipeline/#step-7-resolve-isos","title":"Step 7: Resolve ISOs","text":"<p>File: <code>osimager/core.py</code> lines 1183-1201</p> <p>Checks <code>defs.urls</code> (array of <code>{url, checksum}</code> dicts). Runs <code>do_sub()</code> on the URLs first to resolve any template markers.</p> <p>Two modes based on <code>local_only</code> setting:</p> <ul> <li> <p>Local mode (<code>get_iso_file()</code>, line 892-921): Takes the first URL entry, extracts <code>iso_name</code> and <code>iso_path</code> for local filesystem access. Sets <code>defs.iso_file</code>, <code>defs.iso_name</code>, <code>defs.iso_checksum</code> = <code>\"none\"</code>. Removes <code>iso_urls</code> from config.</p> </li> <li> <p>Remote mode (<code>check_iso_urls()</code>, line 923-962): Iterates URL entries, performs HTTP HEAD checks (<code>check_url()</code>), downloads checksum files (<code>get_checksum()</code>), and sets <code>defs.iso_url</code>, <code>defs.iso_name</code>, <code>defs.iso_checksum</code>.</p> </li> </ul> <p>If <code>iso_url</code> is defined but <code>iso_name</code> is not, derives <code>iso_name</code> from the URL via <code>get_filename_from_url()</code> (lines 1193-1201).</p>"},{"location":"architecture/build-pipeline/#step-8-load-credentials","title":"Step 8: Load Credentials","text":"<p>File: <code>osimager/core.py</code> lines 547-583, called at line 1204 Method: <code>load_credentials()</code></p> <p>Dispatches based on <code>credential_source</code> setting:</p>"},{"location":"architecture/build-pipeline/#vault-mode-credential_source-vault","title":"Vault Mode (<code>credential_source</code> = <code>\"vault\"</code>)","text":"<p>Lines 556-583. Reads <code>vault_addr</code> and <code>vault_token</code> from settings. Creates <code>hvac.Client</code> (line 571). Verifies authentication via <code>vault.is_authenticated()</code>. If successful, stores <code>vault_addr</code> and <code>vault_token</code> in defs for later use as environment variables.</p>"},{"location":"architecture/build-pipeline/#config-mode-credential_source-config","title":"Config Mode (<code>credential_source</code> = <code>\"config\"</code>)","text":"<p>Calls <code>load_secrets()</code> (lines 507-545). Parses <code>~/.config/osimager/secrets</code> file. Format: <pre><code>path key1=value1 key2=value2\n</code></pre> Example: <pre><code>images/linux username=root password=T3mp@dm1n!\nvsphere/lab server=vcenter.local username=admin password=P@ss\n</code></pre></p> <p>Populates <code>self.secrets</code> dict keyed by path.</p>"},{"location":"architecture/build-pipeline/#credential-error-handling-lines-1203-1215","title":"Credential Error Handling (lines 1203-1215)","text":"<p>If credential loading fails, checks whether the configuration actually references secrets (vault template functions <code>{{vault ...}}</code>, or substitution markers <code>|&gt;</code>, <code>6&gt;</code>, <code>5&gt;</code>). Only aborts if secrets are actually needed.</p>"},{"location":"architecture/build-pipeline/#step-9-template-substitution","title":"Step 9: Template Substitution","text":"<p>File: <code>osimager/core.py</code> lines 1222-1237 File: <code>osimager/utils.py</code> lines 301-846</p> <p>The <code>do_sub()</code> function is the core template engine. It recursively walks all data structures (dicts, lists, tuples, sets, strings) and delegates string processing to <code>do_substr()</code>.</p>"},{"location":"architecture/build-pipeline/#substitution-pass-order-line-1222-1237","title":"Substitution Pass Order (line 1222-1237)","text":"<pre><code>self.defs = do_sub(self.defs, self)           # Resolve defs against themselves\nself.evars = do_sub(self.evars, self)         # Resolve environment variables\nself.variables = do_sub(self.variables, self)  # Resolve Packer variables\n# Provisioner assembly:\nprovisioners = []\nprovisioners.extend(do_sub(self.pre_provisioners, self))\nprovisioners.extend(do_sub(self.provisioners, self))\nprovisioners.extend(do_sub(self.post_provisioners, self))\nself.spec['files'] = do_sub(self.spec.get(\"files\", []), self)\nself.config = do_sub(self.config, self)\n</code></pre>"},{"location":"architecture/build-pipeline/#template-marker-types","title":"Template Marker Types","text":"<p>Defined in <code>ACTIONS</code> (utils.py lines 698-711):</p> Action Markers Purpose Example 1 <code>%&gt;..&lt;%</code> Replace complete value (including quotes) with defs variable <code>%&gt;cd_files&lt;%</code> 2 <code>&gt;&gt;..&lt;&lt;</code> Replace marker inline with defs variable <code>&gt;&gt;version&lt;&lt;</code> -&gt; <code>9.5</code> 3 <code>+&gt;..&lt;+</code> Replace with basename of defs variable <code>+&gt;iso_path&lt;+</code> 4 <code>*&gt;..&lt;*</code> Replace with IP address (DNS lookup) <code>*&gt;hostname&lt;*</code> 5 <code>\\|&gt;..&lt;\\|</code> Replace with HashiCorp Vault / secrets value <code>\\|&gt;images/linux:password&lt;\\|</code> 6 <code>#&gt;..&lt;#</code> Numeric eval (arithmetic on def values) <code>#&gt;cpu_sockets*cpu_cores&lt;#</code> 7 <code>$&gt;..&lt;$</code> Replace with environment variable <code>$&gt;HOME&lt;$</code> 8 <code>1&gt;..&lt;1</code> MD5 password hash of secret <code>1&gt;images/linux:password&lt;1</code> 9 <code>5&gt;..&lt;5</code> SHA-256 password hash of secret <code>5&gt;images/linux:password&lt;5</code> 10 <code>6&gt;..&lt;6</code> SHA-512 password hash of secret <code>6&gt;images/linux:password&lt;6</code> 11 <code>E&gt;..&lt;E</code> Python eval expression <code>E&gt;'efi' if ... else 'bios'&lt;E</code> 12 <code>[&gt;..&lt;]</code> Insert list items (expand list into parent) <code>[&gt;ansible_extra_args&lt;]</code>"},{"location":"architecture/build-pipeline/#processing-flow-do_substr-utilspy-lines-796-846","title":"Processing Flow (<code>do_substr()</code>, utils.py lines 796-846)","text":"<p>For each string, iterates through all 12 action types. For each action, <code>extract_all()</code> finds all tokens matching the start/end markers. The corresponding <code>ACTION_HANDLER</code> (lines 683-696) is invoked to produce the replacement value. If the entire string is a single marker, the replacement can be a non-string type (dict, list, int); otherwise string substitution is performed.</p>"},{"location":"architecture/build-pipeline/#step-10-generate-installer-files","title":"Step 10: Generate Installer Files","text":"<p>File: <code>osimager/core.py</code> lines 1300-1334 Method: <code>gen_files()</code></p> <p>Called from <code>run_packer()</code> (line 1350). Processes <code>self.files</code> (populated from the spec's <code>files</code> array during loading).</p> <p>For RHEL 9.5, the files array specifies kickstart generation: <pre><code>{\n    \"sources\": [\n        \"rhel/kickstart_9.cfg\",\n        \"rhel/ks-part.sh\",\n        \"rhel/kickstart_end.cfg\",\n        \"rhel/kickstart_post.cfg\",\n        \"rhel/install_vmwtools.sh\",\n        \"rhel/kickstart_end.cfg\"\n    ],\n    \"dest\": \"ks.cfg\"\n}\n</code></pre></p> <p>For each file entry: 1. Iterates <code>sources</code> array 2. Each source path is resolved relative to <code>&lt;data_dir&gt;/files/</code> 3. Source file contents are read and concatenated into a single <code>data</code> string 4. <code>do_substr(data, self)</code> performs template substitution on the concatenated content 5. Result is written to <code>&lt;temp_dir&gt;/&lt;dest&gt;</code> (e.g., <code>/tmp/tmpXXXXXX/ks.cfg</code>)</p> <p>The generated kickstart file contains the fully resolved network config, partition layout, package lists, and post-install scripts with all <code>&gt;&gt;variable&lt;&lt;</code> markers replaced by actual values.</p>"},{"location":"architecture/build-pipeline/#step-11-check-required-files","title":"Step 11: Check Required Files","text":"<p>File: <code>osimager/core.py</code> lines 1268-1298 Method: <code>check_required_files()</code></p> <p>Called from <code>run_packer()</code> at line 1347. Reads the <code>required_files</code> array from the spec (if present). Each entry has: - <code>file</code>: relative path under <code>&lt;data_dir&gt;/files/</code> - <code>description</code>: human-readable description - <code>url</code>: download URL - <code>location</code>: where to place the file</p> <p>Performs <code>do_sub()</code> on each entry, checks <code>os.path.exists()</code>. If any file is missing, prints download instructions and calls <code>sys.exit(1)</code>.</p> <p>Most RHEL builds do not have <code>required_files</code>. ESXi specs use this for VIB files that must be manually downloaded.</p>"},{"location":"architecture/build-pipeline/#step-12-assemble-packer-json","title":"Step 12: Assemble Packer JSON","text":"<p>File: <code>osimager/core.py</code> lines 1248-1264</p> <p>The final Packer build structure is assembled:</p> <pre><code>self.build = {\n    \"variables\": self.variables,\n    \"provisioners\": provisioners,\n    \"builders\": [ self.config ]\n}\n</code></pre>"},{"location":"architecture/build-pipeline/#variables","title":"Variables","text":"<p>Contains Packer user variables referenced by <code>{{user \\</code>...`}}<code>in builders/provisioners: -</code>platform-name<code>,</code>location-name<code>,</code>spec-name<code>,</code>spec-config<code>-</code>ssh-username<code>,</code>ssh-password<code>(vault references or resolved values) -</code>name<code>,</code>fqdn`</p>"},{"location":"architecture/build-pipeline/#provisioners","title":"Provisioners","text":"<p>Ordered list: <code>pre_provisioners</code> + <code>provisioners</code> + <code>post_provisioners</code>. The default provisioner is an Ansible provisioner running the playbook specified by <code>ansible_playbook</code> with extra vars for platform, location, spec, and install directory.</p>"},{"location":"architecture/build-pipeline/#builders","title":"Builders","text":"<p>Single-element array containing <code>self.config</code> -- the fully resolved builder configuration. For VMware, this is a <code>vmware-iso</code> builder with all VM parameters, ISO paths, boot commands, and VMX data.</p>"},{"location":"architecture/build-pipeline/#vault-reference-resolution-lines-1254-1256","title":"Vault Reference Resolution (lines 1254-1256)","text":"<p>If using config-based secrets (<code>self.secrets</code> is populated), <code>resolve_packer_vault_refs()</code> (lines 612-634) walks the entire build structure and replaces Packer <code>{{vault \\</code>path` `key`}}` references with actual values from the secrets dict. This allows the same spec files to work with both Vault and local secrets.</p>"},{"location":"architecture/build-pipeline/#dump-and-exit-points-lines-1258-1264","title":"Dump and Exit Points (lines 1258-1264)","text":"<ul> <li><code>--dump-defs</code> (<code>-x</code>): prints <code>self.defs</code> as JSON and exits</li> <li><code>--dump-config</code> (<code>-u</code>): prints <code>self.build</code> as JSON and exits</li> </ul> <p>These are diagnostic tools for inspecting the resolved state without running Packer.</p>"},{"location":"architecture/build-pipeline/#step-13-execute-packer","title":"Step 13: Execute Packer","text":"<p>File: <code>osimager/core.py</code> lines 1336-1416 Method: <code>run_packer()</code></p> <p>Called from <code>main_mkosimage()</code> at cli.py line 113.</p>"},{"location":"architecture/build-pipeline/#directory-change-lines-1338-1344","title":"Directory Change (lines 1338-1344)","text":"<p>Changes working directory to <code>data_path</code> so that relative paths in config files (e.g., <code>config.yml</code>, Ansible roles) resolve correctly.</p>"},{"location":"architecture/build-pipeline/#file-generation-and-validation-lines-1347-1350","title":"File Generation and Validation (lines 1347-1350)","text":"<p>Calls <code>check_required_files()</code> then <code>gen_files()</code> (described in steps 10-11 above).</p>"},{"location":"architecture/build-pipeline/#write-packer-json-lines-1352-1356","title":"Write Packer JSON (lines 1352-1356)","text":"<p>Writes the assembled build structure to <code>&lt;temp_dir&gt;/&lt;instance_name&gt;.json</code>: <pre><code>output_file = os.path.join(self.defs.get(\"tmpdir\", \"/tmp\"), self.defs.get(\"name\", \"build\") + \".json\")\njson.dump(self.build, fp, indent=4)\n</code></pre></p> <p>For our example: <code>/tmp/tmpXXXXXX/myhost.json</code></p>"},{"location":"architecture/build-pipeline/#set-environment-variables-lines-1358-1372","title":"Set Environment Variables (lines 1358-1372)","text":"<p>All entries in <code>self.evars</code> are exported: - Ansible control variables (<code>ANSIBLE_RETRY_FILES_ENABLED</code>, <code>ANSIBLE_WARNINGS</code>, etc.) - <code>RES_OPTIONS</code> for DNS resolution during build - <code>PATH</code> (if venv is active)</p> <p>If Vault is configured: - <code>VAULT_TOKEN</code> and <code>VAULT_ADDR</code> are exported (lines 1365-1368)</p> <p>If logging is enabled: - <code>PACKER_LOG</code> = <code>\"1\"</code> (line 1370) - <code>PACKER_LOG_PATH</code> = logfile path (line 1372)</p>"},{"location":"architecture/build-pipeline/#build-command-assembly-lines-1374-1404","title":"Build Command Assembly (lines 1374-1404)","text":"<pre><code>cmd = []\n</code></pre> <p>If a venv is specified in the spec, prepends the activation command: <pre><code>. ~/.venv/&lt;venv_name&gt;/bin/activate &amp;&amp;\n</code></pre></p> <p>Then appends the Packer command: <pre><code>packer build [-timestamp-ui] [-on-error=&lt;mode&gt;] [-force] [-debug] &lt;output_file&gt;\n</code></pre></p> <p>Flag mapping: - <code>--timestamp</code> -&gt; <code>-timestamp-ui</code> - <code>--on_error &lt;mode&gt;</code> -&gt; <code>-on-error=&lt;mode&gt;</code> - <code>--keep</code> -&gt; <code>-on-error=abort</code> - <code>--force</code> -&gt; <code>-force</code> - <code>--debug</code> -&gt; <code>-debug</code></p>"},{"location":"architecture/build-pipeline/#execution-lines-1406-1412","title":"Execution (lines 1406-1412)","text":"<p>If not <code>--dry_run</code>, ensures CWD is <code>data_path</code> and calls: <pre><code>os.system(cmd_str)\n</code></pre></p> <p>Uses <code>os.system()</code> for direct shell execution, allowing Packer's interactive output (progress bars, prompts) to pass through to the terminal.</p>"},{"location":"architecture/build-pipeline/#cleanup-lines-1414-1415","title":"Cleanup (lines 1414-1415)","text":"<p>If <code>--temp</code> was not specified and <code>--keep</code> was not set, removes the temp directory: <pre><code>shutil.rmtree(self.temp_dir)\n</code></pre></p>"},{"location":"architecture/build-pipeline/#rfosimage-flow","title":"rfosimage Flow","text":"<p>File: <code>osimager/cli.py</code> lines 126-185 Entry point: <code>main_rfosimage()</code></p> <p>The <code>rfosimage</code> (refit OS image) command shares the entire pipeline through step 12, then modifies the builder before execution.</p>"},{"location":"architecture/build-pipeline/#shared-pipeline","title":"Shared Pipeline","text":"<pre><code>img = OSImager(argv, \"full\", extra_args)\nbuild = img.make_build(plan, name, ip)\n</code></pre> <p>All steps 1-12 execute identically.</p>"},{"location":"architecture/build-pipeline/#builder-replacement-lines-153-173","title":"Builder Replacement (lines 153-173)","text":"<p>After <code>make_build()</code> returns, <code>rfosimage</code> replaces the platform-specific builder with a <code>null</code> builder. This skips VM creation/ISO boot and instead connects directly to an existing machine via its communicator (SSH/WinRM).</p> <pre><code>config = builders[0]\ncomm = config.get('communicator', None)  # e.g., \"ssh\"\n\nnew_config = {\n    \"name\": defs.get(\"spec_name\", \"name\"),\n    \"type\": \"null\"\n}\n# Copy only communicator-related keys (ssh_host, ssh_port, ssh_username, etc.)\nfor key in config:\n    if key.startswith(comm):  # keys starting with \"ssh\" for SSH communicator\n        new_config[key] = config[key]\n</code></pre> <p>This preserves <code>ssh_host</code>, <code>ssh_port</code>, <code>ssh_username</code>, <code>ssh_password</code>, <code>ssh_timeout</code>, etc., while discarding all builder-specific config (ISO, boot commands, VM hardware, disk settings).</p> <p>The spec's <code>files</code> section is also removed (line 153-154) since installer files are not needed for refitting.</p>"},{"location":"architecture/build-pipeline/#execution","title":"Execution","text":"<p>Calls <code>img.run_packer()</code> which writes the null-builder JSON and executes Packer. Packer connects to the existing host and runs only the provisioners (Ansible playbook, shell scripts).</p>"},{"location":"architecture/build-pipeline/#data-flow-diagram","title":"Data Flow Diagram","text":"<pre><code>CLI args\n  |\n  v\nOSImager.__init__()\n  |-- init_vars()        -&gt; zero state\n  |-- init_settings()    -&gt; parse args, load settings, seed defs\n  |\n  v\nmake_build(target, name, ip)\n  |\n  |-- split target       -&gt; platform_name, location_name, spec_name\n  |-- get_index()        -&gt; dist, version, arch\n  |\n  |-- load_data_file(\"platforms\", ...)\n  |     |-- all.json     -&gt; base defs (cpu, memory, disk)\n  |     |-- vmware.json  -&gt; builder config (vmware-iso type)\n  |\n  |-- load_data_file(\"locations\", ...)\n  |     |-- lab.json     -&gt; network defs (cidr, dns, ntp, domain)\n  |     |-- platform_specific for vmware\n  |\n  |-- load_file(\"specs\", ...)\n  |     |-- ssh/spec.json   -&gt; communicator config\n  |     |-- linux/spec.json -&gt; boot_disk_size, vault variables\n  |     |-- rhel/spec.json  -&gt; files, boot_command, version_specific\n  |           |-- version_specific \"9.*\" match\n  |           |-- platform_specific \"vmware\" match\n  |\n  |-- compute defs       -&gt; major, minor, DNS, NTP, CIDR, FQDN, IP\n  |-- user --define      -&gt; override defs\n  |-- resolve ISOs       -&gt; iso_url, iso_name, iso_checksum\n  |-- load_credentials() -&gt; vault client or local secrets\n  |\n  |-- do_sub() pass      -&gt; resolve all template markers\n  |-- assemble build     -&gt; { variables, provisioners, builders }\n  |-- resolve_packer_vault_refs() if config mode\n  |\n  v\nrun_packer()\n  |-- chdir(data_path)\n  |-- check_required_files()\n  |-- gen_files()        -&gt; write ks.cfg to temp_dir\n  |-- write JSON         -&gt; temp_dir/myhost.json\n  |-- set env vars       -&gt; ANSIBLE_*, VAULT_*, PATH\n  |-- os.system(\"packer build ... myhost.json\")\n  |-- cleanup temp_dir\n</code></pre>"},{"location":"architecture/build-pipeline/#key-source-file-reference","title":"Key Source File Reference","text":"File Lines Purpose <code>osimager/cli.py</code> 15-123 <code>main_mkosimage()</code> entry point <code>osimager/cli.py</code> 126-185 <code>main_rfosimage()</code> entry point <code>osimager/core.py</code> 20-200 <code>__init__()</code>, <code>init_vars()</code>, <code>init_settings()</code> <code>osimager/core.py</code> 294-378 <code>load_specific()</code>, <code>load_data()</code> -- config merging <code>osimager/core.py</code> 404-469 <code>load_inc()</code>, <code>load_file()</code>, <code>load_data_file()</code> -- recursive include loading <code>osimager/core.py</code> 507-545 <code>load_secrets()</code> -- parse local secrets file <code>osimager/core.py</code> 547-583 <code>load_credentials()</code> -- vault or config dispatch <code>osimager/core.py</code> 585-610 <code>get_secret()</code> -- unified secret access <code>osimager/core.py</code> 612-634 <code>resolve_packer_vault_refs()</code> -- replace <code>{{vault ...}}</code> in build JSON <code>osimager/core.py</code> 814-872 <code>make_index()</code> -- build spec index from all spec files <code>osimager/core.py</code> 892-962 <code>get_iso_file()</code>, <code>check_iso_urls()</code> -- ISO resolution <code>osimager/core.py</code> 964-1266 <code>make_build()</code> -- main build orchestration <code>osimager/core.py</code> 1268-1298 <code>check_required_files()</code> <code>osimager/core.py</code> 1300-1334 <code>gen_files()</code> -- installer file generation <code>osimager/core.py</code> 1336-1416 <code>run_packer()</code> -- write JSON, set env, execute <code>osimager/utils.py</code> 78-113 <code>explode_string_with_dynamic_range()</code> -- version range expansion <code>osimager/utils.py</code> 219-227 <code>prefix_to_netmask()</code> -- CIDR prefix to dotted netmask <code>osimager/utils.py</code> 229-250 <code>get_ip()</code> -- DNS resolution with custom servers <code>osimager/utils.py</code> 301-334 <code>do_sub()</code> -- recursive template substitution <code>osimager/utils.py</code> 543-582 <code>hash_password()</code> -- crypt-compatible password hashing <code>osimager/utils.py</code> 683-711 <code>ACTION_HANDLERS</code>, <code>ACTIONS</code> -- substitution marker definitions <code>osimager/utils.py</code> 796-846 <code>do_substr()</code> -- per-string template processing <code>osimager/constants.py</code> 10 <code>OSIMAGER_VERSION</code> -- single source of truth for version"},{"location":"architecture/configuration-merging/","title":"Configuration Merging","text":"<p>OSImager uses a hierarchical configuration merge system to assemble the final Packer build JSON from multiple layers of configuration files. Each layer can add, override, or selectively deep-merge values from previous layers. This document describes the complete merge pipeline and the mechanics of each stage.</p>"},{"location":"architecture/configuration-merging/#merge-chain","title":"Merge Chain","text":"<p>Configuration is loaded in this fixed order. Later layers override earlier ones:</p> Order Source Description Example 1 <code>all.json</code> Base defaults shared by all platforms <code>cpu_sockets:1</code>, <code>cpu_cores:2</code>, <code>memory:2048</code>, <code>boot_disk_size:16385</code> 2 Platform JSON Builder type, boot commands, VM hardware, platform-specific defaults <code>vsphere.json</code> sets <code>type: \"vsphere-iso\"</code>, network adapters, disk layout 3 Location JSON/TOML Network settings, DNS, NTP, paths, per-platform overrides <code>lab.toml</code> sets <code>domain</code>, <code>cidr</code>, <code>gateway</code>, <code>iso_path</code>, <code>vms_path</code> 4 Spec JSON OS installer config, kickstart files, include chain <code>alma/spec.json</code> sets ISO URLs, <code>cd_files</code>, <code>boot_command</code> 5 Specific sections 6 types of conditional overrides applied recursively <code>version_specific</code>, <code>platform_specific</code>, <code>arch_specific</code>, etc. 6 CLI <code>--define</code> User overrides from the command line <code>-D key=value,key2=value2</code> <p>The chain is initiated by <code>make_build()</code> in <code>core.py</code> (line 964). It calls <code>load_data_file()</code> for each of the first four layers (platform at line 1026, location at line 1035, spec at line 1041), and layer 6 is applied at line 1169.</p>"},{"location":"architecture/configuration-merging/#layer-1-alljson","title":"Layer 1: all.json","text":"<p>The file <code>platforms/all.json</code> is loaded via the platform JSON's <code>\"include\": \"all\"</code> directive. It establishes the absolute baseline defaults:</p> <pre><code>{\n  \"defs\": {\n    \"cpu_sockets\": 1,\n    \"cpu_cores\": 2,\n    \"memory\": 2048,\n    \"boot_disk_size\": 16385\n  }\n}\n</code></pre> <p>Every platform JSON includes <code>all.json</code> through the include mechanism, so these values are always present unless explicitly overridden.</p>"},{"location":"architecture/configuration-merging/#layer-2-platform-json","title":"Layer 2: Platform JSON","text":"<p>Platform files reside in <code>{data_dir}/platforms/{name}.json</code>. The platform file declares its <code>include</code> (typically <code>\"all\"</code>), then overlays platform-specific builder configuration. For example, <code>vsphere.json</code> defines the <code>config</code> section with <code>type: \"vsphere-iso\"</code>, network adapters, storage layout, and Packer builder fields.</p>"},{"location":"architecture/configuration-merging/#layer-3-location-jsontoml","title":"Layer 3: Location JSON/TOML","text":"<p>Location files reside in <code>{user_dir}/locations/</code> (i.e., <code>~/.config/osimager/locations/</code>). They can be JSON or TOML format. When both exist for the same name, JSON takes priority (see <code>load_data_file()</code> at line 453-461 in <code>core.py</code>).</p> <p>Locations define the environment-specific settings: domain, CIDR, gateway, DNS servers, NTP servers, datastore paths, ISO paths, and VM output paths. They can also contain <code>platform_specific</code> sections that override platform-level settings for a particular site.</p>"},{"location":"architecture/configuration-merging/#layer-4-spec-json","title":"Layer 4: Spec JSON","text":"<p>Spec files reside in <code>{data_dir}/specs/{name}/spec.json</code>. Specs define the OS distribution configuration: <code>provides</code> (dist, versions, arches), installer files, boot commands, provisioners, and the include chain to parent specs.</p> <p>A typical include chain: <code>alma</code> -&gt; <code>rhel</code> -&gt; <code>linux</code> -&gt; <code>ssh</code> -&gt; (no further includes).</p>"},{"location":"architecture/configuration-merging/#layer-5-specific-sections","title":"Layer 5: Specific Sections","text":"<p>After each data file is loaded via <code>load_data()</code>, the method calls <code>load_specific()</code> which processes six types of conditional overrides in fixed order. These are described in detail below.</p>"},{"location":"architecture/configuration-merging/#layer-6-cli-define","title":"Layer 6: CLI --define","text":"<p>User-supplied <code>--define key=value,key2=value2</code> pairs are parsed and injected directly into <code>self.defs</code> at line 1169-1178 of <code>core.py</code>. These override any previously set definition values.</p>"},{"location":"architecture/configuration-merging/#how-load_data-works","title":"How load_data() Works","text":"<p>Location: <code>core.py</code>, lines 315-378.</p> <p><code>load_data()</code> is the central merge function. Every configuration file passes through it. It operates on 8 sections, each mapped to an instance attribute on the <code>OSImager</code> object:</p> Section Type Instance Attribute <code>files</code> list <code>self.files</code> <code>evars</code> dict <code>self.evars</code> <code>defs</code> dict <code>self.defs</code> <code>variables</code> dict <code>self.variables</code> <code>pre_provisioners</code> list <code>self.pre_provisioners</code> <code>provisioners</code> list <code>self.provisioners</code> <code>post_provisioners</code> list <code>self.post_provisioners</code> <code>config</code> dict <code>self.config</code>"},{"location":"architecture/configuration-merging/#merge-logic","title":"Merge Logic","text":"<p>For each section present in the incoming data:</p> <ol> <li> <p>Dict sections (<code>evars</code>, <code>defs</code>, <code>variables</code>, <code>config</code>): The existing dict is updated with <code>attr.update(new_val)</code>. This is a shallow merge -- keys in the new data overwrite keys in the existing data at the top level.</p> </li> <li> <p>List sections (<code>files</code>, <code>pre_provisioners</code>, <code>provisioners</code>, <code>post_provisioners</code>): Behavior depends on the <code>method</code> key:</p> </li> <li><code>method=\"merge\"</code> (default): New items are appended via <code>attr.extend(new_val)</code>.</li> <li> <p><code>method=\"replace\"</code>: The existing list is cleared first (<code>attr[:] = []</code>), then the new items are added.</p> </li> <li> <p>Other types: Assigned directly via <code>setattr()</code>.</p> </li> </ol> <p>The <code>method</code> key is popped from the data dict at line 331 before section processing begins. It defaults to <code>\"merge\"</code> if not present.</p>"},{"location":"architecture/configuration-merging/#processing-order","title":"Processing Order","text":"<pre><code>load_data(data):\n    method = data.pop('method', \"merge\")\n    for section in [files, evars, defs, variables, pre_provisioners, provisioners, post_provisioners, config]:\n        new_val = data.get(section)\n        if new_val is None: continue\n        attr = getattr(self, section)\n        # process merge key (if dict)\n        # apply dict update or list extend/replace\n    load_specific(data)\n</code></pre> <p>After all 8 sections are processed, <code>load_data()</code> calls <code>load_specific(data)</code> to handle any conditional sections remaining in the data.</p>"},{"location":"architecture/configuration-merging/#the-merge-key-deep-merge","title":"The <code>merge</code> Key (Deep Merge)","text":"<p>Location: <code>core.py</code>, lines 342-354.</p> <p>Within dict sections, a special <code>merge</code> key enables selective deep merging of nested structures instead of wholesale overwriting. This is critical for cases like VMware's <code>vmx_data</code> where multiple layers need to contribute key-value pairs to the same nested dict.</p>"},{"location":"architecture/configuration-merging/#mechanics","title":"Mechanics","text":"<p>When <code>new_val</code> is a dict, <code>load_data()</code> checks for a <code>merge</code> key:</p> <pre><code>merge = new_val.pop(\"merge\", [])\nfor key in merge:\n    key_val = new_val.pop(key, None)\n    if key_val:\n        if key in attr:\n            if isinstance(attr[key], dict):\n                attr[key].update(key_val)\n            elif isinstance(attr[key], list):\n                attr[key].extend(key_val)\n            else:\n                attr[key] = key_val\n        else:\n            attr[key] = key_val\n</code></pre> <p>The <code>merge</code> key is a list of key names within the dict that should be deep-merged rather than replaced. These keys are popped from the incoming data and merged individually before the remaining keys undergo normal <code>attr.update(new_val)</code>.</p>"},{"location":"architecture/configuration-merging/#example","title":"Example","text":"<p>In the RHEL spec's VMware <code>platform_specific</code>, the config section uses:</p> <pre><code>{\n  \"config\": {\n    \"merge\": [\"vmx_data\"],\n    \"vmx_data\": {\n      \"scsi0.virtualdev\": \"pvscsi\"\n    }\n  }\n}\n</code></pre> <p>Without the <code>merge</code> directive, the entire <code>vmx_data</code> dict from the platform level would be replaced. With it, the new key <code>scsi0.virtualdev</code> is added to the existing <code>vmx_data</code> dict while preserving keys set by previous layers.</p>"},{"location":"architecture/configuration-merging/#behavior-by-type","title":"Behavior by Type","text":"Existing type Incoming type Merge behavior dict dict <code>attr[key].update(key_val)</code> -- keys are merged list list <code>attr[key].extend(key_val)</code> -- items are appended other any <code>attr[key] = key_val</code> -- replaced outright"},{"location":"architecture/configuration-merging/#how-load_specific-works","title":"How load_specific() Works","text":"<p>Location: <code>core.py</code>, lines 294-313.</p> <p><code>load_specific()</code> processes conditional override sections that apply only when certain runtime values match. It operates on a fixed list of 6 specific types, processed in this exact order:</p> <ol> <li><code>platform_specific</code></li> <li><code>location_specific</code></li> <li><code>dist_specific</code></li> <li><code>version_specific</code></li> <li><code>arch_specific</code></li> <li><code>firmware_specific</code></li> </ol>"},{"location":"architecture/configuration-merging/#matching-algorithm","title":"Matching Algorithm","text":"<p>For each specific type, <code>load_specific()</code>:</p> <ol> <li>Constructs the data key by appending <code>_specific</code> to the type name (e.g., <code>version</code> -&gt; <code>version_specific</code>).</li> <li>Retrieves the current runtime value from <code>self.defs</code> using the type name as key (e.g., <code>self.defs[\"version\"]</code>).</li> <li>Iterates over each entry in the specific section's array.</li> <li>Pops the type-name key from the entry (e.g., <code>entry.pop(\"version\")</code>).</li> <li>Tests the popped value against the runtime value using <code>re.fullmatch()</code> with <code>re.IGNORECASE</code>.</li> <li>If matched, calls <code>load_data(entry)</code> with the remaining entry data.</li> </ol> <pre><code>specifics = [\"platform\", \"location\", \"dist\", \"version\", \"arch\", \"firmware\"]\nfor section in specifics:\n    name = self.defs.get(section, None)\n    if name:\n        specific_data = data.get(section + \"_specific\", [])\n        for entry in specific_data:\n            specific_data_name = entry.pop(section, \"\")\n            if re.fullmatch(specific_data_name, name, re.IGNORECASE):\n                self.load_data(entry, False)\n</code></pre>"},{"location":"architecture/configuration-merging/#recursive-application","title":"Recursive Application","text":"<p>Because <code>load_data()</code> calls <code>load_specific()</code> at the end, and <code>load_specific()</code> calls <code>load_data()</code> for each match, the system supports arbitrary nesting of specific sections. For example, a <code>version_specific</code> entry can contain a <code>platform_specific</code> section, which can contain an <code>arch_specific</code> section.</p> <p>This recursion is visible in the RHEL spec: the <code>version_specific</code> entry for <code>7.*</code> contains a <code>platform_specific</code> array with entries for proxmox, virtualbox, vmware, and vsphere. When building <code>rhel-7.9-x86_64</code> on vsphere, the system matches version <code>7.*</code>, enters <code>load_data()</code> for that entry, which then triggers <code>load_specific()</code> again, matching platform <code>vsphere</code> and loading its overrides.</p>"},{"location":"architecture/configuration-merging/#pattern-matching","title":"Pattern Matching","text":"<p>The match values in specific sections are regex patterns passed to <code>re.fullmatch()</code>. Common patterns:</p> Pattern Matches <code>8.*</code> Any version starting with <code>8.</code> (e.g., <code>8.3</code>, <code>8.10</code>) <code>[23].*</code> Versions <code>2.x</code> or <code>3.x</code> <code>proxmox</code> Exact match for platform <code>proxmox</code> <code>x86_64</code> Exact match for architecture <code>x86_64</code>"},{"location":"architecture/configuration-merging/#how-load_file-handles-includes","title":"How load_file() Handles Includes","text":"<p>Location: <code>core.py</code>, lines 421-442.</p> <p>The include system enables spec inheritance. When a data file contains an <code>\"include\"</code> key, the referenced file(s) are loaded first, then the current file's data is applied on top.</p>"},{"location":"architecture/configuration-merging/#include-processing","title":"Include Processing","text":"<pre><code>def load_file(self, where, file_path):\n    data = self.read_data(file_path)\n    incs = data.pop(\"include\", None)\n    if incs:\n        if isinstance(incs, list):\n            for inc in incs:\n                data = self.load_inc(where, inc, data)\n        elif isinstance(incs, str):\n            data = self.load_inc(where, incs, data)\n    else:\n        self.load_data(data)\n    return data\n</code></pre> <p>The <code>include</code> key is popped from the data before processing. It can be: - A string: A single spec name to include (e.g., <code>\"include\": \"rhel\"</code>). - A list: Multiple spec names to include in order (e.g., <code>\"include\": [\"ssh\", \"linux\"]</code>).</p>"},{"location":"architecture/configuration-merging/#how-load_inc-works","title":"How load_inc() Works","text":"<p>Location: <code>core.py</code>, lines 404-419.</p> <p><code>load_inc()</code> orchestrates the include chain:</p> <ol> <li>Calls <code>load_data_file()</code> to load the included file. This recursively processes that file's own includes.</li> <li>Calls <code>load_data(data)</code> to apply the current file's sections to the imager state.</li> <li>Calls <code>inc_data.update(data)</code> to merge the current file's raw data on top of the included file's raw data (for the returned dict).</li> </ol> <p>The result: the included file's settings are loaded first, then the current file's settings overlay them. This means child specs override parent specs.</p>"},{"location":"architecture/configuration-merging/#example-include-chain","title":"Example Include Chain","text":"<p>For an AlmaLinux 9.3 build:</p> <pre><code>alma/spec.json\n  -&gt; includes \"rhel\"\n     rhel/spec.json\n       -&gt; includes \"linux\"\n          linux/spec.json\n            -&gt; includes \"ssh\"\n               ssh/spec.json (base communicator config)\n</code></pre> <p>Each file in the chain is loaded bottom-up: <code>ssh</code> first, then <code>linux</code> overlays, then <code>rhel</code> overlays, then <code>alma</code> overlays.</p>"},{"location":"architecture/configuration-merging/#how-load_data_file-resolves-paths","title":"How load_data_file() Resolves Paths","text":"<p>Location: <code>core.py</code>, lines 444-469.</p> <p><code>load_data_file()</code> translates a logical name (e.g., <code>\"vsphere\"</code>) into a filesystem path based on the <code>where</code> parameter:</p> <code>where</code> value Path resolution <code>specs</code> <code>{data_dir}/specs/{what}/spec.json</code> <code>locations</code> <code>{user_dir}/locations/{what}.json</code> or <code>{what}.toml</code> (JSON takes priority) <code>platforms</code> <code>{data_dir}/platforms/{what}.json</code>"},{"location":"architecture/configuration-merging/#location-resolution-detail","title":"Location Resolution Detail","text":"<p>For locations, the method checks for both JSON and TOML files:</p> <pre><code>if where == 'locations':\n    loc_dir = os.path.join(self.settings['user_dir'], \"locations\")\n    if not what.endswith(('.json', '.toml')):\n        json_path = os.path.join(loc_dir, what + \".json\")\n        toml_path = os.path.join(loc_dir, what + \".toml\")\n        file_path = json_path if os.path.exists(json_path) else toml_path\n</code></pre> <p>If the name already has an extension, it is used as-is. Otherwise, JSON is checked first.</p>"},{"location":"architecture/configuration-merging/#extension-handling","title":"Extension Handling","text":"<p>For non-location files, <code>.json</code> is appended if not already present (line 465-466).</p> <p>After resolving the path, <code>load_data_file()</code> delegates to <code>load_file()</code> which handles reading, include processing, and data loading.</p>"},{"location":"architecture/configuration-merging/#complete-build-assembly","title":"Complete Build Assembly","text":"<p>The full merge sequence executed by <code>make_build()</code> (line 964) produces the final Packer build configuration:</p> <ol> <li>Initialize default environment variables and provisioners (lines 999-1021).</li> <li>Load platform: <code>load_data_file(\"platforms\", platform_name)</code> (line 1026).</li> <li>Load location: <code>load_data_file(\"locations\", location_name)</code> (line 1035).</li> <li>Load spec: <code>load_file(\"specs\", spec_path)</code> (line 1041).</li> <li>Set computed defs: version parts, paths, network config, DNS, NTP (lines 1094-1178).</li> <li>Apply CLI defines: user <code>--define</code> overrides (lines 1169-1178).</li> <li>Run template substitution: <code>do_sub()</code> on all sections (lines 1223-1237).</li> <li>Assemble build JSON: variables, provisioners (pre + main + post), builders (lines 1248-1252).</li> <li>Resolve Packer vault refs: when using config-based secrets (line 1255-1256).</li> </ol> <p>The resulting <code>self.build</code> dict is the final Packer JSON written to the temp directory and passed to <code>packer build</code>.</p>"},{"location":"architecture/file-generation/","title":"File Generation","text":"<p>OSImager generates installer configuration files (kickstart, preseed, cloud-init, AutoYaST, Autounattend) at build time by assembling template fragments and applying template substitution.</p>"},{"location":"architecture/file-generation/#how-it-works","title":"How It Works","text":""},{"location":"architecture/file-generation/#the-files-array","title":"The <code>files</code> Array","text":"<p>Each spec can define a <code>files</code> array. Each entry specifies source fragments to concatenate and a destination filename:</p> <pre><code>{\n  \"files\": [\n    {\n      \"sources\": [\n        \"rhel/kickstart_8.cfg\",\n        \"rhel/ks-part.sh\",\n        \"rhel/kickstart_end.cfg\",\n        \"rhel/kickstart_post.cfg\"\n      ],\n      \"dest\": \"ks.cfg\"\n    }\n  ]\n}\n</code></pre> <p>Source paths are relative to <code>osimager/data/files/</code>.</p>"},{"location":"architecture/file-generation/#the-gen_files-method","title":"The <code>gen_files()</code> Method","text":"<p><code>gen_files()</code> (core.py:1300-1334) processes the files array:</p> <ol> <li>Apply <code>do_sub()</code> to the files array itself (resolves <code>&gt;&gt;major&lt;&lt;</code> in source paths like <code>rhel/kickstart_&gt;&gt;major&lt;&lt;.cfg</code>).</li> <li>For each entry in the array:</li> <li>Read each source file from <code>osimager/data/files/</code>.</li> <li>Concatenate all sources in order into a single string.</li> <li>Apply <code>do_substr()</code> on the concatenated content \u2014 all 12 substitution actions run against the full text.</li> <li>Write the result to <code>{temp_dir}/{dest}</code>.</li> </ol> <p>Source filenames can contain template markers. For example, RHEL uses <code>rhel/kickstart_&gt;&gt;major&lt;&lt;.cfg</code> which resolves to <code>rhel/kickstart_8.cfg</code> or <code>rhel/kickstart_9.cfg</code> based on the version being built.</p>"},{"location":"architecture/file-generation/#when-gen_files-runs","title":"When gen_files() Runs","text":"<p><code>gen_files()</code> is called from <code>run_packer()</code> (core.py:1350), after changing to the data directory and checking required files, but before writing the Packer JSON and executing packer.</p>"},{"location":"architecture/file-generation/#installer-types-by-distribution","title":"Installer Types by Distribution","text":""},{"location":"architecture/file-generation/#kickstart-rhel-family-esxi","title":"Kickstart (RHEL Family, ESXi)","text":"<p>Used by: RHEL, CentOS, AlmaLinux, Rocky Linux, Oracle Linux, ESXi</p> <p>Kickstart files are assembled from versioned fragments in <code>data/files/rhel/</code>:</p> <ul> <li><code>kickstart_3.cfg</code> through <code>kickstart_10.cfg</code> \u2014 version-specific base configs</li> <li><code>ks-part.sh</code> \u2014 partition script</li> <li><code>kickstart_end.cfg</code> \u2014 final section</li> <li><code>kickstart_post.cfg</code> \u2014 post-install script</li> <li><code>install_vmwtools.sh</code> \u2014 VMware tools installation (for VMware/vSphere platforms)</li> </ul> <p>The <code>version_specific</code> entries in the RHEL spec select which kickstart fragment to use based on the major version. For example, RHEL 8.x uses <code>kickstart_8.cfg</code>.</p> <p>Template variables in kickstart files include:</p> <ul> <li><code>&gt;&gt;name&lt;&lt;</code> \u2014 hostname</li> <li><code>&gt;&gt;domain&lt;&lt;</code> \u2014 DNS domain</li> <li><code>&gt;&gt;ip&lt;&lt;</code>, <code>&gt;&gt;gateway&lt;&lt;</code>, <code>&gt;&gt;netmask&lt;&lt;</code> \u2014 network config</li> <li><code>&gt;&gt;dns1&lt;&lt;</code>, <code>&gt;&gt;dns2&lt;&lt;</code> \u2014 DNS servers</li> <li><code>&gt;&gt;ntp1&lt;&lt;</code> \u2014 NTP server</li> <li><code>6&gt;images/linux:password&lt;6</code> \u2014 SHA512 root password hash</li> <li><code>|&gt;images/linux:username&lt;|</code> \u2014 root username</li> </ul> <p>ESXi uses its own kickstart files in <code>data/files/esxi/</code>.</p> <p>Oracle Linux overrides the RHEL kickstart for version 6 with a custom <code>kickstart_6.cfg</code> in <code>data/files/oel/</code>.</p>"},{"location":"architecture/file-generation/#preseed-debian-ubuntu-1804","title":"Preseed (Debian, Ubuntu 18.04)","text":"<p>Used by: Debian 8-9, Ubuntu 18.04</p> <p>Preseed files are debconf answer files in <code>data/files/debian/</code>:</p> <ul> <li><code>debian.seed</code> \u2014 main preseed template</li> <li><code>debian.fix</code> \u2014 post-install fix script</li> </ul> <p>Template variables include network configuration, DNS, timezone, and password hashes.</p>"},{"location":"architecture/file-generation/#cloud-init-debian-10-ubuntu-2004","title":"Cloud-Init (Debian 10+, Ubuntu 20.04+)","text":"<p>Used by: Debian 10+, Ubuntu 20.04+</p> <p>Cloud-init configuration in <code>data/files/ubuntu/</code> (also used by modern Debian):</p> <ul> <li><code>user-data</code> \u2014 cloud-init user-data YAML</li> <li><code>meta-data</code> \u2014 cloud-init meta-data</li> </ul> <p>These are served via a virtual CD with label <code>cidata</code> (set via <code>cd_label</code> def). The boot command references the <code>autoinstall</code> endpoint.</p>"},{"location":"architecture/file-generation/#autoyast-sles","title":"AutoYaST (SLES)","text":"<p>Used by: SLES 12.x, 15.x, 16.x</p> <p>AutoYaST XML configuration files in <code>data/files/sles/</code>:</p> <ul> <li><code>autoinst_12.xml</code> \u2014 SLES 12 configuration</li> <li><code>autoinst_15.xml</code> \u2014 SLES 15 configuration</li> <li><code>autoinst_16.xml</code> \u2014 SLES 16 configuration</li> </ul> <p>The <code>version_specific</code> entries select the appropriate XML file based on the major version.</p>"},{"location":"architecture/file-generation/#autounattend-windows","title":"Autounattend (Windows)","text":"<p>Used by: Windows, Windows Server</p> <p>XML answer file in <code>data/files/windows/</code>:</p> <ul> <li><code>Autounattend.xml</code> \u2014 unattended Windows installation configuration</li> </ul> <p>Contains product keys, disk partitioning, locale settings, and administrator credentials via template substitution.</p>"},{"location":"architecture/file-generation/#how-files-flow-into-the-build","title":"How Files Flow Into the Build","text":"<ol> <li>Generated files are written to <code>temp_dir</code> (a temporary directory created per build).</li> <li>The platform config references these files via <code>cd_files</code> or <code>cd_content</code> in the Packer builder:    <pre><code>\"cd_files\": \"%&gt;cd_files&lt;%\"\n</code></pre>    The <code>cd_files</code> def is typically set to `&gt;&gt;temp_dir&lt;</li> </ol>"},{"location":"architecture/overview/","title":"System Architecture","text":"<p>OSImager v1.3.0 -- a Python-based OS image builder that orchestrates HashiCorp Packer to create VM images across 13 platforms and 12 OS distribution families. The entire build pipeline is driven by a single <code>OSImager</code> class that loads JSON/TOML configuration, performs template substitution, and executes Packer.</p>"},{"location":"architecture/overview/#package-structure","title":"Package Structure","text":"<pre><code>osimager/\n    __init__.py          -- re-exports OSImager class\n    core.py              -- OSImager class, all build logic (1415 lines)\n    cli.py               -- 3 CLI entry points: main_mkosimage, main_rfosimage, main_mkvenv (204 lines)\n    utils.py             -- template substitution engine, version expansion, password hashing, network utils (847 lines)\n    constants.py         -- OSIMAGER_VERSION, SUPPORTED_PLATFORMS, SUPPORTED_DISTRIBUTIONS, SUPPORTED_ARCHITECTURES, DEFAULT_SETTINGS, ERROR_MESSAGES, EXIT_CODES (227 lines)\n    data/\n        platforms/       -- 13 platform configs + all.json (base defaults)\n        specs/           -- 15 spec directories (one per distro family + base communicator/OS specs)\n        files/           -- installer templates organized by distro (8 directories)\n        tasks/           -- 21 Ansible task files for post-install provisioning\n        ansible/         -- config.yml (main Ansible playbook)\n        examples/        -- quickstart-location.toml, example-secrets, example-vault, example-location.json, example-location.toml\n</code></pre>"},{"location":"architecture/overview/#the-osimager-class","title":"The OSImager Class","text":"<p>Single class in <code>core.py</code> that orchestrates everything. Instantiated with <code>OSImager(argv, which, extra_args)</code> where <code>which</code> is <code>\"full\"</code> (build mode) or <code>\"venv\"</code> (setup only). The constructor calls <code>init_vars()</code> then <code>init_settings(argv, which, extra_args)</code>.</p>"},{"location":"architecture/overview/#instance-variables","title":"Instance Variables","text":"<p>Accumulator state -- populated progressively as platform, location, and spec configs are loaded:</p> Variable Type Purpose <code>settings</code> dict Runtime configuration: <code>base_dir</code>, <code>user_dir</code>, <code>data_dir</code>, <code>packer_cmd</code>, <code>venv_dir</code>, <code>ansible_playbook</code>, <code>packer_cache_dir</code>, <code>local_only</code>, <code>save_index</code>, <code>credential_source</code>, <code>vault_addr</code>, <code>vault_token</code> <code>defs</code> dict All template substitution variables accumulated from settings, platform, location, spec, and runtime values. Used by <code>&gt;&gt;var&lt;&lt;</code> and all other marker patterns. <code>config</code> dict Packer builder configuration. Populated by platform/location/spec <code>config</code> sections via <code>load_data()</code>. Becomes <code>builders[0]</code> in final output. <code>variables</code> dict Packer user variables for <code>{{user ...}}</code> references. Contains <code>platform-name</code>, <code>location-name</code>, <code>spec-name</code>, <code>spec-config</code>, <code>name</code>, <code>fqdn</code>. <code>evars</code> dict Environment variables set before Packer runs. Includes Ansible control vars (<code>ANSIBLE_RETRY_FILES_ENABLED</code>, <code>ANSIBLE_NOCOWS</code>, etc.) and optionally <code>VAULT_TOKEN</code>, <code>VAULT_ADDR</code>, <code>PATH</code>. <code>files</code> list Installer file generation recipes. Each entry has <code>sources</code> (template fragments) and <code>dest</code> (output filename). Processed by <code>gen_files()</code>. <code>provisioners</code> list Main Ansible provisioners. Initialized with a default ansible provisioner in <code>make_build()</code>. <code>pre_provisioners</code> list Provisioners that run before main provisioners. <code>post_provisioners</code> list Provisioners that run after main provisioners. <code>platform</code> dict Raw loaded platform config data. <code>location</code> dict Raw loaded location config data. <code>spec</code> dict Raw loaded spec config data. <code>vault</code> hvac.Client or None HashiCorp Vault client instance (vault credential mode). <code>secrets</code> dict Loaded secrets keyed by path (config credential mode). <code>fqdn</code> str Fully qualified domain name for the instance. <p>CLI flags -- set from parsed arguments:</p> <p><code>target</code>, <code>name</code>, <code>ip</code>, <code>verbose</code>, <code>debug</code>, <code>list</code>, <code>on_error</code>, <code>log</code>, <code>logfile</code>, <code>force</code>, <code>keep</code>, <code>timestamp</code>, <code>dump_defs</code>, <code>dump_build</code>, <code>user_temp_dir</code>, <code>local_only</code>, <code>dry_run</code>, <code>user_defines</code>, <code>config_file</code></p>"},{"location":"architecture/overview/#initialization-sequence","title":"Initialization Sequence","text":"<ol> <li><code>__init__()</code> calls <code>init_vars()</code> -- zeros all accumulator state</li> <li><code>__init__()</code> calls <code>init_settings(argv, which, extra_args)</code>:</li> <li>Sets <code>settings</code> dict with hardcoded defaults (<code>base_dir</code> = package dir, <code>user_dir</code> = <code>~/.config/osimager</code>, etc.)</li> <li>Builds argparse parser from <code>arg_base_defs</code> (always) and <code>arg_full_defs</code> (when <code>which=\"full\"</code>)</li> <li>Merges <code>extra_args</code> if provided (used by rfosimage)</li> <li>Parses <code>argv</code>, stores results as instance attributes</li> <li>Calls <code>load_settings()</code> to read <code>~/.config/osimager/osimager.conf</code> (INI format via <code>configparser</code>)</li> <li>Applies <code>--set key=value</code> overrides; saves back to conf if any changed</li> <li>Creates <code>~/.config/osimager/locations/</code> directory</li> <li>Seeds <code>defs</code> with all settings values plus <code>base_path</code> alias</li> </ol>"},{"location":"architecture/overview/#data-directory-layout","title":"Data Directory Layout","text":""},{"location":"architecture/overview/#platforms-dataplatforms","title":"Platforms (<code>data/platforms/</code>)","text":"<p>13 platform JSON files + <code>all.json</code>:</p> <ul> <li><code>all.json</code> -- base defaults loaded for every build (common config keys, communicator settings)</li> <li><code>vmware.json</code>, <code>vmware-vmx.json</code>, <code>virtualbox.json</code>, <code>qemu.json</code>, <code>libvirt.json</code>, <code>proxmox.json</code>, <code>vsphere.json</code>, <code>hyperv.json</code>, <code>xenserver.json</code> -- on-premise hypervisors</li> <li><code>aws.json</code>, <code>azure.json</code>, <code>gcp.json</code> -- cloud platforms</li> <li><code>none.json</code> -- null builder (no hypervisor)</li> </ul> <p>Each platform file contains <code>config</code>, <code>defs</code>, <code>evars</code>, <code>variables</code>, <code>provisioners</code>, and optional <code>platform_specific</code> / <code>dist_specific</code> / <code>arch_specific</code> sections.</p>"},{"location":"architecture/overview/#specs-dataspecs","title":"Specs (<code>data/specs/</code>)","text":"<p>15 spec directories, each containing <code>spec.json</code>:</p> <ul> <li>Distro families: <code>alma/</code>, <code>centos/</code>, <code>debian/</code>, <code>esxi/</code>, <code>oel/</code>, <code>rhel/</code>, <code>rocky/</code>, <code>sles/</code>, <code>sysvr4/</code>, <code>ubuntu/</code>, <code>windows/</code>, <code>windows-server/</code></li> <li>Base specs: <code>linux/</code> (common Linux config), <code>ssh/</code> (SSH communicator), <code>winrm/</code> (WinRM communicator)</li> </ul> <p>Spec files declare <code>provides</code> (dist, versions with range syntax, architectures), <code>include</code> (inheritance chain), <code>version_specific</code> entries (regex-matched overrides), <code>required_files</code>, <code>files</code>, and all accumulator sections.</p>"},{"location":"architecture/overview/#files-datafiles","title":"Files (<code>data/files/</code>)","text":"<p>8 directories of installer templates: <code>debian/</code>, <code>esxi/</code>, <code>linux/</code>, <code>oel/</code>, <code>rhel/</code>, <code>sles/</code>, <code>ubuntu/</code>, <code>windows/</code></p> <p>Templates contain <code>&gt;&gt;var&lt;&lt;</code> markers and other substitution patterns. Assembled by <code>gen_files()</code> from <code>sources</code> lists in spec <code>files</code> entries.</p>"},{"location":"architecture/overview/#tasks-datatasks","title":"Tasks (<code>data/tasks/</code>)","text":"<p>21 Ansible task files for post-install provisioning:</p> <ul> <li>OS-family pairs: <code>RedHat_pre.yml</code>/<code>RedHat_post.yml</code>, <code>Debian_pre.yml</code>/<code>Debian_post.yml</code>, <code>Suse_pre.yml</code>/<code>Suse_post.yml</code>, <code>Windows_pre.yml</code>/<code>Windows_post.yml</code>, <code>Linux_pre.yml</code>/<code>Linux_post.yml</code></li> <li>Platform-specific: <code>vsphere_post.yml</code>, <code>proxmox_pre.yml</code>, <code>gcp_post.yml</code>, <code>gcp_linux_post.yml</code></li> <li>Utility: <code>spec.yml</code>, <code>local_repo.yml</code>, <code>rhel_6_config.yml</code>, <code>windows_updates.yml</code>, <code>copy_files_if.yml</code>, <code>include_role_if.yml</code>, <code>include_tasks_if.yml</code></li> </ul>"},{"location":"architecture/overview/#ansible-config-dataansible","title":"Ansible Config (<code>data/ansible/</code>)","text":"<p><code>config.yml</code> -- the main Ansible playbook referenced by the default provisioner. Invoked by Packer with extra-vars containing platform, location, spec, and install directory.</p>"},{"location":"architecture/overview/#examples-dataexamples","title":"Examples (<code>data/examples/</code>)","text":"<p><code>quickstart-location.toml</code>, <code>example-location.json</code>, <code>example-location.toml</code>, <code>example-secrets</code>, <code>example-vault</code> -- reference files for user setup.</p>"},{"location":"architecture/overview/#user-configuration","title":"User Configuration","text":"<p>All user-specific configuration lives outside the package at <code>~/.config/osimager/</code>:</p> Path Format Purpose <code>osimager.conf</code> INI (configparser) Persistent settings. Written only on <code>--set</code>. Section <code>[osimager]</code> with keys matching <code>settings</code> dict. <code>locations/*.json</code> or <code>locations/*.toml</code> JSON or TOML User-created location files. JSON takes priority over TOML if both exist for same name. <code>secrets</code> Custom text Credentials file for config mode. Format: <code>path key1=value1 key2=value2</code>. Lines starting with <code>#</code> are comments. <code>specs/index.json</code> JSON Cached spec index. Created when <code>save_index=True</code>. Maps <code>dist-version-arch</code> keys to spec file paths and provides entries."},{"location":"architecture/overview/#cli-entry-points","title":"CLI Entry Points","text":"<p>Defined in <code>cli.py</code>, registered as console_scripts in <code>pyproject.toml</code>:</p>"},{"location":"architecture/overview/#mkosimage-main_mkosimage","title":"mkosimage (<code>main_mkosimage</code>)","text":"<p>Primary build command. Flow:</p> <ol> <li><code>OSImager(argv, which=\"full\")</code> -- parse args, load settings</li> <li>If <code>--list</code>: call <code>get_index()</code>, print all specs with ISO availability flags, exit</li> <li>If no target: print usage with platform/location discovery, exit</li> <li><code>make_build(target, name, ip)</code> -- load configs, resolve ISO, load credentials, perform substitutions, assemble Packer JSON</li> <li>If <code>--dump-defs</code> or <code>--dump-config</code>: print and exit</li> <li><code>run_packer()</code> -- generate files, write build JSON, set environment, execute <code>packer build</code></li> </ol>"},{"location":"architecture/overview/#rfosimage-main_rfosimage","title":"rfosimage (<code>main_rfosimage</code>)","text":"<p>Re-provision command. Replaces the platform builder with a null builder, keeping only the communicator settings. Flow:</p> <ol> <li><code>OSImager(argv, \"full\", extra_args)</code> -- same init as mkosimage</li> <li><code>make_build()</code> -- full build assembly</li> <li>Extract communicator type from <code>config</code></li> <li>Replace <code>builders[0]</code> with a <code>null</code> type builder that keeps only communicator-prefixed keys</li> <li><code>run_packer()</code> -- runs provisioners against existing VM</li> </ol>"},{"location":"architecture/overview/#mkvenv-main_mkvenv","title":"mkvenv (<code>main_mkvenv</code>)","text":"<p>Virtual environment setup. Creates <code>OSImager(argv, which=\"venv\")</code> which only runs initialization (settings load) without build logic.</p>"},{"location":"architecture/overview/#config-loading-pipeline","title":"Config Loading Pipeline","text":"<p>The <code>make_build()</code> method loads configs in this order. Each layer can define <code>config</code>, <code>defs</code>, <code>evars</code>, <code>variables</code>, <code>files</code>, <code>pre_provisioners</code>, <code>provisioners</code>, <code>post_provisioners</code>. Layers merge additively (dicts update, lists extend) unless <code>method: \"replace\"</code> is specified.</p> <ol> <li>all.json -- loaded implicitly as the base platform (via <code>include</code> in platform files, or as <code>all.json</code> in platforms dir)</li> <li>Platform (<code>load_data_file(\"platforms\", name)</code>) -- hypervisor-specific builder type, connection settings</li> <li>Location (<code>load_data_file(\"locations\", name)</code>) -- site-specific networking, storage paths, credentials references</li> <li>Spec (<code>load_file(\"specs\", path)</code>) -- OS-specific installer config, boot commands, ISO URLs</li> </ol> <p>Each config file can use: - <code>include</code> -- loads another spec first (string or list), creating inheritance chains (e.g., alma includes rhel) - <code>*_specific</code> sections -- conditional overrides matched by regex against <code>platform</code>, <code>location</code>, <code>dist</code>, <code>version</code>, <code>arch</code>, <code>firmware</code> - <code>method</code> -- <code>\"merge\"</code> (default) or <code>\"replace\"</code> to control how sections combine</p>"},{"location":"architecture/overview/#template-substitution-engine","title":"Template Substitution Engine","text":"<p>Defined in <code>utils.py</code>. Two core functions:</p> <ul> <li><code>do_sub(item, inst)</code> -- recursively walks dicts, lists, tuples, sets, strings and applies substitution</li> <li><code>do_substr(text, inst)</code> -- processes a single string through all ACTIONS</li> </ul>"},{"location":"architecture/overview/#actions-table","title":"ACTIONS Table","text":"<p>12 marker patterns, each with a numeric action ID and start/end delimiters:</p> Action Markers Description 1 <code>%&gt;..&lt;%</code> Replace complete value (including quotes) with defs variable 2 <code>&gt;&gt;..&lt;&lt;</code> Replace marker with defs variable (most common) 3 <code>+&gt;..&lt;+</code> Replace marker with basename of defs variable 4 <code>*&gt;..&lt;*</code> Replace marker with IP address (DNS lookup) 5 <code>\\|&gt;..&lt;\\|</code> Replace marker with secret value (vault or config) 6 <code>#&gt;..&lt;#</code> Numeric eval (arithmetic on def values) 7 <code>$&gt;..&lt;$</code> Replace marker with environment variable 8 <code>1&gt;..&lt;1</code> MD5 password hash of secret value 9 <code>5&gt;..&lt;5</code> SHA-256 password hash of secret value 10 <code>6&gt;..&lt;6</code> SHA-512 password hash of secret value 11 <code>E&gt;..&lt;E</code> Python eval of expression 12 <code>[&gt;..&lt;]</code> Insert list items (expand list from defs) <p>Actions are applied in order. For each action, <code>extract_all()</code> finds all tokens matching the start/end pattern, then <code>ACTION_HANDLERS[action]</code> produces the replacement value.</p>"},{"location":"architecture/overview/#spec-index-system","title":"Spec Index System","text":"<p><code>make_index()</code> scans all spec files and builds a lookup table: - Calls <code>spec_get_provides()</code> on each spec to expand version ranges into individual entries - Version strings support <code>[0-7]</code> (range) and <code>[3,4,5]</code> (list) syntax via <code>explode_string_with_dynamic_range()</code> - Filters by architectures supported by configured platforms and locations - Keys are <code>dist-version-arch</code> strings (e.g., <code>alma-9.4-x86_64</code>) - Values contain <code>provides</code> dict, spec <code>path</code>, and <code>iso_local</code> flag - Optionally cached to <code>~/.config/osimager/specs/index.json</code></p>"},{"location":"architecture/overview/#credential-system","title":"Credential System","text":"<p>Two modes, selected by <code>credential_source</code> setting:</p>"},{"location":"architecture/overview/#vault-mode-credential_sourcevault","title":"Vault Mode (<code>credential_source=vault</code>)","text":"<ul> <li>Creates <code>hvac.Client</code> with <code>vault_addr</code> and <code>vault_token</code> from settings</li> <li><code>get_secret(\"mount/path:key\")</code> calls <code>vault.secrets.kv.v2.read_secret_version()</code></li> <li>Packer natively resolves <code>{{vault ...}}</code> references via <code>VAULT_TOKEN</code> and <code>VAULT_ADDR</code> environment variables</li> </ul>"},{"location":"architecture/overview/#config-mode-credential_sourceconfig","title":"Config Mode (<code>credential_source=config</code>)","text":"<ul> <li>Reads <code>~/.config/osimager/secrets</code> file</li> <li>Format: <code>path key1=value1 key2=value2</code> per line</li> <li><code>get_secret(\"path:key\")</code> looks up in the loaded <code>secrets</code> dict</li> <li><code>resolve_packer_vault_refs()</code> replaces Packer <code>{{vault \\</code>path` `key`}}` syntax with values from the secrets dict before writing the build JSON</li> </ul> <p>Actions 5, 8, 9, 10 all call <code>imager.get_secret()</code> which dispatches to the active credential source.</p>"},{"location":"architecture/overview/#build-execution","title":"Build Execution","text":"<p><code>run_packer()</code> performs the final execution steps:</p> <ol> <li>Changes working directory to <code>data/</code> (so relative paths in Ansible config resolve)</li> <li>Calls <code>check_required_files()</code> -- verifies spec's <code>required_files</code> entries exist on disk</li> <li>Calls <code>gen_files()</code> -- assembles installer files from template fragments, writes to temp directory</li> <li>Writes the complete Packer build JSON to <code>{temp_dir}/{name}.json</code></li> <li>Sets environment variables from <code>evars</code> dict</li> <li>Constructs packer command: optional venv activation, <code>packer build</code> with flags (<code>-timestamp-ui</code>, <code>-on-error</code>, <code>-force</code>, <code>-debug</code>)</li> <li>Executes via <code>os.system()</code></li> <li>Cleans up temp directory unless <code>--keep</code> or <code>--temp</code> was specified</li> </ol>"},{"location":"architecture/overview/#key-methods-overview","title":"Key Methods Overview","text":""},{"location":"architecture/overview/#initialization","title":"Initialization","text":"<ul> <li><code>init_vars()</code> -- zero all accumulator state (vault, secrets, platform, location, spec, defs, evars, variables, provisioners, config, files, fqdn)</li> <li><code>init_settings(argv, which, extra_args)</code> -- parse CLI args, load/save settings, create user dirs, seed defs</li> <li><code>load_settings(config_path)</code> -- read <code>~/.config/osimager/osimager.conf</code> via configparser</li> <li><code>save_settings(config_path)</code> -- write current settings to osimager.conf</li> </ul>"},{"location":"architecture/overview/#data-loading","title":"Data Loading","text":"<ul> <li><code>read_data(file_path)</code> -- load a JSON or TOML file based on extension</li> <li><code>load_file(where, file_path)</code> -- read a data file, recursively process <code>include</code> chains, call <code>load_data()</code></li> <li><code>load_data_file(where, what)</code> -- resolve a logical name to a file path, then call <code>load_file()</code></li> <li><code>load_data(data)</code> -- merge a config dict's sections into instance accumulators (config, defs, evars, variables, files, provisioners), then process <code>*_specific</code> overrides</li> <li><code>load_inc(where, what, data)</code> -- handle an include directive: load the included file, then apply current data on top</li> <li><code>load_specific(data)</code> -- process <code>platform_specific</code>, <code>location_specific</code>, <code>dist_specific</code>, <code>version_specific</code>, <code>arch_specific</code>, <code>firmware_specific</code> sections using regex matching</li> </ul>"},{"location":"architecture/overview/#index-and-discovery","title":"Index and Discovery","text":"<ul> <li><code>make_index()</code> -- scan all specs, expand version ranges, build dist-version-arch lookup table</li> <li><code>get_index(name)</code> -- return cached or freshly built index, optionally filtered by name</li> <li><code>spec_get_provides(file_name, data)</code> -- extract provides entries from a spec, expanding version ranges and per-version arch overrides</li> <li><code>get_platforms(names)</code> -- list platform configs, optionally filtered by regex</li> <li><code>get_locations(platform_names)</code> -- list location configs from user dir, optionally filtered by platform support</li> <li><code>get_specs(search_string)</code> -- list spec configs, filtered by regex</li> </ul>"},{"location":"architecture/overview/#iso-and-url-handling","title":"ISO and URL Handling","text":"<ul> <li><code>resolve_iso_url(data, version, arch)</code> -- best-effort resolve iso_url from spec defs with version/arch substitution</li> <li><code>check_iso_local(iso_url)</code> -- check if ISO exists locally (file:// path or packer cache)</li> <li><code>check_iso_urls(urls)</code> -- validate remote ISO URLs, download checksums, set defs</li> <li><code>get_iso_file(urls)</code> -- resolve local ISO file path, set defs for local-only mode</li> </ul>"},{"location":"architecture/overview/#credentials","title":"Credentials","text":"<ul> <li><code>load_credentials()</code> -- dispatch to vault or config mode initialization</li> <li><code>load_secrets()</code> -- parse <code>~/.config/osimager/secrets</code> file</li> <li><code>get_secret(string)</code> -- retrieve a secret value from vault or local secrets</li> <li><code>resolve_packer_vault_refs(data)</code> -- replace <code>{{vault ...}}</code> references in Packer JSON with local secret values</li> </ul>"},{"location":"architecture/overview/#build-assembly","title":"Build Assembly","text":"<ul> <li><code>make_build(target, name, ip)</code> -- full build pipeline: parse target, load platform/location/spec, resolve ISO, load credentials, perform substitutions, assemble final Packer JSON</li> <li><code>gen_files()</code> -- assemble installer files from template fragments, write to temp directory</li> <li><code>check_required_files()</code> -- verify all required_files from spec exist on disk</li> <li><code>run_packer()</code> -- write build JSON, set environment, execute packer command</li> </ul>"},{"location":"architecture/overview/#utility","title":"Utility","text":"<ul> <li><code>version()</code> -- print and return version string</li> <li><code>get_path(what, *paths)</code> -- resolve a settings key to an absolute path, join with optional sub-paths</li> </ul>"},{"location":"architecture/template-engine/","title":"Template Engine","text":"<p>OSImager includes a template substitution engine that processes all configuration data before the final Packer build JSON is generated. The engine replaces marker tokens with computed values, supporting variable interpolation, secret retrieval, expression evaluation, password hashing, and list expansion. All substitution logic resides in <code>utils.py</code>.</p>"},{"location":"architecture/template-engine/#processing-flow","title":"Processing Flow","text":"<p>Template substitution is driven by two functions working together:</p>"},{"location":"architecture/template-engine/#do_subitem-imager","title":"do_sub(item, imager)","text":"<p>Location: <code>utils.py</code>, lines 301-334.</p> <p><code>do_sub()</code> is the top-level recursive walker. It traverses any Python data structure (dict, list, tuple, set, str) and applies <code>do_substr()</code> to every string it encounters.</p> <ul> <li>dict: Recurses into both keys and values. Returns a new dict.</li> <li>list: Recurses into each element. Has special handling for <code>[&gt;token&lt;]</code> list expansion markers (see Action 12 below).</li> <li>tuple/set: Recurses into each element. Returns new tuple/set.</li> <li>str: Delegates to <code>do_substr()</code>.</li> <li>other types (int, bool, None, etc.): Returned unchanged.</li> </ul> <p>The list handling for Action 12 is done inline in <code>do_sub()</code> rather than in <code>do_substr()</code>. When a list element is a string of the form <code>[&gt;token&lt;]</code> (where the entire string is the marker), <code>do_sub()</code> checks if the token references a list in <code>imager.defs</code>. If so, it expands the list items directly into the parent list via <code>result.extend()</code>. If the token does not exist in defs, the element is silently dropped.</p>"},{"location":"architecture/template-engine/#do_substrtext-imager","title":"do_substr(text, imager)","text":"<p>Location: <code>utils.py</code>, lines 796-846.</p> <p><code>do_substr()</code> processes a single string through all 12 actions in order. For each action:</p> <ol> <li>Calls <code>extract_all()</code> to find all marker tokens in the string.</li> <li>For each token found, validates it with <code>isvarname()</code> (except Actions 6 and 11 which allow expressions).</li> <li>Calls the action's handler from <code>ACTION_HANDLERS</code>.</li> <li>Type preservation: If the entire string (stripped) equals the full marker, the raw handler return value is returned directly -- preserving non-string types (int, bool, list, dict). This is critical for Action 1.</li> <li>Inline substitution: Otherwise, <code>str(repl)</code> replaces the marker text within the string.</li> </ol>"},{"location":"architecture/template-engine/#extract_alltext-start_pat-end_pat","title":"extract_all(text, start_pat, end_pat)","text":"<p>Location: <code>utils.py</code>, lines 172-179.</p> <p>Finds all tokens between the given delimiters. Operates line by line using <code>re.findall()</code> with escaped delimiter patterns. Returns a list of the inner token strings (without delimiters).</p>"},{"location":"architecture/template-engine/#the-actions-list","title":"The ACTIONS List","text":"<p>Location: <code>utils.py</code>, lines 698-711.</p> <p>Actions are processed sequentially from 1 through 12. The order matters: earlier actions may produce values that later actions consume (e.g., Action 2 substitutions within Action 11 expressions).</p> <pre><code>ACTIONS = [\n    (1, (\"%&gt;\", \"&lt;%\")),   # Complete value replacement\n    (2, (\"&gt;&gt;\", \"&lt;&lt;\")),   # Inline string substitution\n    (3, (\"+&gt;\", \"&lt;+\")),   # Basename substitution\n    (4, (\"*&gt;\", \"&lt;*\")),   # DNS lookup\n    (5, (\"|&gt;\", \"&lt;|\")),   # Secret retrieval\n    (6, (\"#&gt;\", \"&lt;#\")),   # Numeric expression evaluation\n    (7, (\"$&gt;\", \"&lt;$\")),   # Environment variable\n    (8, (\"1&gt;\", \"&lt;1\")),   # MD5 password hash\n    (9, (\"5&gt;\", \"&lt;5\")),   # SHA-256 password hash\n    (10, (\"6&gt;\", \"&lt;6\")),  # SHA-512 password hash\n    (11, (\"E&gt;\", \"&lt;E\")),  # Python eval expression\n    (12, (\"[&gt;\", \"&lt;]\")),  # List item expansion\n]\n</code></pre>"},{"location":"architecture/template-engine/#action_handlers","title":"ACTION_HANDLERS","text":"<p>Location: <code>utils.py</code>, lines 683-696.</p> <p>Each handler is a lambda that takes <code>(token, imager)</code> and returns the replacement value.</p>"},{"location":"architecture/template-engine/#action-reference","title":"Action Reference","text":""},{"location":"architecture/template-engine/#action-1-complete-value-replacement","title":"Action 1: Complete Value Replacement","text":"Delimiters <code>%&gt;token&lt;%</code> Handler <code>get_default(imager.defs, token, 1)</code> Returns Raw value from <code>imager.defs[token]</code> <p>Retrieves the value of <code>token</code> from <code>imager.defs</code> and returns it with full type preservation. When the entire string is <code>%&gt;token&lt;%</code>, the return value can be any type: bool, int, list, dict, or string. This is the only action that intentionally preserves non-string types.</p> <p>Use case: Passing structured data like lists or booleans directly into the Packer config without stringification.</p> <p>Example: <pre><code>\"cd_files\": \"%&gt;cd_files&lt;%\"\n</code></pre> If <code>defs[\"cd_files\"]</code> is a string, it replaces the value. If it is a list, the JSON value becomes that list.</p> <p><pre><code>\"disk_thin_provisioned\": \"%&gt;thin_disk&lt;%\"\n</code></pre> If <code>defs[\"thin_disk\"]</code> is <code>false</code> (Python bool), the JSON value becomes <code>false</code>, not the string <code>\"false\"</code>.</p>"},{"location":"architecture/template-engine/#action-2-inline-string-substitution","title":"Action 2: Inline String Substitution","text":"Delimiters <code>&gt;&gt;token&lt;&lt;</code> Handler <code>get_default(imager.defs, token, 2)</code> Returns Value from <code>imager.defs[token]</code>, converted to string if used inline <p>The workhorse substitution. Replaces the marker with the string representation of the defs value. If the entire string is only the marker, type preservation applies (same as Action 1). When the marker is embedded within a larger string, the value is converted to string via <code>str()</code>.</p> <p>Use case: Building paths, URLs, filenames, and any templated string.</p> <p>Example: <pre><code>\"iso_url\": \"https://vault.almalinux.org/&gt;&gt;version&lt;&lt;/isos/&gt;&gt;arch&lt;&lt;/AlmaLinux-&gt;&gt;version&lt;&lt;-&gt;&gt;arch&lt;&lt;-dvd.iso\"\n</code></pre></p>"},{"location":"architecture/template-engine/#action-3-basename-substitution","title":"Action 3: Basename Substitution","text":"Delimiters <code>+&gt;token&lt;+</code> Handler <code>get_default(imager.defs, token, 3)</code> Returns <code>os.path.basename()</code> of the defs value <p>Retrieves the value from defs and returns only the filename component (stripping any directory path).</p> <p>Use case: Extracting just the filename from a full path stored in defs.</p> <p>Example: <pre><code>\"iso_name\": \"+&gt;iso_file&lt;+\"\n</code></pre> If <code>defs[\"iso_file\"]</code> is <code>/iso/RedHat/rhel-9.3-x86_64-dvd.iso</code>, the result is <code>rhel-9.3-x86_64-dvd.iso</code>.</p>"},{"location":"architecture/template-engine/#action-4-dns-lookup","title":"Action 4: DNS Lookup","text":"Delimiters <code>*&gt;token&lt;*</code> Handler <code>get_default(imager.defs, token, 4)</code> Returns IPv4 address string from DNS A record lookup via <code>get_ip()</code> <p>Retrieves the hostname from <code>imager.defs[token]</code>, then performs a DNS A record lookup using <code>get_ip()</code>. Returns the resolved IP address as a string.</p> <p>Use case: Resolving hostnames to IP addresses at build time.</p> <p>Example: <pre><code>\"ip_address\": \"*&gt;fqdn&lt;*\"\n</code></pre></p>"},{"location":"architecture/template-engine/#action-5-secret-retrieval","title":"Action 5: Secret Retrieval","text":"Delimiters <code>\\|&gt;token&lt;\\|</code> Handler <code>imager.get_secret(token)</code> Returns Secret value string <p>Retrieves a secret using <code>imager.get_secret()</code>, which dispatches to either HashiCorp Vault or the local secrets file based on the <code>credential_source</code> setting. The token format is <code>path:key</code> where <code>path</code> is the secret path and <code>key</code> is the specific field within the secret.</p> <p>Use case: Injecting passwords, API keys, or other sensitive values into configurations.</p> <p>Example: <pre><code>\"root_password\": \"|&gt;images/linux:password&lt;|\"\n</code></pre></p>"},{"location":"architecture/template-engine/#action-6-numeric-expression-evaluation","title":"Action 6: Numeric Expression Evaluation","text":"Delimiters <code>#&gt;expr&lt;#</code> Handler <code>eval_expression(token, imager.defs)</code> Returns Integer result of arithmetic evaluation <p>Evaluates arithmetic expressions where operands are defs variable names. The expression is split on <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code> operators. Each operand is looked up in <code>imager.defs</code>, then the resulting numeric expression is evaluated with Python <code>eval()</code> and cast to <code>int()</code>.</p> <p>Use case: Computing derived numeric values from defs at build time.</p> <p>Example: <pre><code>\"CPUs\": \"#&gt;cpu_sockets*cpu_cores&lt;#\"\n</code></pre> If <code>defs[\"cpu_sockets\"]</code> is <code>1</code> and <code>defs[\"cpu_cores\"]</code> is <code>2</code>, the result is <code>2</code>.</p> <p><pre><code>\"RAM\": \"#&gt;memory&lt;#\"\n</code></pre> Single-variable expressions also work -- the value is looked up and returned as int.</p>"},{"location":"architecture/template-engine/#action-7-environment-variable","title":"Action 7: Environment Variable","text":"Delimiters <code>$&gt;token&lt;$</code> Handler <code>get_env(token)</code> Returns Value of <code>os.environ[token]</code>, or empty string if not set <p>Reads a system environment variable by name.</p> <p>Use case: Incorporating host environment values into the build configuration.</p> <p>Example: <pre><code>\"http_proxy\": \"$&gt;HTTP_PROXY&lt;$\"\n</code></pre></p>"},{"location":"architecture/template-engine/#action-8-md5-password-hash","title":"Action 8: MD5 Password Hash","text":"Delimiters <code>1&gt;token&lt;1</code> Handler <code>hash_password(imager.get_secret(token), 'md5')</code> Returns MD5-crypt hash string (prefix <code>$1$</code>) <p>Retrieves the secret identified by <code>token</code>, then generates an MD5-crypt hash compatible with <code>/etc/shadow</code> format. The hash uses the <code>$1$</code> prefix.</p> <p>Use case: Generating hashed passwords for legacy OS kickstart files that require MD5-crypt format.</p> <p>Example: <pre><code>\"rootpw\": \"1&gt;images/linux:password&lt;1\"\n</code></pre></p>"},{"location":"architecture/template-engine/#action-9-sha-256-password-hash","title":"Action 9: SHA-256 Password Hash","text":"Delimiters <code>5&gt;token&lt;5</code> Handler <code>hash_password(imager.get_secret(token), 'sha256')</code> Returns SHA-256-crypt hash string (prefix <code>$5$</code>) <p>Retrieves the secret and generates a SHA-256-crypt hash compatible with <code>/etc/shadow</code>.</p> <p>Use case: Generating hashed passwords for kickstart files on modern RHEL-family systems.</p> <p>Example: <pre><code>\"rootpw\": \"5&gt;images/linux:password&lt;5\"\n</code></pre></p>"},{"location":"architecture/template-engine/#action-10-sha-512-password-hash","title":"Action 10: SHA-512 Password Hash","text":"Delimiters <code>6&gt;token&lt;6</code> Handler <code>hash_password(imager.get_secret(token), 'sha512')</code> Returns SHA-512-crypt hash string (prefix <code>$6$</code>) <p>Retrieves the secret and generates a SHA-512-crypt hash compatible with <code>/etc/shadow</code>.</p> <p>Use case: The most common hash format for modern Linux kickstart root passwords.</p> <p>Example: <pre><code>\"rootpw\": \"6&gt;images/linux:password&lt;6\"\n</code></pre></p>"},{"location":"architecture/template-engine/#action-11-python-eval-expression","title":"Action 11: Python Eval Expression","text":"Delimiters <code>E&gt;expr&lt;E</code> Handler <code>eval_expression_safe(token, imager)</code> Returns Result of Python <code>eval()</code> on the processed expression <p>Two-phase evaluation:</p> <ol> <li>Phase 1: All <code>&gt;&gt;var&lt;&lt;</code> markers (Action 2 syntax) within the expression are substituted with their defs values. This happens inside <code>eval_expression_safe()</code> using a regex replacement, not via the normal Action 2 pipeline.</li> <li>Phase 2: The resulting string is passed to Python <code>eval()</code>.</li> </ol> <p>This allows arbitrary Python expressions that reference defs variables.</p> <p>Use case: Conditional logic, string manipulation, and computed values that go beyond simple arithmetic.</p> <p>Examples: <pre><code>\"iso_url\": \"E&gt;'&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_url&lt;&lt;'&lt;E\"\n</code></pre> This produces a different ISO URL depending on whether <code>local_only</code> is true or false.</p> <p><pre><code>\"guest_os_type\": \"RedHat6E&gt;'_64' if '&gt;&gt;arch&lt;&lt;' == 'x86_64' else ''&lt;E\"\n</code></pre> Appends <code>_64</code> to the guest OS type only when the architecture is x86_64.</p> <p><pre><code>\"iso_paths\": [\"[] /vmimages/tools-isoimages/E&gt;'windows' if '&gt;&gt;spec_name&lt;&lt;'.startswith('win') else 'linux'&lt;E.iso\"]\n</code></pre> Selects between Windows and Linux VMware Tools ISO based on the spec name.</p>"},{"location":"architecture/template-engine/#action-12-list-item-expansion","title":"Action 12: List Item Expansion","text":"Delimiters <code>[&gt;token&lt;]</code> Handler <code>insert_list_items(token, imager)</code> (in handler table) / inline in <code>do_sub()</code> Returns List of items, or empty list <p>Expands a single list element into multiple elements. When a list contains an element <code>\"[&gt;token&lt;]\"</code>, the token is looked up in <code>imager.defs</code>:</p> <ul> <li>If the value is a list, all items are inserted into the parent list.</li> <li>If the value is a string, it is split on commas and whitespace into multiple items.</li> <li>If the token does not exist in defs, the element is silently removed (no output).</li> </ul> <p>The primary expansion logic is in <code>do_sub()</code> (lines 311-323), not in <code>do_substr()</code>. The <code>do_sub()</code> function detects pure list expansion markers in list elements before delegating to the normal substitution pipeline.</p> <p>Use case: Dynamically injecting variable-length argument lists into provisioner configurations.</p> <p>Example: <pre><code>\"extra_arguments\": [\n    \"[&gt;ansible_extra_args&lt;]\",\n    \"--extra-vars\",\n    \"platform={{user `platform-name`}}\"\n]\n</code></pre> If <code>defs[\"ansible_extra_args\"]</code> is <code>[\"--scp-extra-args='-O'\", \"-e\", \"ansible_scp_extra_args='-O'\"]</code>, the resulting list is: <pre><code>[\"--scp-extra-args='-O'\", \"-e\", \"ansible_scp_extra_args='-O'\", \"--extra-vars\", \"platform={{user `platform-name`}}\"]\n</code></pre></p>"},{"location":"architecture/template-engine/#key-behaviors","title":"Key Behaviors","text":""},{"location":"architecture/template-engine/#action-processing-order","title":"Action Processing Order","text":"<p>Actions are always processed in order 1 through 12 on every string. A single string can contain markers from multiple actions. Earlier actions run first, so their results are visible to later actions.</p> <p>The one exception is Action 11 (<code>E&gt;...&lt;E</code>), which performs its own internal <code>&gt;&gt;var&lt;&lt;</code> substitution (Action 2 syntax) before <code>eval()</code>. This two-phase design means Action 2 markers inside Action 11 expressions are resolved even though Action 2 has already been processed at the outer level.</p>"},{"location":"architecture/template-engine/#type-preservation-action-1","title":"Type Preservation (Action 1)","text":"<p>When the entire string (after stripping) matches a single marker, <code>do_substr()</code> returns the handler's raw value directly (line 835-837):</p> <pre><code>if result.strip() == full:\n    return repl\n</code></pre> <p>This is what allows <code>%&gt;thin_disk&lt;%</code> to produce a JSON boolean <code>false</code> instead of the string <code>\"False\"</code>, or <code>%&gt;cd_files&lt;%</code> to produce a list instead of a string.</p> <p>This behavior applies to all actions, not just Action 1. If a string consists of nothing but a single <code>&gt;&gt;token&lt;&lt;</code> marker and the defs value is an integer, the integer is returned.</p>"},{"location":"architecture/template-engine/#secret-dependent-actions","title":"Secret-Dependent Actions","text":"<p>Actions 5, 8, 9, and 10 all use <code>imager.get_secret()</code> to retrieve sensitive values. The <code>get_secret()</code> method dispatches based on the <code>credential_source</code> setting:</p> <ul> <li><code>vault</code>: Uses the HashiCorp Vault client (<code>hvac</code>) to read from Vault's KV v2 secrets engine.</li> <li><code>config</code>: Reads from <code>~/.config/osimager/secrets</code>, a local file with format <code>path key=val key=val</code>.</li> </ul> <p>The token format for all secret actions is <code>path:key</code> (e.g., <code>images/linux:password</code>).</p>"},{"location":"architecture/template-engine/#none-and-false-handling","title":"None and False Handling","text":"<ul> <li>If a handler returns <code>None</code>, it is converted to an empty string <code>\"\"</code> for substitution (line 828).</li> <li>If a handler returns <code>False</code>, the substitution is skipped entirely -- the marker remains in the string (line 830).</li> </ul>"},{"location":"architecture/template-engine/#supporting-functions","title":"Supporting Functions","text":""},{"location":"architecture/template-engine/#explode_string_with_dynamic_range","title":"explode_string_with_dynamic_range()","text":"<p>Location: <code>utils.py</code>, lines 78-113.</p> <p>Expands version range expressions in spec <code>provides.versions</code> strings. Supports two bracket syntaxes:</p> <ul> <li>Range: <code>[start-end]</code> -- generates all integers from start to end inclusive. Preserves zero-padding when the original values have leading zeros.</li> <li>List: <code>[a,b,c]</code> -- generates the explicit list of values.</li> </ul> <p>Multiple bracket groups in a single string produce the Cartesian product of all groups.</p> <p>Examples: - <code>\"8.[3-10]\"</code> -&gt; <code>[\"8.3\", \"8.4\", \"8.5\", \"8.6\", \"8.7\", \"8.8\", \"8.9\", \"8.10\"]</code> - <code>\"5.[1,9,10,11]\"</code> -&gt; <code>[\"5.1\", \"5.9\", \"5.10\", \"5.11\"]</code> - <code>\"12.[01-05]\"</code> -&gt; <code>[\"12.01\", \"12.02\", \"12.03\", \"12.04\", \"12.05\"]</code> (zero-padded)</p> <p>Note: Mixed range-and-list syntax within a single bracket group (e.g., <code>[0-3,5-7]</code>) is not supported. Use separate version strings instead.</p>"},{"location":"architecture/template-engine/#hash_password","title":"hash_password()","text":"<p>Location: <code>utils.py</code>, lines 543-582.</p> <p>Generates crypt-compatible password hashes for <code>/etc/shadow</code> format. Supports three methods:</p> Method Prefix Function <code>md5</code> <code>$1$</code> <code>_md5_crypt()</code> <code>sha256</code> <code>$5$</code> <code>_sha_crypt()</code> with 5000 rounds <code>sha512</code> <code>$6$</code> <code>_sha_crypt()</code> with 5000 rounds <p>On Python &lt; 3.13, the function uses the stdlib <code>crypt</code> module. On Python 3.13+, where <code>crypt</code> was removed, it falls back to pure-Python implementations (<code>_md5_crypt()</code> at line 336, <code>_sha_crypt()</code> at line 404) that produce identical output to glibc's <code>crypt()</code>.</p>"},{"location":"architecture/template-engine/#prefix_to_netmask","title":"prefix_to_netmask()","text":"<p>Location: <code>utils.py</code>, lines 219-227.</p> <p>Converts a CIDR prefix length to a dotted-decimal netmask string.</p> <p>Example: <code>prefix_to_netmask(\"24\")</code> -&gt; <code>\"255.255.255.0\"</code></p>"},{"location":"architecture/template-engine/#get_ip","title":"get_ip()","text":"<p>Location: <code>utils.py</code>, lines 229-250.</p> <p>Performs a DNS A record lookup for a hostname. Uses <code>dns.resolver.Resolver</code> with optional custom search domains and nameservers (from the location's DNS configuration). Returns the IP address string, or <code>None</code> if resolution fails.</p>"},{"location":"architecture/template-engine/#natural_key","title":"natural_key()","text":"<p>Location: <code>utils.py</code>, lines 32-34.</p> <p>Produces sort keys for version-aware natural ordering. Splits a string on digit boundaries and converts numeric segments to integers, enabling proper sorting where <code>\"9.10\"</code> sorts after <code>\"9.9\"</code> rather than between <code>\"9.1\"</code> and <code>\"9.2\"</code>.</p> <p>Used by <code>make_index()</code> in <code>core.py</code> (line 864) to sort the spec index by version number.</p>"},{"location":"architecture/template-engine/#eval_expression","title":"eval_expression()","text":"<p>Location: <code>utils.py</code>, lines 601-636.</p> <p>Evaluates arithmetic expressions for Action 6. Splits the expression on <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code> operators, looks up each operand in <code>imager.defs</code>, reconstructs a numeric expression string, and evaluates it with <code>eval()</code>. Returns the result as <code>int</code>.</p>"},{"location":"architecture/template-engine/#eval_expression_safe","title":"eval_expression_safe()","text":"<p>Location: <code>utils.py</code>, lines 584-599.</p> <p>Evaluates arbitrary Python expressions for Action 11. First performs <code>&gt;&gt;var&lt;&lt;</code> substitution using a regex scan, then passes the result to <code>eval()</code>. Returns whatever <code>eval()</code> produces (string, int, bool, etc.).</p>"},{"location":"architecture/template-engine/#get_default","title":"get_default()","text":"<p>Location: <code>utils.py</code>, lines 669-681.</p> <p>Central dispatcher for Actions 1-4 and 7. Takes the defs dict, a key, and an action number. Returns the appropriate transformation:</p> Action Transformation 1, 2 Raw defs value 3 <code>os.path.basename()</code> of defs value 4 <code>get_ip()</code> DNS lookup on defs value 7 <code>get_env()</code> environment variable lookup on key"},{"location":"architecture/template-engine/#isvarname","title":"isvarname()","text":"<p>Location: <code>utils.py</code>, lines 162-167.</p> <p>Validates that a token looks like a variable name or path. Allows alphanumeric characters, underscores, forward slashes, commas, and colons. Rejects tokens containing spaces. Used by <code>do_substr()</code> to skip tokens that are not valid variable references (except for Actions 6 and 11 which accept expressions).</p>"},{"location":"architecture/template-engine/#insert_list_items","title":"insert_list_items()","text":"<p>Location: <code>utils.py</code>, lines 641-667.</p> <p>Implements the handler side of Action 12. Looks up the token in <code>imager.defs</code>: - If the value is already a list, returns it directly. - If the value is a string, splits on commas and whitespace into a list. - If the token does not exist, returns an empty list.</p>"},{"location":"configuration/credential-setup/","title":"Credential Setup","text":"<p>OSImager needs credentials for two purposes:</p> <ol> <li>OS image credentials \u2014 username/password for SSH or WinRM access during the build, and for setting the root/admin password in kickstart, preseed, and autounattend templates.</li> <li>Platform credentials \u2014 server address, username, and password for remote platforms (vSphere, Proxmox, Azure, GCP, AWS).</li> </ol> <p>Two credential backends are supported: a local secrets file (simplest) or HashiCorp Vault (enterprise).</p>"},{"location":"configuration/credential-setup/#config-mode-local-secrets-file","title":"Config Mode (Local Secrets File)","text":""},{"location":"configuration/credential-setup/#setup","title":"Setup","text":"<pre><code>mkosimage --set credential_source=config\n</code></pre>"},{"location":"configuration/credential-setup/#secrets-file","title":"Secrets File","text":"<p>Create <code>~/.config/osimager/secrets</code> with one entry per line:</p> <pre><code># Format: path key=value key=value ...\n\n# Image credentials (required for all builds)\nimages/linux username=root password=Ch@ng3m3\nimages/windows username=Administrator password=Ch@ng3m3\n\n# vSphere credentials (one entry per location that uses vsphere)\n# For \"mkosimage vsphere/lab/...\" the path is vsphere/lab\nvsphere/lab server=vcenter.example.com username=administrator@vsphere.local password=Ch@ng3m3\nvsphere/esx server=esxhost1.example.com username=root password=Ch@ng3m3\n\n# Proxmox credentials (one entry per location that uses proxmox)\n# For \"mkosimage proxmox/pnet/...\" the path is proxmox/pnet\nproxmox/pnet server=proxmox.example.com username=root@pam password=Ch@ng3m3\n</code></pre> <p>Lines starting with <code>#</code> are comments. Blank lines are ignored.</p>"},{"location":"configuration/credential-setup/#path-structure","title":"Path Structure","text":"<p>There are two types of secret paths:</p> <p><code>images/&lt;os&gt;</code> \u2014 OS credentials referenced by spec files. The <code>&lt;os&gt;</code> name matches what the spec's include chain uses:</p> <ul> <li><code>images/linux</code> \u2014 used by all Linux distributions (RHEL, Debian, Ubuntu, SLES, etc.)</li> <li><code>images/windows</code> \u2014 used by Windows and Windows Server</li> </ul> <p>The username and password are used for:</p> <ul> <li>SSH/WinRM communicator access during the Packer build</li> <li>Setting the root/admin password in installer templates (kickstart <code>rootpw</code>, preseed <code>passwd/root-password</code>, etc.)</li> <li>Password hashes in installer configs via <code>5&gt;images/linux:password&lt;5</code> (SHA256) or <code>6&gt;images/linux:password&lt;6</code> (SHA512)</li> </ul> <p><code>&lt;platform&gt;/&lt;location&gt;</code> \u2014 Platform credentials referenced by platform JSON files. The path matches the <code>platform/location</code> portion of your build target:</p> <pre><code>mkosimage vsphere/lab/rhel-9.5-x86_64\n#         ^^^^^^^^^^\n#         looks up secrets at path: vsphere/lab\n</code></pre>"},{"location":"configuration/credential-setup/#how-secrets-are-referenced","title":"How Secrets Are Referenced","text":"<p>In spec and platform JSON files, secrets are referenced two ways:</p> <p>Template markers (in defs, files, config): <pre><code>|&gt;images/linux:username&lt;|     \u2192 \"root\"\n|&gt;images/linux:password&lt;|     \u2192 \"Ch@ng3m3\"\n6&gt;images/linux:password&lt;6     \u2192 \"$6$salt$hash...\"  (SHA512 hash)\n</code></pre></p> <p>Packer vault syntax (in variables): <pre><code>\"ssh-username\": \"{{vault `images/linux` `username`}}\"\n\"ssh-password\": \"{{vault `images/linux` `password`}}\"\n</code></pre></p> <p>When using config mode, <code>resolve_packer_vault_refs()</code> automatically replaces <code>{{vault ...}}</code> references with values from the secrets file before passing the JSON to Packer.</p>"},{"location":"configuration/credential-setup/#vault-mode-hashicorp-vault","title":"Vault Mode (HashiCorp Vault)","text":""},{"location":"configuration/credential-setup/#setup_1","title":"Setup","text":"<pre><code>mkosimage --set credential_source=vault\nmkosimage --set vault_addr=http://your-vault-server:8200\nmkosimage --set vault_token=your-vault-token\n</code></pre>"},{"location":"configuration/credential-setup/#vault-configuration","title":"Vault Configuration","text":"<p>OSImager uses the KV v2 secrets engine. Enable mount points for each path prefix:</p> <pre><code>vault secrets enable -path=images -version=2 kv\nvault secrets enable -path=vsphere -version=2 kv\nvault secrets enable -path=proxmox -version=2 kv\n</code></pre> <p>Store credentials:</p> <pre><code># Image credentials\nvault kv put images/linux username=root password=Ch@ng3m3\nvault kv put images/windows username=Administrator password=Ch@ng3m3\n\n# vSphere credentials\nvault kv put vsphere/lab server=vcenter.example.com username=administrator@vsphere.local password=Ch@ng3m3\n\n# Proxmox credentials\nvault kv put proxmox/pnet server=proxmox.example.com username=root@pam password=Ch@ng3m3\n</code></pre>"},{"location":"configuration/credential-setup/#how-vault-mode-works","title":"How Vault Mode Works","text":"<ul> <li>OSImager connects using <code>hvac.Client(url=vault_addr, token=vault_token)</code></li> <li>Verifies authentication with <code>vault.is_authenticated()</code></li> <li>Reads secrets via <code>vault.secrets.kv.v2.read_secret_version()</code></li> <li>Packer also accesses Vault directly using the <code>{{vault ...}}</code> template function (VAULT_ADDR and VAULT_TOKEN are passed as environment variables)</li> </ul>"},{"location":"configuration/credential-setup/#per-platform-credential-requirements","title":"Per-Platform Credential Requirements","text":"<p>Each platform that connects to remote infrastructure needs specific credentials:</p>"},{"location":"configuration/credential-setup/#vsphere","title":"vSphere","text":"Key Description <code>server</code> vCenter or ESXi hostname <code>username</code> vSphere username (e.g., <code>administrator@vsphere.local</code>) <code>password</code> vSphere password <p>Secret path: <code>vsphere/&lt;location&gt;</code> (e.g., <code>vsphere/lab</code>)</p>"},{"location":"configuration/credential-setup/#proxmox","title":"Proxmox","text":"Key Description <code>server</code> Proxmox server hostname <code>username</code> Proxmox username (e.g., <code>root@pam</code>) <code>password</code> Proxmox password <p>Secret path: <code>proxmox/&lt;location&gt;</code> (e.g., <code>proxmox/pnet</code>)</p>"},{"location":"configuration/credential-setup/#azure","title":"Azure","text":"Key Description <code>client_id</code> Azure service principal client ID <code>client_secret</code> Azure service principal secret <code>tenant_id</code> Azure AD tenant ID <code>subscription_id</code> Azure subscription ID <code>gallery_subscription_id</code> Shared Image Gallery subscription <code>gallery_resource_group</code> Gallery resource group <code>gallery_name</code> Gallery name <code>bastion_hostname</code> Bastion host for SSH tunneling <code>bastion_username</code> Bastion username <code>bastion_keyfile</code> Bastion SSH key file path <p>Secret path: <code>azure/&lt;location&gt;</code></p>"},{"location":"configuration/credential-setup/#gcp","title":"GCP","text":"Key Description <code>credentials_json</code> Service account JSON key <code>project_id</code> GCP project ID <code>service_account_email</code> Service account email <code>bastion_hostname</code> Bastion host for SSH tunneling <code>bastion_username</code> Bastion username <code>bastion_password</code> Bastion password <p>Secret path: <code>gcp/&lt;location&gt;</code></p>"},{"location":"configuration/credential-setup/#aws","title":"AWS","text":"Key Description <code>access_key</code> AWS access key ID <code>secret_key</code> AWS secret access key <p>Secret path: <code>aws/&lt;location&gt;</code></p>"},{"location":"configuration/credential-setup/#local-platforms","title":"Local Platforms","text":"<p>VirtualBox, VMware, QEMU, libvirt, Hyper-V, and XenServer run locally and do not require platform credentials. They only need the <code>images/&lt;os&gt;</code> credentials for SSH/WinRM access during the build.</p>"},{"location":"configuration/credential-setup/#the-get_secret-method","title":"The <code>get_secret()</code> Method","text":"<p>The <code>get_secret(string)</code> method is the unified interface for credential retrieval. It accepts a <code>path:key</code> format:</p> <ul> <li><code>images/linux:username</code> \u2192 returns the username value</li> <li><code>images/linux:password</code> \u2192 returns the password value</li> <li><code>vsphere/lab:server</code> \u2192 returns the vSphere server address</li> </ul> <p>The method dispatches based on <code>credential_source</code>:</p> <ul> <li>config mode: looks up <code>self.secrets[path][key]</code></li> <li>vault mode: calls <code>vault.secrets.kv.v2.read_secret_version()</code> with the appropriate mount point and path</li> </ul>"},{"location":"configuration/credential-setup/#switching-between-modes","title":"Switching Between Modes","text":"<pre><code># Switch to config mode\nmkosimage --set credential_source=config\n\n# Switch to vault mode\nmkosimage --set credential_source=vault\nmkosimage --set vault_addr=http://vault:8200\nmkosimage --set vault_token=s.xxxxxxxx\n</code></pre> <p>Settings are persisted in <code>~/.config/osimager/osimager.conf</code>.</p>"},{"location":"configuration/location-setup/","title":"Location Setup","text":"<p>A location defines your build environment \u2014 the network settings, DNS servers, storage paths, and platform-specific infrastructure details that OSImager needs to build images in your environment.</p>"},{"location":"configuration/location-setup/#file-location","title":"File Location","text":"<p>Location files live in <code>~/.config/osimager/locations/</code> and support both TOML and JSON formats:</p> <pre><code>~/.config/osimager/locations/\n\u251c\u2500\u2500 lab.toml        # Your lab environment\n\u251c\u2500\u2500 prod.json       # Production vSphere\n\u2514\u2500\u2500 cloud.toml      # Cloud platforms\n</code></pre> <p>If both <code>lab.toml</code> and <code>lab.json</code> exist, JSON takes priority.</p> <p>The location name used in the build target matches the filename (without extension):</p> <pre><code>mkosimage vsphere/lab/rhel-9.5-x86_64\n#                  ^^^\n#                  loads ~/.config/osimager/locations/lab.toml (or .json)\n</code></pre>"},{"location":"configuration/location-setup/#location-file-structure","title":"Location File Structure","text":""},{"location":"configuration/location-setup/#minimal-example-virtualbox","title":"Minimal Example (VirtualBox)","text":"TOMLJSON <pre><code>platforms = [\"virtualbox\"]\n\n[defs]\ndomain = \"home.local\"\ngateway = \"192.168.1.1\"\ncidr = \"192.168.1.0/24\"\nvms_path = \"/vms\"\niso_path = \"/iso\"\n\n[defs.dns]\nservers = [\"192.168.1.1\"]\n\n[defs.ntp]\nservers = [\"pool.ntp.org\"]\n</code></pre> <pre><code>{\n  \"platforms\": [\"virtualbox\"],\n  \"defs\": {\n    \"domain\": \"home.local\",\n    \"gateway\": \"192.168.1.1\",\n    \"cidr\": \"192.168.1.0/24\",\n    \"vms_path\": \"/vms\",\n    \"iso_path\": \"/iso\",\n    \"dns\": {\n      \"servers\": [\"192.168.1.1\"]\n    },\n    \"ntp\": {\n      \"servers\": [\"pool.ntp.org\"]\n    }\n  }\n}\n</code></pre>"},{"location":"configuration/location-setup/#field-reference","title":"Field Reference","text":""},{"location":"configuration/location-setup/#top-level-fields","title":"Top-Level Fields","text":"Field Type Required Description <code>platforms</code> array Yes Platform names this location supports (e.g., <code>[\"virtualbox\", \"vmware\", \"vsphere\"]</code>) <code>defs</code> dict Yes Variable definitions used in template substitution <code>platform_specific</code> array No Per-platform overrides (see below)"},{"location":"configuration/location-setup/#defs-fields","title":"Defs Fields","text":"Field Type Description <code>domain</code> string DNS domain suffix for FQDNs (e.g., <code>lab.example.com</code>) <code>gateway</code> string Network gateway IP. Auto-calculated from <code>cidr</code> if not provided. <code>cidr</code> string Network in CIDR notation (e.g., <code>192.168.1.0/24</code>). Auto-derives <code>subnet</code>, <code>prefix</code>, and <code>netmask</code>. <code>vms_path</code> string Base directory for built VM output <code>iso_path</code> string Directory containing OS installation ISOs"},{"location":"configuration/location-setup/#network-auto-derivation","title":"Network Auto-Derivation","text":"<p>When you set <code>cidr</code>, OSImager automatically computes:</p> <ul> <li><code>subnet</code> \u2014 network address (e.g., <code>192.168.1.0</code>)</li> <li><code>prefix</code> \u2014 CIDR prefix length (e.g., <code>24</code>)</li> <li><code>netmask</code> \u2014 dotted decimal netmask (e.g., <code>255.255.255.0</code>)</li> <li><code>gateway</code> \u2014 if not explicitly set, calculated as the second-to-last address in the subnet</li> </ul> <p>These derived values are available as defs for template substitution in specs and platform configs.</p>"},{"location":"configuration/location-setup/#dns-configuration","title":"DNS Configuration","text":"<pre><code>[defs.dns]\nservers = [\"192.168.1.1\", \"8.8.8.8\"]\nsearch = [\"lab.example.com\", \"example.com\"]\n</code></pre> <p>DNS servers are expanded into numbered defs: <code>dns1</code>, <code>dns2</code>, etc. The search domains are joined into a space-separated <code>dns_search</code> string. These are used in kickstart, preseed, and cloud-init templates.</p>"},{"location":"configuration/location-setup/#ntp-configuration","title":"NTP Configuration","text":"<pre><code>[defs.ntp]\nservers = [\"pool.ntp.org\", \"time.example.com\"]\n</code></pre> <p>NTP servers are expanded into numbered defs: <code>ntp1</code>, <code>ntp2</code>, etc. Used in installer templates for time synchronization.</p>"},{"location":"configuration/location-setup/#platform-specific-overrides","title":"Platform-Specific Overrides","text":"<p>Locations that support multiple platforms can provide per-platform defs using <code>platform_specific</code> sections. These override the base defs when building for that platform.</p> TOMLJSON <pre><code>platforms = [\"virtualbox\", \"vmware\", \"vsphere\", \"proxmox\"]\n\n[defs]\ndomain = \"lab.example.com\"\ngateway = \"10.0.1.1\"\ncidr = \"10.0.1.0/24\"\nvms_path = \"/vms\"\niso_path = \"/iso\"\n\n[defs.dns]\nservers = [\"10.0.1.1\"]\n\n[defs.ntp]\nservers = [\"pool.ntp.org\"]\n\n# vSphere-specific settings\n[[platform_specific]]\nplatform = \"vsphere\"\n\n[platform_specific.defs]\ndatacenter = \"dc1\"\ncluster = \"cluster1\"\nesxi_host = \"esxi1.lab.example.com\"\ndatastore = \"datastore1\"\nfolder = \"templates\"\nvm_network = \"VM Network\"\n\n# Proxmox-specific settings\n[[platform_specific]]\nplatform = \"proxmox\"\n\n[platform_specific.defs]\nproxmox_node = \"pve1\"\niso_storage_pool = \"local\"\nvm_storage_pool = \"local-lvm\"\n</code></pre> <pre><code>{\n  \"platforms\": [\"virtualbox\", \"vmware\", \"vsphere\", \"proxmox\"],\n  \"defs\": {\n    \"domain\": \"lab.example.com\",\n    \"gateway\": \"10.0.1.1\",\n    \"cidr\": \"10.0.1.0/24\",\n    \"vms_path\": \"/vms\",\n    \"iso_path\": \"/iso\",\n    \"dns\": { \"servers\": [\"10.0.1.1\"] },\n    \"ntp\": { \"servers\": [\"pool.ntp.org\"] }\n  },\n  \"platform_specific\": [\n    {\n      \"platform\": \"vsphere\",\n      \"defs\": {\n        \"datacenter\": \"dc1\",\n        \"cluster\": \"cluster1\",\n        \"esxi_host\": \"esxi1.lab.example.com\",\n        \"datastore\": \"datastore1\",\n        \"folder\": \"templates\",\n        \"vm_network\": \"VM Network\"\n      }\n    },\n    {\n      \"platform\": \"proxmox\",\n      \"defs\": {\n        \"proxmox_node\": \"pve1\",\n        \"iso_storage_pool\": \"local\",\n        \"vm_storage_pool\": \"local-lvm\"\n      }\n    }\n  ]\n}\n</code></pre>"},{"location":"configuration/location-setup/#platform-specific-defs-by-platform","title":"Platform-Specific Defs by Platform","text":"<p>Each platform has different infrastructure requirements. See the Platform Reference for complete details.</p> <p>Local ISO platforms (virtualbox, vmware, qemu, libvirt, hyperv, xenserver):</p> <ul> <li><code>vms_path</code> \u2014 where to store built VMs</li> <li><code>iso_path</code> \u2014 where ISO files are located</li> </ul> <p>vSphere:</p> <ul> <li><code>datacenter</code> \u2014 vSphere datacenter name</li> <li><code>esxi_host</code> \u2014 target ESXi host</li> <li><code>cluster</code> \u2014 cluster name</li> <li><code>datastore</code> \u2014 datastore for VM storage</li> <li><code>folder</code> \u2014 template folder in vCenter</li> <li><code>vm_network</code> \u2014 network name for the VM (default: <code>VM Network</code>)</li> </ul> <p>Proxmox:</p> <ul> <li><code>proxmox_node</code> \u2014 Proxmox node name</li> <li><code>iso_storage_pool</code> \u2014 storage pool for ISOs</li> <li><code>vm_storage_pool</code> \u2014 storage pool for VMs</li> </ul> <p>Azure:</p> <ul> <li><code>azure_location</code> \u2014 Azure region</li> <li><code>azure_resource_group</code> \u2014 resource group name</li> </ul> <p>GCP:</p> <ul> <li><code>gcp_region</code> \u2014 GCP region</li> <li><code>gcp_zone</code> \u2014 GCP zone</li> </ul> <p>AWS:</p> <ul> <li><code>aws_region</code> \u2014 AWS region</li> <li><code>aws_vpc_id</code> \u2014 VPC ID</li> <li><code>aws_subnet_id</code> \u2014 Subnet ID</li> </ul>"},{"location":"configuration/location-setup/#how-defs-flow-into-the-build","title":"How Defs Flow Into the Build","text":"<p>Location defs are one layer in the hierarchical merge chain:</p> <pre><code>all.json defaults\n    \u2514\u2500\u2500 Platform JSON defs\n        \u2514\u2500\u2500 Location defs          &lt;\u2500\u2500 you are here\n            \u2514\u2500\u2500 Location platform_specific defs\n                \u2514\u2500\u2500 Spec defs\n                    \u2514\u2500\u2500 Specific section overrides (recursive)\n                        \u2514\u2500\u2500 CLI --define overrides\n</code></pre> <p>Later layers override earlier ones. For example, if the platform sets <code>boot_disk_size: 16385</code> and your location sets <code>boot_disk_size: 40960</code>, the location value wins.</p>"},{"location":"configuration/location-setup/#custom-defs","title":"Custom Defs","text":"<p>You can add any custom defs to your location. They become available for template substitution in specs and platform configs using the <code>&gt;&gt;key&lt;&lt;</code> syntax. This is useful for site-specific values that specs reference.</p>"},{"location":"configuration/location-setup/#verifying-your-location","title":"Verifying Your Location","text":"<p>Use <code>--defs</code> to see the fully-resolved defs dictionary for a build:</p> <pre><code>mkosimage -x virtualbox/local/alma-9.5-x86_64\n</code></pre> <p>This shows every def value after all layers are merged, including auto-derived values like <code>subnet</code>, <code>prefix</code>, <code>netmask</code>, <code>dns1</code>, <code>ntp1</code>, etc.</p>"},{"location":"reference/cli-reference/","title":"CLI Reference","text":"<p>OSImager provides three command-line tools installed as console scripts via pip.</p>"},{"location":"reference/cli-reference/#mkosimage","title":"mkosimage","text":"<p>The primary build command. Assembles a Packer build configuration from platform, location, and spec files, then executes it.</p>"},{"location":"reference/cli-reference/#synopsis","title":"Synopsis","text":"<pre><code>mkosimage [OPTIONS] PLATFORM/LOCATION/SPEC [NAME] [IP]\n</code></pre>"},{"location":"reference/cli-reference/#positional-arguments","title":"Positional Arguments","text":"Argument Required Description <code>PLATFORM/LOCATION/SPEC</code> Yes (for builds) Target triple specifying the platform, location, and spec to build. Example: <code>vmware/lab/rhel-9.5-x86_64</code> <code>NAME</code> No Hostname for the built VM. Defaults to the spec name if omitted. <code>IP</code> No Static IP address for the built VM. If omitted, OSImager attempts DNS resolution of the hostname."},{"location":"reference/cli-reference/#options","title":"Options","text":""},{"location":"reference/cli-reference/#general","title":"General","text":"Flag Long Form Description <code>-V</code> <code>--version</code> Print the OSImager version and exit. <code>-l</code> <code>--list</code> List all available specs. Specs with a local ISO in your <code>iso_path</code> are marked with <code>*</code>. <code>-a</code> <code>--avail</code> List only specs that have a matching local ISO present. <code>--list-platforms</code> List all available platforms with their Packer builder type and supported architectures. <code>--list-defs</code> List all available defs (template variables) with their default values and sources. Shows base defaults, platform defs, and computed defs. <code>-d</code> <code>--debug</code> Enable debug output. Prints internal variable resolution, file loading paths, and Packer debug flag. <code>-v</code> <code>--verbose</code> Enable verbose output. Prints loaded settings, file paths, and environment variables as they are set. <code>-c</code> <code>--config</code> Path to the osimager.conf configuration file. Default: <code>osimager.conf</code> (resolved in <code>~/.config/osimager/</code>)."},{"location":"reference/cli-reference/#build-control","title":"Build Control","text":"Flag Long Form Description <code>-n</code> <code>--dry</code> Dry run. Builds the full Packer JSON configuration but does not execute <code>packer build</code>. Prints the command that would be run. <code>-f</code> Force rebuild. Passes <code>-force</code> to Packer, which causes it to delete and re-create any existing output artifacts. <code>-k</code> Keep temp files and VMs on error. Sets Packer's <code>-on-error=abort</code> so the VM is not destroyed if the build fails, allowing inspection. <code>-e</code> <code>--on_error</code> Set Packer's on-error behavior explicitly. Valid values: <code>cleanup</code> (default Packer behavior), <code>abort</code>, <code>ask</code>. Overrides <code>-k</code>. <code>-t</code> Enable Packer's timestamp UI (<code>-timestamp-ui</code>), which prefixes each output line with a timestamp. <code>--local-only</code> Restrict builds to local ISOs only. Specs without a matching local ISO will fail instead of attempting a download. This setting is persisted to <code>osimager.conf</code>. <code>-m</code> <code>--temp</code> Specify a custom temp directory for build artifacts. By default, OSImager creates a temporary directory in <code>/tmp</code> and cleans it up after the build (unless <code>-k</code> is set)."},{"location":"reference/cli-reference/#output-and-debugging","title":"Output and Debugging","text":"Flag Long Form Description <code>-x</code> <code>--defs</code> Dump the fully resolved defs dictionary and exit. Shows all merged variables from platform, location, and spec configs after template substitution. <code>-u</code> <code>--dump</code> Dump the complete Packer build JSON and exit. Useful for inspecting the exact configuration that would be sent to Packer. <code>-L</code> Enable Packer logging. Sets the <code>PACKER_LOG=1</code> environment variable. <code>-N</code> <code>--logfile</code> Path for Packer log output. Sets <code>PACKER_LOG_PATH</code> to this value. Only meaningful when <code>-L</code> is also set."},{"location":"reference/cli-reference/#customization","title":"Customization","text":"Flag Long Form Description <code>-F</code> <code>--fqdn</code> Override the auto-generated FQDN. By default, OSImager constructs the FQDN from the hostname and the location's <code>domain</code> setting. <code>-D</code> <code>--define</code> Define custom defs as a comma-separated list of <code>KEY=VALUE</code> pairs. These override any values from platform, location, or spec configs."},{"location":"reference/cli-reference/#persistent-settings","title":"Persistent Settings","text":"Flag Description <code>--set KEY=VALUE</code> Set a persistent configuration value in <code>~/.config/osimager/osimager.conf</code>. Can be specified multiple times. Only saves if the value actually changes. <p>The following keys are accepted by <code>--set</code>:</p> Key Default Description <code>credential_source</code> <code>vault</code> Credential backend: <code>vault</code> (HashiCorp Vault) or <code>config</code> (local secrets file). <code>vault_addr</code> (empty) HashiCorp Vault server URL (e.g. <code>http://vault.example.com:8200</code>). <code>vault_token</code> (empty) HashiCorp Vault access token. <code>packer_cmd</code> <code>packer</code> Path to the Packer binary. <code>packer_cache_dir</code> <code>/tmp</code> Directory for Packer's ISO download cache. <code>local_only</code> <code>False</code> When <code>True</code>, only use local ISOs; never attempt downloads. <code>data_dir</code> <code>data</code> Path to the OSImager data directory (relative to package or absolute). <code>save_index</code> <code>False</code> When <code>True</code>, cache the spec index to <code>~/.config/osimager/specs/index.json</code>. <code>ansible_playbook</code> <code>config.yml</code> Name of the Ansible playbook used during provisioning."},{"location":"reference/cli-reference/#rfosimage","title":"rfosimage","text":"<p>Re-provisions an existing VM using Ansible without rebuilding from an ISO. Replaces the Packer builder with a <code>null</code> builder, keeping only the communicator configuration and provisioners.</p>"},{"location":"reference/cli-reference/#synopsis_1","title":"Synopsis","text":"<pre><code>rfosimage [OPTIONS] PLATFORM/LOCATION/SPEC [NAME] [IP]\n</code></pre>"},{"location":"reference/cli-reference/#how-it-differs-from-mkosimage","title":"How It Differs from mkosimage","text":"<p><code>rfosimage</code> runs the same configuration merge pipeline as <code>mkosimage</code> (platform + location + spec), but before executing Packer it:</p> <ol> <li>Removes any <code>files</code> section from the spec (no file generation needed).</li> <li>Extracts the communicator type and settings (e.g. SSH host, user, password) from the original builder.</li> <li>Replaces the builder with a Packer <code>null</code> builder that only connects to the target via the communicator.</li> <li>Runs the provisioners (typically Ansible) against the existing VM.</li> </ol> <p>This means the VM must already exist and be reachable at the specified hostname/IP.</p>"},{"location":"reference/cli-reference/#when-to-use","title":"When to Use","text":"<ul> <li>Re-running Ansible provisioning after changing a spec's Ansible playbook or roles.</li> <li>Applying configuration updates to an already-built VM.</li> <li>Testing Ansible provisioner changes without waiting for a full OS install.</li> </ul>"},{"location":"reference/cli-reference/#arguments-and-options","title":"Arguments and Options","text":"<p><code>rfosimage</code> accepts the same positional arguments and options as <code>mkosimage</code>. The <code>NAME</code> and <code>IP</code> arguments are typically required since the target VM must be reachable.</p> <p>Note</p> <p>The target VM must be running and accessible via the communicator (SSH or WinRM) defined in the platform config. If the VM was built with <code>mkosimage</code>, the same credentials configured in your secrets will be used.</p>"},{"location":"reference/cli-reference/#mkvenv","title":"mkvenv","text":"<p>Creates a Python virtual environment for Ansible version pinning. Some older OS distributions require specific Ansible versions that differ from what is installed system-wide.</p>"},{"location":"reference/cli-reference/#synopsis_2","title":"Synopsis","text":"<pre><code>mkvenv [OPTIONS]\n</code></pre>"},{"location":"reference/cli-reference/#purpose","title":"Purpose","text":"<p>Certain specs include a <code>venv</code> key that references a named virtual environment. When <code>mkosimage</code> encounters a spec with a <code>venv</code> value, it activates that virtual environment before running Packer, ensuring the correct Ansible version is on the <code>PATH</code>.</p> <p><code>mkvenv</code> creates and configures these virtual environments in the venv directory (<code>~/.venv/</code> by default).</p>"},{"location":"reference/cli-reference/#options_1","title":"Options","text":"<p><code>mkvenv</code> accepts the base options shared with all OSImager commands:</p> Flag Long Form Description <code>-V</code> <code>--version</code> Print the OSImager version and exit. <code>-l</code> <code>--list</code> List available specs. <code>-a</code> <code>--avail</code> List only specs with local ISOs. <code>-d</code> <code>--debug</code> Enable debug output. <code>-v</code> <code>--verbose</code> Enable verbose output. <code>-c</code> <code>--config</code> Path to osimager.conf. <code>--set KEY=VALUE</code> Set a persistent configuration value."},{"location":"reference/cli-reference/#examples","title":"Examples","text":""},{"location":"reference/cli-reference/#listing","title":"Listing","text":"<pre><code># List all available specs (* marks those with local ISOs)\nmkosimage --list\n\n# List only specs with local ISOs\nmkosimage --avail\n\n# List all available platforms with builder type and architectures\nmkosimage --list-platforms\n\n# List all available defs with defaults and sources\nmkosimage --list-defs\n</code></pre>"},{"location":"reference/cli-reference/#building-images","title":"Building Images","text":"<pre><code># Build with VirtualBox (hostname defaults to spec name, IP via DNS)\nmkosimage virtualbox/local/alma-9.5-x86_64\n\n# Build with explicit hostname and IP\nmkosimage vmware/lab/rhel-9.5-x86_64 myhost 192.168.1.100\n\n# Build with a custom FQDN\nmkosimage -F myhost.custom.domain vmware/lab/rhel-9.5-x86_64 myhost 192.168.1.100\n\n# Force rebuild, deleting any existing artifacts\nmkosimage -f vmware/lab/rhel-9.5-x86_64 myhost\n</code></pre>"},{"location":"reference/cli-reference/#debugging-and-inspection","title":"Debugging and Inspection","text":"<pre><code># Dry run -- show the Packer command without executing it\nmkosimage -n vmware/lab/rhel-9.5-x86_64 myhost 192.168.1.100\n\n# Dump the resolved defs dictionary\nmkosimage -x vmware/lab/rhel-9.5-x86_64 myhost 192.168.1.100\n\n# Dump the Packer build JSON\nmkosimage -u vmware/lab/rhel-9.5-x86_64 myhost 192.168.1.100\n\n# Enable verbose and debug output together\nmkosimage -v -d vmware/lab/rhel-9.5-x86_64 myhost 192.168.1.100\n</code></pre>"},{"location":"reference/cli-reference/#overriding-defs","title":"Overriding Defs","text":"<pre><code># Override memory and CPU settings\nmkosimage -D memory=4096,cpu_cores=4 vmware/lab/rhel-9.5-x86_64\n\n# Override multiple values for a custom build\nmkosimage -D memory=8192,cpu_cores=8,disk_size=51200 vmware/lab/rhel-9.5-x86_64 bighost\n</code></pre>"},{"location":"reference/cli-reference/#packer-logging","title":"Packer Logging","text":"<pre><code># Enable Packer logging to a file\nmkosimage -L -N /tmp/packer.log vmware/lab/rhel-9.5-x86_64 myhost\n\n# Keep VM on error for inspection\nmkosimage -k vmware/lab/rhel-9.5-x86_64 myhost 192.168.1.100\n\n# Explicit on-error behavior\nmkosimage -e ask vmware/lab/rhel-9.5-x86_64 myhost 192.168.1.100\n</code></pre>"},{"location":"reference/cli-reference/#re-provisioning","title":"Re-provisioning","text":"<pre><code># Re-run Ansible provisioning on an existing VM\nrfosimage vmware/lab/rhel-9.5-x86_64 myhost 192.168.1.100\n\n# Dry run re-provisioning to see what would execute\nrfosimage -n vmware/lab/rhel-9.5-x86_64 myhost 192.168.1.100\n</code></pre>"},{"location":"reference/cli-reference/#persistent-configuration","title":"Persistent Configuration","text":"<pre><code># Switch to local secrets file mode\nmkosimage --set credential_source=config\n\n# Configure Vault\nmkosimage --set vault_addr=http://vault.example.com:8200\nmkosimage --set vault_token=hvs.your-token-here\n\n# Use a custom Packer binary\nmkosimage --set packer_cmd=/usr/local/bin/packer\n\n# Restrict to local ISOs only\nmkosimage --set local_only=True\n</code></pre>"},{"location":"reference/cli-reference/#exit-codes","title":"Exit Codes","text":"Code Constant Meaning 0 <code>EXIT_SUCCESS</code> Command completed successfully. 1 <code>EXIT_GENERAL_ERROR</code> General error (build failure, missing spec, invalid arguments). 2 <code>EXIT_MISUSE</code> Command misuse (invalid argument combinations). 3 <code>EXIT_CONFIG_ERROR</code> Configuration error (missing or invalid config files). 4 <code>EXIT_NETWORK_ERROR</code> Network error (DNS resolution failure, unreachable host). 5 <code>EXIT_PERMISSION_ERROR</code> Permission error (insufficient access to files or directories)."},{"location":"reference/cli-reference/#configuration-file","title":"Configuration File","text":"<p>All three commands read settings from <code>~/.config/osimager/osimager.conf</code>, an INI-format file with an <code>[osimager]</code> section:</p> <pre><code>[osimager]\ncredential_source = config\npacker_cmd = packer\npacker_cache_dir = /tmp\nlocal_only = False\ndata_dir = data\nsave_index = False\nansible_playbook = config.yml\n</code></pre> <p>Settings are loaded in this order (later overrides earlier):</p> <ol> <li>Built-in defaults in the OSImager source.</li> <li>Values from <code>~/.config/osimager/osimager.conf</code>.</li> <li>Command-line <code>--set</code> overrides (which also persist back to the conf file).</li> <li>Command-line flags (e.g. <code>--local-only</code>, <code>-d</code>, <code>-v</code>).</li> </ol>"},{"location":"reference/defs-reference/","title":"Defs Reference","text":"<p>This page is auto-generated from the platform and spec data files. It documents all template variables (defs) used by each platform.</p>"},{"location":"reference/defs-reference/#base-defaults-alljson","title":"Base Defaults (all.json)","text":"<p>These defaults are inherited by all platforms:</p> Variable Default Value <code>boot_disk_size</code> <code>16385</code> <code>cpu_cores</code> <code>2</code> <code>cpu_sockets</code> <code>1</code> <code>memory</code> <code>2048</code>"},{"location":"reference/defs-reference/#local-iso-platforms","title":"Local ISO Platforms","text":""},{"location":"reference/defs-reference/#virtualbox","title":"virtualbox","text":"<p>Builder type: <code>virtualbox-iso</code></p> <p>Platform defs:</p> Variable Value <code>local</code> <code>True</code> <p>Template variables referenced (<code>&gt;&gt;var&lt;&lt;</code>):</p> <ul> <li><code>cd_label</code> \u2014 spec</li> <li><code>firmware</code> \u2014 computed</li> <li><code>iso_checksum</code> \u2014 spec</li> <li><code>iso_name</code> \u2014 spec</li> <li><code>iso_path</code> \u2014 location</li> <li><code>iso_url</code> \u2014 spec</li> <li><code>local_only</code> \u2014 computed</li> <li><code>name</code> \u2014 computed</li> <li><code>vms_path</code> \u2014 location</li> </ul> <p>Value replacements (<code>%&gt;var&lt;%</code>):</p> <ul> <li><code>cd_files</code></li> </ul> <p>Numeric expressions (<code>#&gt;expr&lt;#</code>):</p> <ul> <li><code>boot_disk_size</code></li> <li><code>cpu_sockets*cpu_cores</code></li> <li><code>memory</code></li> </ul> <p>Eval expressions (<code>E&gt;expr&lt;E</code>):</p> <ul> <li><code>'' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;'</code></li> <li><code>'&gt;&gt;iso_checksum&lt;&lt;' if len('&gt;&gt;iso_checksum&lt;&lt;') else 'none'</code></li> <li><code>'&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_url&lt;&lt;'</code></li> </ul>"},{"location":"reference/defs-reference/#vmware","title":"vmware","text":"<p>Builder type: <code>vmware-iso</code></p> <p>Platform defs:</p> Variable Value <code>local</code> <code>True</code> <p>Template variables referenced (<code>&gt;&gt;var&lt;&lt;</code>):</p> <ul> <li><code>cd_label</code> \u2014 spec</li> <li><code>firmware</code> \u2014 computed</li> <li><code>iso_checksum</code> \u2014 spec</li> <li><code>iso_name</code> \u2014 spec</li> <li><code>iso_path</code> \u2014 location</li> <li><code>iso_url</code> \u2014 spec</li> <li><code>local_only</code> \u2014 computed</li> <li><code>name</code> \u2014 computed</li> <li><code>vms_path</code> \u2014 location</li> </ul> <p>Value replacements (<code>%&gt;var&lt;%</code>):</p> <ul> <li><code>cd_files</code></li> </ul> <p>Numeric expressions (<code>#&gt;expr&lt;#</code>):</p> <ul> <li><code>boot_disk_size</code></li> <li><code>cpu_cores</code></li> <li><code>cpu_sockets*cpu_cores</code></li> <li><code>memory</code></li> </ul> <p>Eval expressions (<code>E&gt;expr&lt;E</code>):</p> <ul> <li><code>'' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;'</code></li> <li><code>'&gt;&gt;iso_checksum&lt;&lt;' if len('&gt;&gt;iso_checksum&lt;&lt;') else 'none'</code></li> <li><code>'&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_url&lt;&lt;'</code></li> </ul>"},{"location":"reference/defs-reference/#qemu","title":"qemu","text":"<p>Builder type: <code>qemu</code></p> <p>Template variables referenced (<code>&gt;&gt;var&lt;&lt;</code>):</p> <ul> <li><code>boot_disk_size</code> \u2014 all.json default</li> <li><code>firmware</code> \u2014 computed</li> <li><code>iso_checksum</code> \u2014 spec</li> <li><code>iso_name</code> \u2014 spec</li> <li><code>iso_path</code> \u2014 location</li> <li><code>iso_url</code> \u2014 spec</li> <li><code>local_only</code> \u2014 computed</li> <li><code>name</code> \u2014 computed</li> <li><code>vms_path</code> \u2014 location</li> </ul> <p>Numeric expressions (<code>#&gt;expr&lt;#</code>):</p> <ul> <li><code>cpu_cores</code></li> <li><code>cpu_sockets</code></li> <li><code>memory</code></li> </ul> <p>Eval expressions (<code>E&gt;expr&lt;E</code>):</p> <ul> <li><code>'' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;'</code></li> <li><code>'&gt;&gt;iso_checksum&lt;&lt;' if len('&gt;&gt;iso_checksum&lt;&lt;') else 'none'</code></li> <li><code>'&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_url&lt;&lt;'</code></li> </ul>"},{"location":"reference/defs-reference/#libvirt","title":"libvirt","text":"<p>Builder type: <code>qemu</code></p> <p>Platform defs:</p> Variable Value <code>local</code> <code>True</code> <p>Template variables referenced (<code>&gt;&gt;var&lt;&lt;</code>):</p> <ul> <li><code>boot_disk_size</code> \u2014 all.json default</li> <li><code>cd_label</code> \u2014 spec</li> <li><code>firmware</code> \u2014 computed</li> <li><code>iso_checksum</code> \u2014 spec</li> <li><code>iso_name</code> \u2014 spec</li> <li><code>iso_path</code> \u2014 location</li> <li><code>iso_url</code> \u2014 spec</li> <li><code>local_only</code> \u2014 computed</li> <li><code>name</code> \u2014 computed</li> <li><code>vms_path</code> \u2014 location</li> </ul> <p>Value replacements (<code>%&gt;var&lt;%</code>):</p> <ul> <li><code>cd_files</code></li> </ul> <p>Numeric expressions (<code>#&gt;expr&lt;#</code>):</p> <ul> <li><code>cpu_cores</code></li> <li><code>cpu_sockets</code></li> <li><code>memory</code></li> </ul> <p>Eval expressions (<code>E&gt;expr&lt;E</code>):</p> <ul> <li><code>'' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;'</code></li> <li><code>'&gt;&gt;iso_checksum&lt;&lt;' if len('&gt;&gt;iso_checksum&lt;&lt;') else 'none'</code></li> <li><code>'&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_url&lt;&lt;'</code></li> </ul>"},{"location":"reference/defs-reference/#hyperv","title":"hyperv","text":"<p>Builder type: <code>hyperv-iso</code></p> <p>Platform defs:</p> Variable Value <code>hyperv_generation</code> <code>2</code> <code>local</code> <code>True</code> <code>switch_name</code> <code>Default Switch</code> <p>Template variables referenced (<code>&gt;&gt;var&lt;&lt;</code>):</p> <ul> <li><code>cd_label</code> \u2014 spec</li> <li><code>iso_checksum</code> \u2014 spec</li> <li><code>iso_name</code> \u2014 spec</li> <li><code>iso_path</code> \u2014 location</li> <li><code>iso_url</code> \u2014 spec</li> <li><code>local_only</code> \u2014 computed</li> <li><code>name</code> \u2014 computed</li> <li><code>switch_name</code> \u2014 computed</li> <li><code>vms_path</code> \u2014 location</li> </ul> <p>Value replacements (<code>%&gt;var&lt;%</code>):</p> <ul> <li><code>cd_files</code></li> </ul> <p>Numeric expressions (<code>#&gt;expr&lt;#</code>):</p> <ul> <li><code>boot_disk_size</code></li> <li><code>cpu_sockets*cpu_cores</code></li> <li><code>hyperv_generation</code></li> <li><code>memory</code></li> </ul> <p>Eval expressions (<code>E&gt;expr&lt;E</code>):</p> <ul> <li><code>'' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;'</code></li> <li><code>'&gt;&gt;iso_checksum&lt;&lt;' if len('&gt;&gt;iso_checksum&lt;&lt;') else 'none'</code></li> <li><code>'&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_url&lt;&lt;'</code></li> </ul>"},{"location":"reference/defs-reference/#xenserver","title":"xenserver","text":"<p>Builder type: <code>xenserver-iso</code></p> <p>Platform defs:</p> Variable Value <code>local</code> <code>True</code> <p>Template variables referenced (<code>&gt;&gt;var&lt;&lt;</code>):</p> <ul> <li><code>cd_label</code> \u2014 spec</li> <li><code>iso_checksum</code> \u2014 spec</li> <li><code>iso_name</code> \u2014 spec</li> <li><code>iso_path</code> \u2014 location</li> <li><code>iso_url</code> \u2014 spec</li> <li><code>local_only</code> \u2014 computed</li> <li><code>name</code> \u2014 computed</li> <li><code>vms_path</code> \u2014 location</li> </ul> <p>Value replacements (<code>%&gt;var&lt;%</code>):</p> <ul> <li><code>cd_files</code></li> </ul> <p>Numeric expressions (<code>#&gt;expr&lt;#</code>):</p> <ul> <li><code>boot_disk_size</code></li> <li><code>cpu_sockets*cpu_cores</code></li> <li><code>memory</code></li> </ul> <p>Eval expressions (<code>E&gt;expr&lt;E</code>):</p> <ul> <li><code>'' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;'</code></li> <li><code>'&gt;&gt;iso_checksum&lt;&lt;' if len('&gt;&gt;iso_checksum&lt;&lt;') else 'none'</code></li> <li><code>'&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_url&lt;&lt;'</code></li> </ul>"},{"location":"reference/defs-reference/#enterprise-platforms","title":"Enterprise Platforms","text":""},{"location":"reference/defs-reference/#vsphere","title":"vsphere","text":"<p>Builder type: <code>vsphere-iso</code></p> <p>Platform defs:</p> Variable Value <code>thin_disk</code> <code>False</code> <code>vm_network</code> <code>VM Network</code> <p>Template variables referenced (<code>&gt;&gt;var&lt;&lt;</code>):</p> <ul> <li><code>cd_label</code> \u2014 spec</li> <li><code>cluster</code> \u2014 location</li> <li><code>datacenter</code> \u2014 location</li> <li><code>datastore</code> \u2014 location</li> <li><code>esxi_host</code> \u2014 location</li> <li><code>firmware</code> \u2014 computed</li> <li><code>folder</code> \u2014 location</li> <li><code>iso_checksum</code> \u2014 spec</li> <li><code>iso_name</code> \u2014 spec</li> <li><code>iso_path</code> \u2014 location</li> <li><code>iso_url</code> \u2014 spec</li> <li><code>local_only</code> \u2014 computed</li> <li><code>location_name</code> \u2014 computed</li> <li><code>name</code> \u2014 computed</li> <li><code>spec_name</code> \u2014 spec</li> <li><code>vm_network</code> \u2014 location</li> </ul> <p>Value replacements (<code>%&gt;var&lt;%</code>):</p> <ul> <li><code>cd_files</code></li> <li><code>thin_disk</code></li> </ul> <p>Numeric expressions (<code>#&gt;expr&lt;#</code>):</p> <ul> <li><code>boot_disk_size</code></li> <li><code>cpu_sockets*cpu_cores</code></li> <li><code>memory</code></li> </ul> <p>Eval expressions (<code>E&gt;expr&lt;E</code>):</p> <ul> <li><code>'&gt;&gt;iso_checksum&lt;&lt;' if len('&gt;&gt;iso_checksum&lt;&lt;') else 'none'</code></li> <li><code>'&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_url&lt;&lt;'</code></li> <li><code>'windows' if '&gt;&gt;spec_name&lt;&lt;'.startswith('win') else 'linux'</code></li> </ul> <p>Vault/credential variables:</p> Variable Vault Path <code>vsphere-password</code> <code>vsphere/&gt;&gt;location_name&lt;&lt;:password</code> <code>vsphere-server</code> <code>vsphere/&gt;&gt;location_name&lt;&lt;:server</code> <code>vsphere-username</code> <code>vsphere/&gt;&gt;location_name&lt;&lt;:username</code>"},{"location":"reference/defs-reference/#proxmox","title":"proxmox","text":"<p>Builder type: <code>proxmox-iso</code></p> <p>Platform defs:</p> Variable Value <code>shutcmd</code> <code>False</code> <p>Template variables referenced (<code>&gt;&gt;var&lt;&lt;</code>):</p> <ul> <li><code>boot_disk_size</code> \u2014 all.json default</li> <li><code>cd_label</code> \u2014 spec</li> <li><code>iso_checksum</code> \u2014 spec</li> <li><code>iso_name</code> \u2014 spec</li> <li><code>iso_path</code> \u2014 location</li> <li><code>iso_storage_pool</code> \u2014 location</li> <li><code>iso_url</code> \u2014 spec</li> <li><code>local_only</code> \u2014 computed</li> <li><code>location_name</code> \u2014 computed</li> <li><code>name</code> \u2014 computed</li> <li><code>proxmox_node</code> \u2014 location</li> <li><code>vm_storage_pool</code> \u2014 location</li> </ul> <p>Value replacements (<code>%&gt;var&lt;%</code>):</p> <ul> <li><code>cd_files</code></li> </ul> <p>Numeric expressions (<code>#&gt;expr&lt;#</code>):</p> <ul> <li><code>cpu_cores</code></li> <li><code>cpu_sockets</code></li> <li><code>memory</code></li> </ul> <p>Eval expressions (<code>E&gt;expr&lt;E</code>):</p> <ul> <li><code>'' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;'</code></li> <li><code>'&gt;&gt;iso_checksum&lt;&lt;' if len('&gt;&gt;iso_checksum&lt;&lt;') else 'none'</code></li> <li><code>'false' if &gt;&gt;local_only&lt;&lt; else 'true'</code></li> <li><code>'local:iso/&gt;&gt;iso_name&lt;&lt;' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_url&lt;&lt;'</code></li> </ul> <p>Vault/credential variables:</p> Variable Vault Path <code>name</code> <code>{{ build_name }}</code> <code>proxmox-password</code> <code>proxmox/&gt;&gt;location_name&lt;&lt;:password</code> <code>proxmox-server</code> <code>proxmox/&gt;&gt;location_name&lt;&lt;:server</code> <code>proxmox-username</code> <code>proxmox/&gt;&gt;location_name&lt;&lt;:username</code>"},{"location":"reference/defs-reference/#cloud-platforms","title":"Cloud Platforms","text":""},{"location":"reference/defs-reference/#azure","title":"azure","text":"<p>Builder type: <code>azure-arm</code></p> <p>Platform defs:</p> Variable Value <code>boot</code> <code>False</code> <code>image_version</code> <code>latest</code> <code>shutcmd</code> <code>False</code> <code>vm_size</code> <code>Standard_D2s_v3</code> <p>Template variables referenced (<code>&gt;&gt;var&lt;&lt;</code>):</p> <ul> <li><code>azure_image_offer</code> \u2014 spec</li> <li><code>azure_image_publisher</code> \u2014 spec</li> <li><code>azure_image_sku</code> \u2014 spec</li> <li><code>azure_location</code> \u2014 location</li> <li><code>azure_resource_group</code> \u2014 location</li> <li><code>image_version</code> \u2014 computed</li> <li><code>location_name</code> \u2014 computed</li> <li><code>name</code> \u2014 computed</li> <li><code>spec_name</code> \u2014 spec</li> <li><code>vm_size</code> \u2014 computed</li> </ul> <p>Value replacements (<code>%&gt;var&lt;%</code>):</p> <ul> <li><code>azure_replication_regions</code></li> </ul> <p>Eval expressions (<code>E&gt;expr&lt;E</code>):</p> <ul> <li><code>'Windows' if '&gt;&gt;spec_name&lt;&lt;'.startswith('win') else 'Linux'</code></li> </ul> <p>Vault/credential variables:</p> Variable Vault Path <code>az-bastion-hostname</code> <code>azure/&gt;&gt;location_name&lt;&lt;:bastion_hostname</code> <code>az-bastion-keyfile</code> <code>azure/&gt;&gt;location_name&lt;&lt;:bastion_keyfile</code> <code>az-bastion-username</code> <code>azure/&gt;&gt;location_name&lt;&lt;:bastion_username</code> <code>client-id</code> <code>azure/&gt;&gt;location_name&lt;&lt;:client_id</code> <code>client-secret</code> <code>azure/&gt;&gt;location_name&lt;&lt;:client_secret</code> <code>gallery-name</code> <code>azure/&gt;&gt;location_name&lt;&lt;:gallery_name</code> <code>gallery-resource-group</code> <code>azure/&gt;&gt;location_name&lt;&lt;:gallery_resource_group</code> <code>gallery-subscription-id</code> <code>azure/&gt;&gt;location_name&lt;&lt;:gallery_subscription_id</code> <code>subscription-id</code> <code>azure/&gt;&gt;location_name&lt;&lt;:subscription_id</code> <code>tenant-id</code> <code>azure/&gt;&gt;location_name&lt;&lt;:tenant_id</code>"},{"location":"reference/defs-reference/#gcp","title":"gcp","text":"<p>Builder type: <code>googlecompute</code></p> <p>Platform defs:</p> Variable Value <code>boot</code> <code>False</code> <code>disk_type</code> <code>pd-ssd</code> <code>machine_type</code> <code>n1-standard-2</code> <code>shutcmd</code> <code>False</code> <code>state_timeout</code> <code>15m</code> <p>Template variables referenced (<code>&gt;&gt;var&lt;&lt;</code>):</p> <ul> <li><code>disk_type</code> \u2014 computed</li> <li><code>gcp_image_family</code> \u2014 spec</li> <li><code>gcp_region</code> \u2014 location</li> <li><code>gcp_source_image_family</code> \u2014 spec</li> <li><code>gcp_source_image_project_id</code> \u2014 spec</li> <li><code>gcp_zone</code> \u2014 location</li> <li><code>location_name</code> \u2014 computed</li> <li><code>machine_type</code> \u2014 computed</li> <li><code>name</code> \u2014 computed</li> <li><code>state_timeout</code> \u2014 computed</li> </ul> <p>Vault/credential variables:</p> Variable Vault Path <code>gcp-bastion-hostname</code> <code>gcp/&gt;&gt;location_name&lt;&lt;:bastion_hostname</code> <code>gcp-bastion-password</code> <code>gcp/&gt;&gt;location_name&lt;&lt;:bastion_password</code> <code>gcp-bastion-username</code> <code>gcp/&gt;&gt;location_name&lt;&lt;:bastion_username</code> <code>gcp-creds</code> <code>gcp/&gt;&gt;location_name&lt;&lt;:credentials_json</code> <code>project-id</code> <code>gcp/&gt;&gt;location_name&lt;&lt;:project_id</code> <code>service-account-email</code> <code>gcp/&gt;&gt;location_name&lt;&lt;:service_account_email</code>"},{"location":"reference/defs-reference/#aws","title":"aws","text":"<p>Builder type: <code>amazon-ebs</code></p> <p>Platform defs:</p> Variable Value <code>boot</code> <code>False</code> <code>instance_type</code> <code>t3.medium</code> <code>shutcmd</code> <code>False</code> <p>Template variables referenced (<code>&gt;&gt;var&lt;&lt;</code>):</p> <ul> <li><code>aws_ami_filter_name</code> \u2014 spec</li> <li><code>aws_region</code> \u2014 location</li> <li><code>aws_subnet_id</code> \u2014 location</li> <li><code>aws_vpc_id</code> \u2014 location</li> <li><code>instance_type</code> \u2014 computed</li> <li><code>location_name</code> \u2014 computed</li> <li><code>name</code> \u2014 computed</li> </ul> <p>Value replacements (<code>%&gt;var&lt;%</code>):</p> <ul> <li><code>aws_ami_owners</code></li> </ul> <p>Vault/credential variables:</p> Variable Vault Path <code>aws-access-key</code> <code>aws/&gt;&gt;location_name&lt;&lt;:access_key</code> <code>aws-secret-key</code> <code>aws/&gt;&gt;location_name&lt;&lt;:secret_key</code>"},{"location":"reference/defs-reference/#special-platforms","title":"Special Platforms","text":""},{"location":"reference/defs-reference/#none","title":"none","text":"<p>Builder type: <code>null</code></p> <p>Platform defs:</p> Variable Value <code>boot</code> <code>False</code> <code>shutcmd</code> <code>False</code>"},{"location":"reference/defs-reference/#computed-defs","title":"Computed Defs","text":"<p>These defs are computed during the build pipeline and are available for template substitution:</p> Variable Source Description <code>name</code> CLI or spec VM/image name (hostname or spec name) <code>fqdn</code> Computed Fully qualified domain name (name + domain) <code>ip</code> CLI or DNS IP address (from CLI arg or DNS lookup) <code>platform</code> CLI Platform name from target <code>location</code> CLI Location name from target <code>dist</code> Spec provides Distribution name <code>version</code> Spec provides Full version string <code>major</code> Computed Major version number <code>minor</code> Computed Minor version number <code>arch</code> Spec provides Architecture (x86_64, aarch64, etc.) <code>firmware</code> Location or default Firmware type (bios or efi) <code>base_path</code> Settings OSImager package base directory <code>data_path</code> Settings Data directory path <code>user_dir</code> Settings User config directory (~/.config/osimager) <code>temp_dir</code> Computed Temporary build directory <code>spec_dir</code> Computed Spec data directory path <code>spec_name</code> Computed Spec identifier (dist-version-arch) <code>platform_name</code> CLI Platform name <code>location_name</code> CLI Location name <code>platform_type</code> Platform config Packer builder type <code>subnet</code> Computed Subnet from CIDR <code>prefix</code> Computed Network prefix from CIDR <code>netmask</code> Computed Netmask from CIDR prefix <code>gateway</code> Location or CIDR Gateway address <code>dns1</code> Location DNS Primary DNS server <code>dns2</code> Location DNS Secondary DNS server <code>dns_search</code> Location DNS DNS search domain <code>ntp1</code> Location NTP Primary NTP server <code>iso_url</code> Spec or local ISO download URL <code>iso_name</code> Computed ISO filename <code>iso_checksum</code> Computed ISO checksum value <code>local_only</code> Settings Whether to use local ISOs only"},{"location":"reference/platform-reference/","title":"Platform Reference","text":"<p>OSImager supports 13 platforms through Packer builder plugins. Each platform is defined by a JSON configuration file in <code>osimager/data/platforms/</code> that specifies the Packer builder type, hardware defaults, credential requirements, and template variables.</p>"},{"location":"reference/platform-reference/#overview","title":"Overview","text":"<p>Platforms fall into four categories based on how they build images:</p> Category Platforms Boot Method Where It Builds Local ISO virtualbox, vmware, qemu, libvirt, hyperv, xenserver Boots from ISO Local workstation Enterprise ISO vsphere, proxmox Boots from ISO Remote hypervisor Cloud azure, gcp, aws Marketplace image (no ISO) Cloud provider Special none N/A Provisioning only <p>Local ISO platforms boot a VM from an ISO on the local machine, run the installer via boot commands, then provision over SSH/WinRM. The built VM stays registered on the local hypervisor.</p> <p>Enterprise ISO platforms boot a VM from an ISO on a remote hypervisor (vCenter/ESXi or Proxmox VE), run the same installer flow, and store the resulting VM or template on the remote infrastructure. They require platform credentials (server, username, password) stored in your secrets or Vault.</p> <p>Cloud platforms do not use ISOs or boot commands. They launch a marketplace base image, provision it over SSH through a bastion host, then capture the result as a managed image or AMI. They require cloud provider credentials (service principal, access keys, etc.).</p> <p>Special -- the <code>none</code> platform uses Packer's null builder. It does not create a VM at all. It exists for running provisioners against an existing host.</p>"},{"location":"reference/platform-reference/#base-defaults-alljson","title":"Base Defaults (all.json)","text":"<p>Every platform (except <code>none</code>) includes <code>all.json</code> via the <code>\"include\": \"all\"</code> directive. This establishes the baseline hardware defaults that all platforms inherit:</p> <pre><code>{\n  \"defs\": {\n    \"cpu_sockets\": 1,\n    \"cpu_cores\": 2,\n    \"memory\": 2048,\n    \"boot_disk_size\": 16385\n  }\n}\n</code></pre> Default Value Description <code>cpu_sockets</code> <code>1</code> Number of CPU sockets <code>cpu_cores</code> <code>2</code> Number of cores per socket <code>memory</code> <code>2048</code> Memory in MB <code>boot_disk_size</code> <code>16385</code> Boot disk size in MB (~16 GB) <p>These can be overridden at any layer: platform JSON, location defs, spec defs, or CLI <code>--define</code>.</p>"},{"location":"reference/platform-reference/#template-variable-syntax","title":"Template Variable Syntax","text":"<p>Platform JSON files use OSImager's template engine markers. The most common patterns found in platform configs:</p> Marker Type Example Description <code>&gt;&gt;var&lt;&lt;</code> String substitution <code>&gt;&gt;name&lt;&lt;</code> Replaced with the value of <code>var</code> from defs <code>#&gt;expr&lt;#</code> Numeric expression <code>#&gt;cpu_sockets*cpu_cores&lt;#</code> Evaluates arithmetic on defs values, returns int <code>%&gt;var&lt;%</code> Value replacement <code>%&gt;cd_files&lt;%</code> Replaced with raw value (preserves type: list, bool, etc.) <code>E&gt;expr&lt;E</code> Python eval <code>E&gt;'text' if &gt;&gt;cond&lt;&lt; else 'other'&lt;E</code> Evaluates a Python expression after <code>&gt;&gt;var&lt;&lt;</code> substitution <p>See the Template Engine documentation for the complete reference.</p>"},{"location":"reference/platform-reference/#local-iso-platforms","title":"Local ISO Platforms","text":"<p>Local ISO platforms run a hypervisor on the build machine, boot a VM from an ISO, and use Packer boot commands to drive the unattended installer. They define <code>local: true</code> in defs and store built VMs under <code>&gt;&gt;vms_path&lt;&lt;/&lt;platform&gt;/&gt;&gt;name&lt;&lt;</code>.</p>"},{"location":"reference/platform-reference/#common-traits","title":"Common Traits","text":"<p>All local ISO platforms share these characteristics:</p> <ul> <li>Include: <code>all.json</code> (inherits base hardware defaults)</li> <li>Defs: <code>local: true</code></li> <li>Boot method: ISO boot with <code>boot_command</code> from spec</li> <li>Credentials: No platform credentials required (only <code>images/&lt;os&gt;</code> for SSH/WinRM)</li> <li>Location defs needed: <code>vms_path</code>, <code>iso_path</code></li> <li>ISO handling: Conditional expression selects local path or download URL based on <code>local_only</code></li> </ul> <p>The common ISO URL pattern used across local platforms:</p> <pre><code>\"iso_url\": \"E&gt;'&gt;&gt;iso_path&lt;&lt;/&gt;&gt;iso_name&lt;&lt;' if &gt;&gt;local_only&lt;&lt; else '&gt;&gt;iso_url&lt;&lt;'&lt;E\"\n</code></pre> <p>This evaluates to the local ISO path when <code>local_only</code> is true, or the remote download URL otherwise.</p>"},{"location":"reference/platform-reference/#virtualbox","title":"VirtualBox","text":"Platform file <code>platforms/virtualbox.json</code> Packer builder type <code>virtualbox-iso</code> Packer plugin <code>github.com/hashicorp/virtualbox</code> Platform type Local ISO Architectures i386, x86_64 <p>Plugin install: <pre><code>packer plugins install github.com/hashicorp/virtualbox\n</code></pre></p>"},{"location":"reference/platform-reference/#defs","title":"Defs","text":"Def Value Description <code>local</code> <code>true</code> Marks this as a local platform <p>Plus inherited from <code>all.json</code>: <code>cpu_sockets</code>, <code>cpu_cores</code>, <code>memory</code>, <code>boot_disk_size</code>.</p>"},{"location":"reference/platform-reference/#config-keys","title":"Config Keys","text":"Key Value Description <code>type</code> <code>virtualbox-iso</code> Packer builder type <code>vm_name</code> <code>&gt;&gt;name&lt;&lt;</code> VM name from build spec <code>output_directory</code> <code>&gt;&gt;vms_path&lt;&lt;/vbox/&gt;&gt;name&lt;&lt;</code> Output path for VM files <code>headless</code> <code>true</code> Run without GUI <code>skip_export</code> <code>true</code> Do not export to OVA <code>keep_registered</code> <code>true</code> Keep VM in VirtualBox after build <code>disable_shutdown</code> <code>false</code> Allow graceful shutdown <code>guest_additions_mode</code> <code>disable</code> Do not install guest additions <code>cpus</code> <code>#&gt;cpu_sockets*cpu_cores&lt;#</code> Total vCPU count <code>memory</code> <code>#&gt;memory&lt;#</code> Memory in MB <code>firmware</code> <code>&gt;&gt;firmware&lt;&lt;</code> BIOS or EFI <code>gfx_controller</code> <code>vmsvga</code> Graphics controller type <code>gfx_vram_size</code> <code>32</code> Video memory in MB <code>usb</code> <code>true</code> Enable USB controller <code>iso_url</code> (conditional expression) ISO source path or URL <code>iso_checksum</code> (conditional expression) ISO checksum or <code>none</code> <code>iso_target_path</code> (conditional expression) Local download target <code>cd_files</code> <code>%&gt;cd_files&lt;%</code> Files to include on CD <code>cd_label</code> <code>&gt;&gt;cd_label&lt;&lt;</code> CD volume label <code>hard_drive_discard</code> <code>true</code> Enable TRIM/discard <code>hard_drive_nonrotational</code> <code>true</code> Advertise as SSD <code>hard_drive_interface</code> <code>virtio</code> Disk bus type <code>disk_size</code> <code>#&gt;boot_disk_size&lt;#</code> Disk size in MB <code>skip_nat_mapping</code> <code>true</code> Do not set up NAT port forwarding"},{"location":"reference/platform-reference/#vboxmanage-commands","title":"VBoxManage Commands","text":"<p>VirtualBox uses post-create <code>vboxmanage</code> commands to configure VM settings that cannot be set through the builder directly:</p> <ol> <li>movevm -- Moves the VM to `&gt;&gt;vms_path&lt;</li> </ol>"},{"location":"reference/spec-reference/","title":"Spec Reference","text":"<p>Spec files are JSON documents that define everything OSImager needs to build an OS image: the distribution, versions, architectures, installer files, boot commands, provisioners, and platform-specific configuration. They live in <code>osimager/data/specs/&lt;name&gt;/spec.json</code>.</p>"},{"location":"reference/spec-reference/#spec-file-anatomy","title":"Spec File Anatomy","text":"<p>Every top-level key that can appear in a spec JSON file:</p> Key Type Description <code>provides</code> object What the spec produces: <code>dist</code>, <code>versions</code>, and <code>arches</code> <code>include</code> string or list Inheritance chain -- references to other spec(s) to load first <code>method</code> string <code>\"merge\"</code> (default) or <code>\"replace\"</code> -- controls how this spec's data merges with inherited data <code>merge</code> list Key names within dict sections that should be deep-merged instead of overwritten <code>flavor</code> string OS family: <code>\"linux\"</code>, <code>\"unix\"</code>, or <code>\"windows\"</code> <code>platforms</code> array Which platforms this spec supports (e.g., <code>[\"virtualbox\", \"vmware\", \"vsphere\"]</code>) <code>locations</code> array Optional filter restricting which locations can use this spec <code>install_notice</code> array Informational messages displayed before build <code>defs</code> object Definition variables available for template substitution <code>config</code> object Packer builder configuration (boot_command, shutdown_command, firmware, etc.) <code>variables</code> object Packer user variables passed to the build <code>evars</code> object Environment variables set during the build <code>files</code> array Installer file generation recipes -- each entry has <code>sources</code> (array of file paths concatenated) and <code>dest</code> (output filename) <code>pre_provisioners</code> array Packer provisioners that run before the main Ansible provisioner <code>provisioners</code> array Main Packer provisioners (default: Ansible playbook) <code>post_provisioners</code> array Packer provisioners that run after the main provisioner <code>venv</code> string Python virtual environment name (for older distros needing legacy Ansible) <code>required_files</code> array Files that must exist before build starts, with download instructions <code>platform_specific</code> array Conditional overrides matched against the target platform <code>location_specific</code> array Conditional overrides matched against the target location <code>dist_specific</code> array Conditional overrides matched against the distribution name <code>version_specific</code> array Conditional overrides matched against the version string <code>arch_specific</code> array Conditional overrides matched against the architecture <code>firmware_specific</code> array Conditional overrides matched against the firmware type (bios/efi)"},{"location":"reference/spec-reference/#the-provides-object","title":"The <code>provides</code> Object","text":"<pre><code>{\n  \"provides\": {\n    \"dist\": \"rhel\",\n    \"versions\": [\n      \"8.[0,1,2,3,5,6,7,8,9,10]\",\n      \"9.[0-7]\",\n      \"10.[0-1]\"\n    ],\n    \"arches\": [\n      \"x86_64\",\n      \"aarch64\"\n    ]\n  }\n}\n</code></pre> <ul> <li><code>dist</code> -- The distribution identifier used in build targets (e.g., <code>rhel</code>, <code>alma</code>, <code>debian</code>).</li> <li><code>versions</code> -- Array of version strings, supporting range expansion syntax (see Version Expansion Syntax).</li> <li><code>arches</code> -- Array of supported architectures. Common values: <code>i386</code>, <code>x86_64</code>, <code>aarch64</code>.</li> </ul>"},{"location":"reference/spec-reference/#the-files-array","title":"The <code>files</code> Array","text":"<p>Each entry in <code>files</code> concatenates multiple source files into a single output file used during installation:</p> <pre><code>{\n  \"files\": [\n    {\n      \"sources\": [\n        \"rhel/kickstart_&gt;&gt;major&lt;&lt;.cfg\",\n        \"rhel/ks-part.sh\",\n        \"rhel/kickstart_end.cfg\",\n        \"rhel/kickstart_post.cfg\",\n        \"rhel/install_vmwtools.sh\",\n        \"rhel/kickstart_end.cfg\"\n      ],\n      \"dest\": \"ks.cfg\"\n    }\n  ]\n}\n</code></pre> <p>Source paths are relative to <code>osimager/data/files/</code>. Template substitution is applied to both source paths and file contents.</p>"},{"location":"reference/spec-reference/#the-required_files-array","title":"The <code>required_files</code> Array","text":"<p>Declares files that must be present before a build can start. If missing, OSImager prints download instructions and exits:</p> <pre><code>{\n  \"required_files\": [\n    {\n      \"file\": \"esxi/esx-tools-for-esxi-9.7.2-0.0.5911061.i386.vib\",\n      \"description\": \"VMware Tools VIB required for ESXi 5.x/6.x installation\",\n      \"url\": \"https://my.vmware.com/group/vmware/downloads/details?downloadGroup=ESXI55U3\",\n      \"location\": \"esxi/\"\n    }\n  ]\n}\n</code></pre>"},{"location":"reference/spec-reference/#inheritance-system","title":"Inheritance System","text":"<p>Specs use the <code>include</code> key to form inheritance chains. When a spec includes another, the parent spec is loaded first, then the child's data is merged on top. This allows distribution-specific specs to share common configuration from base specs.</p>"},{"location":"reference/spec-reference/#inheritance-chains","title":"Inheritance Chains","text":"<pre><code>alma -----&gt; rhel -----&gt; linux -----&gt; ssh\nrocky ----&gt; rhel -----&gt; linux -----&gt; ssh\ncentos ---&gt; rhel -----&gt; linux -----&gt; ssh\noel ------&gt; rhel -----&gt; linux -----&gt; ssh\ndebian ---&gt; linux ----&gt; ssh\nubuntu ---&gt; linux ----&gt; ssh\nsles -----&gt; linux ----&gt; ssh\nwindows-server -&gt; windows -&gt; winrm\nesxi        (standalone -- no includes)\nsysvr4      (standalone -- no includes)\n</code></pre>"},{"location":"reference/spec-reference/#what-each-base-level-contributes","title":"What Each Base Level Contributes","text":""},{"location":"reference/spec-reference/#ssh-ssh-communicator-base","title":"<code>ssh</code> -- SSH Communicator Base","text":"<p>The lowest-level base for all Linux/Unix specs. Configures the Packer SSH communicator:</p> <ul> <li><code>config.communicator</code> = <code>\"ssh\"</code></li> <li><code>config.ssh_username</code> / <code>config.ssh_password</code> via Packer user variables</li> <li><code>config.ssh_timeout</code> = <code>\"25m\"</code></li> <li>Dynamic <code>ssh_host</code> and <code>ssh_port</code> using Python eval expressions that adapt to the platform type</li> </ul>"},{"location":"reference/spec-reference/#winrm-winrm-communicator-base","title":"<code>winrm</code> -- WinRM Communicator Base","text":"<p>The lowest-level base for all Windows specs. Configures the Packer WinRM communicator:</p> <ul> <li><code>config.communicator</code> = <code>\"winrm\"</code></li> <li><code>config.winrm_username</code> / <code>config.winrm_password</code> via Packer user variables</li> <li><code>config.winrm_timeout</code> = <code>\"4h\"</code></li> <li>Dynamic <code>winrm_host</code> based on platform type</li> </ul>"},{"location":"reference/spec-reference/#linux-linux-base","title":"<code>linux</code> -- Linux Base","text":"<p>Inherits from <code>ssh</code>. Adds Linux-specific defaults:</p> <ul> <li><code>defs.boot_disk_size</code> = <code>16384</code> (16 GB)</li> <li><code>variables.ssh-username</code> and <code>variables.ssh-password</code> referencing the <code>images/linux</code> vault path</li> </ul>"},{"location":"reference/spec-reference/#windows-windows-base","title":"<code>windows</code> -- Windows Base","text":"<p>Inherits from <code>winrm</code>. Adds Windows-specific defaults:</p> <ul> <li><code>defs.boot_disk_size</code> = <code>131072</code> (128 GB)</li> <li><code>variables.winrm-username</code> and <code>variables.winrm-password</code> referencing the <code>images/windows</code> vault path</li> </ul>"},{"location":"reference/spec-reference/#merge-behavior","title":"Merge Behavior","text":"<p>The <code>method</code> key controls how inherited data combines:</p> <ul> <li><code>\"merge\"</code> (default) -- Dictionaries are merged key-by-key (<code>update()</code>). Lists are appended to.</li> <li><code>\"replace\"</code> -- Lists are cleared before new items are added. Dictionaries still merge.</li> </ul> <p>The <code>merge</code> key within dict sections (like <code>config</code>) lists keys that should be deep-merged rather than overwritten:</p> <pre><code>{\n  \"config\": {\n    \"merge\": [\"vmx_data\"],\n    \"vmx_data\": {\n      \"scsi0.virtualdev\": \"pvscsi\"\n    }\n  }\n}\n</code></pre> <p>In this example, the <code>vmx_data</code> dictionary is merged into any existing <code>vmx_data</code> from the parent spec rather than replacing it entirely.</p>"},{"location":"reference/spec-reference/#load-order","title":"Load Order","text":"<p>The loading process in <code>core.py</code> follows this sequence:</p> <ol> <li>Platform file is loaded first</li> <li>Location file is loaded second</li> <li>Spec file is loaded third, which recursively loads its <code>include</code> chain (deepest parent first)</li> <li>At each level, after loading data, all six <code>*_specific</code> sections are evaluated against the current build context</li> </ol>"},{"location":"reference/spec-reference/#the-6-specific-section-types","title":"The 6 Specific Section Types","text":"<p>Specific sections provide conditional overrides. Each entry in a specific section has a name field that is matched using <code>re.fullmatch()</code> with <code>re.IGNORECASE</code> against the current build value.</p> Section Match Key Matched Against Example Pattern <code>platform_specific</code> <code>platform</code> Target platform name <code>\"vsphere\"</code>, <code>\"proxmox\"</code> <code>location_specific</code> <code>location</code> Target location name <code>\"datacenter1\"</code>, <code>\"lab.*\"</code> <code>dist_specific</code> <code>dist</code> Distribution name <code>\"rhel\"</code>, <code>\"alma\\|rocky\"</code> <code>version_specific</code> <code>version</code> Full version string <code>\"9.*\"</code>, <code>\"[23].*\"</code>, <code>\"8.10\"</code> <code>arch_specific</code> <code>arch</code> Architecture string <code>\"x86_64\"</code>, <code>\"i386\"</code> <code>firmware_specific</code> <code>firmware</code> Firmware type <code>\"efi\"</code>, <code>\"bios\"</code>"},{"location":"reference/spec-reference/#processing-order","title":"Processing Order","text":"<p>The six specific types are always processed in this fixed order:</p> <ol> <li><code>platform_specific</code></li> <li><code>location_specific</code></li> <li><code>dist_specific</code></li> <li><code>version_specific</code></li> <li><code>arch_specific</code></li> <li><code>firmware_specific</code></li> </ol>"},{"location":"reference/spec-reference/#recursive-nesting","title":"Recursive Nesting","text":"<p>Any specific section can contain any other specific section type. This enables precise conditional logic. For example, a <code>version_specific</code> entry can contain <code>platform_specific</code> entries:</p> <pre><code>{\n  \"version_specific\": [\n    {\n      \"version\": \"7.*\",\n      \"arches\": [\"x86_64\"],\n      \"defs\": {\n        \"spec_config\": \"specs/rhel/config_7.yml\"\n      },\n      \"platform_specific\": [\n        {\n          \"platform\": \"virtualbox\",\n          \"config\": {\n            \"guest_os_type\": \"RedHat7_64\"\n          }\n        },\n        {\n          \"platform\": \"vmware\",\n          \"config\": {\n            \"guest_os_type\": \"rhel7-64\"\n          }\n        },\n        {\n          \"platform\": \"vsphere\",\n          \"config\": {\n            \"guest_os_type\": \"rhel7_64Guest\"\n          }\n        }\n      ]\n    }\n  ]\n}\n</code></pre> <p>And a <code>platform_specific</code> entry can contain <code>version_specific</code> entries:</p> <pre><code>{\n  \"platform_specific\": [\n    {\n      \"platform\": \"vsphere\",\n      \"config\": {\n        \"NestedHV\": true\n      },\n      \"version_specific\": [\n        {\n          \"version\": \"7.*\",\n          \"defs\": {\n            \"memory\": 8192,\n            \"firmware\": \"efi\"\n          },\n          \"config\": {\n            \"guest_os_type\": \"vmkernel7Guest\"\n          }\n        }\n      ]\n    }\n  ]\n}\n</code></pre>"},{"location":"reference/spec-reference/#additional-override-keys","title":"Additional Override Keys","text":"<p>Within any specific entry, beyond the standard data keys (<code>defs</code>, <code>config</code>, <code>files</code>, etc.), these override keys can also appear:</p> <ul> <li><code>arches</code> -- Restricts the architectures this entry applies to (narrows the parent spec's <code>provides.arches</code>)</li> <li><code>method</code> -- Can be set to <code>\"replace\"</code> within a specific entry to clear lists before adding new items</li> <li><code>venv</code> -- Overrides the Python virtual environment for that match</li> </ul>"},{"location":"reference/spec-reference/#version-expansion-syntax","title":"Version Expansion Syntax","text":"<p>The <code>provides.versions</code> array supports compact range syntax to define many versions without listing each individually.</p>"},{"location":"reference/spec-reference/#range-expansion-start-end","title":"Range Expansion: <code>[start-end]</code>","text":"<p>Generates all integers from <code>start</code> to <code>end</code> (inclusive):</p> <pre><code>\"versions\": [\"9.[0-7]\"]\n</code></pre> <p>Expands to: <code>9.0</code>, <code>9.1</code>, <code>9.2</code>, <code>9.3</code>, <code>9.4</code>, <code>9.5</code>, <code>9.6</code>, <code>9.7</code></p>"},{"location":"reference/spec-reference/#explicit-list-abc","title":"Explicit List: <code>[a,b,c]</code>","text":"<p>Lists specific values separated by commas:</p> <pre><code>\"versions\": [\"8.[0,1,2,3,5,6,7,8,9,10]\"]\n</code></pre> <p>Expands to: <code>8.0</code>, <code>8.1</code>, <code>8.2</code>, <code>8.3</code>, <code>8.5</code>, <code>8.6</code>, <code>8.7</code>, <code>8.8</code>, <code>8.9</code>, <code>8.10</code></p>"},{"location":"reference/spec-reference/#zero-padded-range-01-03","title":"Zero-Padded Range: <code>[01-03]</code>","text":"<p>Preserves leading zeros in the expansion:</p> <pre><code>\"versions\": [\"12.[01-03]\"]\n</code></pre> <p>Expands to: <code>12.01</code>, <code>12.02</code>, <code>12.03</code></p>"},{"location":"reference/spec-reference/#plain-versions","title":"Plain Versions","text":"<p>Versions without brackets are used as-is:</p> <pre><code>\"versions\": [\"5.5U3\", \"6.0U2\", \"6.5\", \"7.0U3n\", \"8.0U2\"]\n</code></pre> <p>Mixed Syntax Not Supported</p> <p>Combined range and list syntax like <code>[0-3,5-7]</code> is not supported. Use separate entries instead: <pre><code>\"versions\": [\"8.[0-3]\", \"8.[5-7]\"]\n</code></pre></p>"},{"location":"reference/spec-reference/#template-substitution-patterns","title":"Template Substitution Patterns","text":"<p>OSImager uses a marker-based template substitution system. Markers in spec values are replaced at build time with computed values.</p> Syntax Name Description <code>&gt;&gt;key&lt;&lt;</code> Def substitution Replaces marker with the value of <code>defs[key]</code> <code>%&gt;key&lt;%</code> Full-value substitution Replaces the entire JSON value (including quotes) with <code>defs[key]</code> -- allows injecting non-string types <code>+&gt;key&lt;+</code> Basename substitution Replaces marker with the basename (filename only) of <code>defs[key]</code> <code>*&gt;key&lt;*</code> DNS lookup Replaces marker with the IP address from an nslookup of <code>defs[key]</code> <code>\\|&gt;path&lt;\\|</code> Vault secret Replaces marker with a value retrieved from HashiCorp Vault (or local secrets file) <code>#&gt;expr&lt;#</code> Numeric eval Evaluates a numeric expression using def values (e.g., <code>#&gt;memory * 2&lt;#</code>) <code>$&gt;VAR&lt;$</code> Environment variable Replaces marker with the value of environment variable <code>VAR</code> <code>1&gt;path&lt;1</code> MD5 password hash Retrieves a secret and returns its MD5 crypt hash <code>5&gt;path&lt;5</code> SHA-256 password hash Retrieves a secret and returns its SHA-256 crypt hash <code>6&gt;path&lt;6</code> SHA-512 password hash Retrieves a secret and returns its SHA-512 crypt hash <code>E&gt;expr&lt;E</code> Python eval Evaluates a Python expression with access to defs -- used for conditional logic <code>[&gt;key&lt;]</code> List expansion Expands a defs list value inline, inserting each item as a separate element"},{"location":"reference/spec-reference/#common-def-variables","title":"Common Def Variables","text":"<p>These variables are automatically available in <code>defs</code> during a build:</p> Variable Source Example Value <code>platform</code> Target platform <code>vmware</code> <code>platform_name</code> Target platform <code>vmware</code> <code>platform_type</code> Packer builder type <code>vmware-iso</code> <code>location</code> Target location <code>lab</code> <code>location_name</code> Target location <code>lab</code> <code>dist</code> Distribution name <code>rhel</code> <code>version</code> Full version string <code>9.4</code> <code>major</code> Major version number <code>9</code> <code>minor</code> Minor version number <code>4</code> <code>arch</code> Architecture <code>x86_64</code> <code>name</code> Instance name <code>rhel-9.4-x86_64</code> <code>fqdn</code> Fully qualified domain name <code>rhel-9.4-x86_64.lab.local</code> <code>ip</code> Resolved IP address <code>192.168.1.100</code> <code>base_path</code> OSImager base directory <code>/opt/osimager</code> <code>data_path</code> Data directory path <code>/opt/osimager/data</code> <code>spec_dir</code> Directory containing the active spec file <code>/opt/osimager/data/specs/rhel</code> <code>temp_dir</code> Temporary build directory <code>/tmp/tmpXXXXXX</code> <code>user_dir</code> User config directory <code>~/.config/osimager</code> <code>boot_disk_size</code> Boot disk size in MB <code>16384</code> <code>dns1</code>, <code>dns2</code>, ... DNS server addresses <code>192.168.1.1</code> <code>dns_search</code> DNS search domains <code>lab.local</code> <code>ntp1</code>, <code>ntp2</code>, ... NTP server addresses <code>pool.ntp.org</code> <code>subnet</code> Network subnet from CIDR <code>192.168.1.0</code> <code>prefix</code> Network prefix from CIDR <code>24</code> <code>netmask</code> Calculated netmask <code>255.255.255.0</code> <code>gateway</code> / <code>gw</code> Gateway address <code>192.168.1.254</code>"},{"location":"reference/spec-reference/#python-eval-expressions","title":"Python Eval Expressions","text":"<p>The <code>E&gt;...&lt;E</code> syntax allows inline Python expressions with access to all defs as local variables. This is used extensively in spec files for conditional logic:</p> <pre><code>\"ssh_host\": \"E&gt;'&gt;&gt;ip&lt;&lt;' if '&gt;&gt;ip&lt;&lt;' != '' and '&gt;&gt;ip&lt;&lt;' != 'dhcp' else (None if '&gt;&gt;platform_type&lt;&lt;' in ['vsphere-iso', 'amazon-ebs', 'azure-arm', 'googlecompute'] else '{{ .Host }}')&lt;E\"\n</code></pre> <pre><code>\"guest_os_type\": \"RedHat6E&gt;'_64' if '&gt;&gt;arch&lt;&lt;' == 'x86_64' else ''&lt;E\"\n</code></pre> <pre><code>\"deb_arch\": \"E&gt;'amd64' if '&gt;&gt;arch&lt;&lt;' == 'x86_64' else ('arm64' if '&gt;&gt;arch&lt;&lt;' == 'aarch64' else '&gt;&gt;arch&lt;&lt;')&lt;E\"\n</code></pre>"},{"location":"reference/spec-reference/#per-distribution-details","title":"Per-Distribution Details","text":""},{"location":"reference/spec-reference/#rhel-red-hat-enterprise-linux","title":"RHEL (Red Hat Enterprise Linux)","text":"Property Value Dist name <code>rhel</code> Versions 2.1, 3.0, 4.8, 5.[1,9,10,11], 6.[9-10], 7.[5-9], 8.[0,1,2,3,5,6,7,8,9,10], 9.[0-7], 10.[0-1] Architectures i386, x86_64, aarch64 Include chain rhel -&gt; linux -&gt; ssh Installer type Kickstart Platforms virtualbox, vmware, vsphere, proxmox, qemu, libvirt, xenserver, hyperv, azure, gcp, aws, none <p>Cloud support:</p> <ul> <li>Versions 7.x: Azure (RHEL 7lvm-gen2), GCP (rhel-7), AWS (RHEL-7 HVM)</li> <li>Versions 8.x: Azure (RHEL 8-lvm-gen2), GCP (rhel-8), AWS (RHEL-8 HVM)</li> <li>Versions 9.x: Azure (RHEL 9-lvm-gen2), GCP (rhel-9), AWS (RHEL-9 HVM)</li> <li>Versions 10.x: Azure (RHEL 10-lvm-gen2), GCP (rhel-10), AWS (RHEL-10 HVM)</li> </ul> <p>Key version-specific patterns:</p> <ul> <li>Versions 2.x-3.x: i386 only, legacy SSH algorithms, Ansible 2.10 venv, IDE disks, custom <code>configure_system</code> pre-provisioner</li> <li>Versions 4.x: i386/x86_64, legacy SSH, Ansible 2.10 venv, boot via <code>ks=cdrom:/ks.cfg</code></li> <li>Versions 5.x: i386/x86_64, legacy SSH, Ansible 2.10 venv, Python 2 interpreter</li> <li>Versions 6.x: Ansible 2.10 venv, Python 2 interpreter, legacy SSH ciphers</li> <li>Versions 7.x+: x86_64 only, EFI firmware, OEMDRV-based boot</li> <li>Versions 8.x+: x86_64/aarch64, EFI firmware, Python 3 interpreter</li> <li>Versions 9.x+: 4 CPU cores, 4096 MB memory, pvscsi on VMware</li> </ul> <p>Key platform-specific patterns:</p> <ul> <li>Proxmox: firmware set to empty string (uses Proxmox defaults), QEMU agent disabled for legacy versions</li> <li>VirtualBox: version-specific <code>guest_os_type</code> (RedHat7_64, RedHat8_64, RedHat9_64)</li> <li>VMware: version-specific <code>guest_os_type</code>, pvscsi for 9.x+, VMX data merging for legacy VMware tools ISOs</li> <li>vSphere: version-specific <code>guest_os_type</code> (rhel7_64Guest, rhel8_64Guest, rhel9_64Guest)</li> </ul>"},{"location":"reference/spec-reference/#almalinux","title":"AlmaLinux","text":"Property Value Dist name <code>alma</code> Versions 8.[3-10], 9.[0-7], 10.[0-1] Architectures x86_64, aarch64 Include chain alma -&gt; rhel -&gt; linux -&gt; ssh Installer type Kickstart (inherited from RHEL) Platforms Inherited from RHEL: virtualbox, vmware, vsphere, proxmox, qemu, libvirt, xenserver, hyperv, azure, gcp, aws, none <p>Cloud support:</p> <ul> <li>Versions 8.x: Azure (almalinux 8-gen2), GCP (almalinux-8), AWS (AlmaLinux OS 8)</li> <li>Versions 9.x: Azure (almalinux 9-gen2), GCP (almalinux-9), AWS (AlmaLinux OS 9)</li> <li>Versions 10.x: Azure (almalinux 10-gen2), GCP (almalinux-10), AWS (AlmaLinux OS 10)</li> </ul> <p>Uses merge method to overlay AlmaLinux-specific ISO URLs and cloud image references on top of the full RHEL configuration. Version 8.3 is restricted to x86_64 only.</p>"},{"location":"reference/spec-reference/#rocky-linux","title":"Rocky Linux","text":"Property Value Dist name <code>rocky</code> Versions 8.[3-9], 9.[0-7], 10.[0-1] Architectures x86_64, aarch64 Include chain rocky -&gt; rhel -&gt; linux -&gt; ssh Installer type Kickstart (inherited from RHEL) Platforms Inherited from RHEL <p>Cloud support:</p> <ul> <li>Versions 8.x: Azure (rockylinux-x86_64 8-lvm), GCP (rocky-linux-8, rocky-linux-cloud), AWS (Rocky-8-EC2-Base)</li> <li>Versions 9.x: Azure (rockylinux-x86_64 9-lvm), GCP (rocky-linux-9, rocky-linux-cloud), AWS (Rocky-9-EC2-Base)</li> <li>Versions 10.x: Azure (rockylinux-x86_64 10-lvm), GCP (rocky-linux-10, rocky-linux-cloud), AWS (Rocky-10-EC2-Base)</li> </ul> <p>Version 8.x uses a different ISO URL pattern (<code>-dvd1.iso</code> suffix) compared to 9.x/10.x (<code>-dvd.iso</code>).</p>"},{"location":"reference/spec-reference/#centos","title":"CentOS","text":"Property Value Dist name <code>centos</code> Versions 5.[0-10], 6.[0-10], 7.[0-9], 8.[0-5] Architectures i386, x86_64, aarch64 Include chain centos -&gt; rhel -&gt; linux -&gt; ssh Installer type Kickstart (inherited from RHEL) Platforms Inherited from RHEL <p>Cloud support:</p> <ul> <li>Versions 7.x: Azure (CentOS-LVM 7-lvm-gen2), GCP (centos-7, centos-cloud), AWS (CentOS Linux 7)</li> <li>Versions 8.x: Azure (CentOS-LVM 8-lvm-gen2), GCP (centos-stream-8, centos-cloud), AWS (CentOS Stream 8)</li> </ul> <p>Key version-specific patterns:</p> <ul> <li>Versions 5.x: i386/x86_64, ISOs from vault.centos.org</li> <li>Versions 6.x: i386/x86_64, ISOs from vault.centos.org</li> <li>Versions 7.x: x86_64 only, each minor version has a unique ISO naming convention with build date suffixes (e.g., <code>7.0.1406</code>, <code>7.9.2009</code>)</li> <li>Versions 8.x: x86_64/aarch64, ISOs from vault.centos.org with build date suffixes</li> <li>vSphere guest OS types: centos5Guest, centos6Guest, centos7_64Guest, centos8_64Guest</li> </ul>"},{"location":"reference/spec-reference/#oracle-enterprise-linux-oel","title":"Oracle Enterprise Linux (OEL)","text":"Property Value Dist name <code>oel</code> Versions 5.[0-10], 6.[0-10], 7.[0-9], 8.[0-10], 9.[0-7], 10.[0-1] Architectures i386, x86_64, aarch64 Include chain oel -&gt; rhel -&gt; linux -&gt; ssh Installer type Kickstart (inherited from RHEL) Platforms Inherited from RHEL <p>Cloud support:</p> <ul> <li>Versions 7.x: Azure (Oracle-Linux ol79-lvm-gen2), GCP (oracle-linux-7), AWS (OL7 HVM)</li> <li>Versions 8.x: Azure (Oracle-Linux ol89-lvm-gen2), GCP (oracle-linux-8), AWS (OL8 HVM)</li> <li>Versions 9.x: Azure (Oracle-Linux ol9-lvm-gen2), GCP (oracle-linux-9), AWS (OL9 HVM)</li> <li>Versions 10.x: Azure (Oracle-Linux ol10-lvm-gen2), GCP (oracle-linux-10), AWS (OL10 HVM)</li> </ul> <p>Key version-specific patterns:</p> <ul> <li>Versions 5.x/6.x: i386/x86_64, ISOs from yum.oracle.com using <code>u&gt;&gt;minor&lt;&lt;</code> URL pattern</li> <li>Version 6.x: custom kickstart file (<code>oel/kickstart_6.cfg</code>) with OEL-specific post-install</li> <li>Versions 7.x: x86_64 only, OEL-specific vSphere guest types (oracleLinux7_64Guest)</li> <li>Versions 8.x+: x86_64/aarch64</li> <li>VMware guest types use <code>oraclelinux-64</code> (legacy) or <code>oraclelinux8-64</code> / <code>oraclelinux9-64</code> (modern)</li> </ul>"},{"location":"reference/spec-reference/#debian","title":"Debian","text":"Property Value Dist name <code>debian</code> Versions 8.[0-11], 9.[0-13], 10.[0-13], 11.[0-11], 12.[0-13], 13.[0-3] Architectures i386, x86_64, aarch64 Include chain debian -&gt; linux -&gt; ssh Installer type Preseed Platforms virtualbox, vmware, vsphere, proxmox, qemu, libvirt, xenserver, hyperv, azure, gcp, aws, none <p>Cloud support:</p> <ul> <li>Versions 11.x: Azure (debian-11 11-gen2), GCP (debian-11, debian-cloud), AWS (debian-11-amd64)</li> <li>Versions 12.x: Azure (debian-12 12-gen2), GCP (debian-12, debian-cloud), AWS (debian-12-amd64)</li> </ul> <p>Key version-specific patterns:</p> <ul> <li>Versions 8.x: i386/x86_64, uses <code>method: \"replace\"</code> for files with a Debian 8-specific preseed (<code>debian-8-preseed.cfg</code>), custom boot command that mounts and runs <code>debian.fix</code></li> <li>Versions 9.x: i386/x86_64, uses <code>method: \"replace\"</code> for files with <code>debian_pre10.seed</code></li> <li>Versions 10.x+: x86_64/aarch64, uses the standard <code>debian.seed</code> preseed file</li> <li>Architecture mapping: <code>deb_arch</code> def converts <code>x86_64</code> to <code>amd64</code> and <code>aarch64</code> to <code>arm64</code> using a Python eval expression</li> <li>ISO URLs reference <code>cdimage.debian.org/cdimage/archive/</code></li> <li>Boot disk size: 32768 MB (32 GB), overriding the Linux base of 16 GB</li> </ul> <p>Boot process: Uses a multi-step boot command that boots the installer, switches to a virtual console to mount the CD media, then switches back to continue the preseed-driven installation.</p>"},{"location":"reference/spec-reference/#ubuntu","title":"Ubuntu","text":"Property Value Dist name <code>ubuntu</code> Versions 18.04, 20.04, 22.04, 24.04 Architectures x86_64, aarch64 Include chain ubuntu -&gt; linux -&gt; ssh Installer type Preseed (18.04), Cloud-init/Autoinstall (20.04+) Platforms virtualbox, vmware, vsphere, proxmox, qemu, libvirt, xenserver, hyperv, azure, gcp, aws, none <p>Cloud support:</p> <ul> <li>20.04: Azure (ubuntu-server-focal 20_04-lts-gen2), GCP (ubuntu-2004-lts), AWS (ubuntu-focal-20.04)</li> <li>22.04: Azure (ubuntu-server-jammy 22_04-lts-gen2), GCP (ubuntu-2204-lts), AWS (ubuntu-jammy-22.04)</li> <li>24.04: Azure (ubuntu-24_04-lts server), GCP (ubuntu-2404-lts-amd64), AWS (ubuntu-noble-24.04)</li> </ul> <p>Key version-specific patterns:</p> <ul> <li>Version 18.04: x86_64 only, uses legacy preseed installer (<code>ubuntu.seed</code>), <code>method: \"replace\"</code> for files, cd_label is <code>\"media\"</code>, different boot command using <code>/install/vmlinuz</code></li> <li>Versions 20.04+: Uses cloud-init autoinstall (<code>user-data</code> + <code>meta-data</code>), cd_label is <code>\"cidata\"</code>, boot command edits GRUB to add <code>autoinstall</code> parameter</li> <li>Version 20.04: Different boot command using <code>/casper/vmlinuz</code> directly</li> <li>Versions 22.04/24.04: Use the default GRUB-edit boot command</li> <li>Architecture mapping: same <code>deb_arch</code> conversion as Debian</li> <li>Boot disk size: 32768 MB (32 GB)</li> </ul>"},{"location":"reference/spec-reference/#sles-suse-linux-enterprise-server","title":"SLES (SUSE Linux Enterprise Server)","text":"Property Value Dist name <code>sles</code> Versions 12.[1-5], 15.[0-7], 16.[0-0] Architectures x86_64, aarch64 Include chain sles -&gt; linux -&gt; ssh Installer type AutoYaST (XML) Platforms virtualbox, vmware, vsphere, proxmox, qemu, libvirt, xenserver, hyperv, azure, gcp, aws, none <p>Cloud support:</p> <ul> <li>Versions 15.x: Azure (sles-15-spN gen2), GCP (sles-15, suse-cloud), AWS (suse-sles-15-spN)</li> </ul> <p>Key version-specific patterns:</p> <ul> <li>Versions 12.x: x86_64 only, Python 2 interpreter, uses <code>autoinst_12.xml</code>, ISOs from local file paths</li> <li>Versions 15.x: x86_64/aarch64, Python 3 interpreter, uses <code>autoinst_15.xml</code>, cloud image refs with SP (service pack) number in names</li> <li>Versions 16.x: uses <code>autoinst_16.xml</code></li> <li>Version 15.0: Special ISO URL pattern without SP suffix</li> <li>Boot command uses <code>textmode=1</code> and <code>autoyast=device://OEMDRV/autoinst.xml</code></li> <li>Boot disk size: 32768 MB (32 GB)</li> <li>Timezone default: <code>America/Chicago</code></li> </ul> <p>Platform-specific guest OS types:</p> <ul> <li>VirtualBox: <code>OpenSUSE_64</code> (all versions)</li> <li>VMware: <code>sles12-64</code>, <code>sles15-64</code>, <code>sles16-64</code></li> <li>vSphere: <code>sles12_64Guest</code>, <code>sles15_64Guest</code>, <code>sles16_64Guest</code></li> </ul>"},{"location":"reference/spec-reference/#esxi-vmware-esxi","title":"ESXi (VMware ESXi)","text":"Property Value Dist name <code>esxi</code> Versions 5.5U3, 6.0U2, 6.5, 7.0U3n, 8.0U2 Architectures x86_64 Include chain None (standalone) Installer type Kickstart Flavor <code>linux</code> Platforms vmware, vsphere <p>Key version-specific patterns:</p> <ul> <li>Versions 5.x, 6.0, 6.5: Require a VMware Tools VIB file (<code>required_files</code>), included on the CD alongside the kickstart</li> <li>Versions 7.x: No VIB required, 8192 MB memory, EFI firmware on vSphere</li> <li>Versions 8.x: No VIB required, 12288 MB memory, 4 CPU cores, EFI firmware on vSphere</li> <li>Default firmware is <code>bios</code>, overridden per-version on vSphere</li> </ul> <p><code>firmware_specific</code> usage: ESXi uses <code>firmware_specific</code> to change the boot command for EFI builds (shorter boot_wait, no initial Enter keypress).</p> <p>Platform-specific patterns:</p> <ul> <li>vSphere: Enables <code>NestedHV</code> (nested virtualization), version-specific guest types (vmkernel5Guest through vmkernel8Guest), kickstart includes <code>kickstart_post.cfg</code> for post-install on virtual hardware, lsilogic-sas controller for older versions</li> <li>VMware Workstation/Fusion: Sets <code>vmx_data</code> for pvscsi, vmxnet3, VNC, nested HV; older versions override with lsisas1068 SCSI controller</li> </ul>"},{"location":"reference/spec-reference/#sysvr4-system-v-release-4","title":"SysVR4 (System V Release 4)","text":"Property Value Dist name <code>sysvr4</code> Versions 2.1 Architectures i386 Include chain None (standalone) Installer type Manual (with <code>configure_system</code> script) Flavor <code>unix</code> Platforms virtualbox, vmware, proxmox <p>The most minimal spec in the system. Uses a <code>configure_system</code> script uploaded via <code>pre_provisioners</code> and an Ansible playbook referenced via `&gt;&gt;spec_dir&lt;</p>"},{"location":"reference/supported-os/","title":"Supported Operating Systems","text":"<p>This page is auto-generated from the spec data files.</p>"},{"location":"reference/supported-os/#summary","title":"Summary","text":"Metric Count Distributions 11 Total versions 258 Total specs (version x arch) 701"},{"location":"reference/supported-os/#overview","title":"Overview","text":"Distribution Versions Architectures Installer Cloud Red Hat Enterprise Linux 2.1 - 10.1 i386, x86_64, aarch64 kickstart Azure, GCP, AWS AlmaLinux 8.3 - 10.1 x86_64, aarch64 kickstart Azure, GCP, AWS Rocky Linux 8.3 - 10.1 x86_64, aarch64 kickstart Azure, GCP, AWS CentOS 5.0 - 8.5 i386, x86_64, aarch64 kickstart Azure, GCP, AWS Oracle Enterprise Linux 5.0 - 10.1 i386, x86_64, aarch64 kickstart Azure, GCP, AWS Debian 8.0 - 13.3 i386, x86_64, aarch64 preseed Azure, GCP, AWS Ubuntu 18.04 - 24.04 x86_64, aarch64 cloud-init Azure, GCP, AWS SUSE Linux Enterprise Server 12.1 - 16.0 x86_64, aarch64 autoyast Azure, GCP, AWS VMware ESXi 5.5U3 - 8.0U2 x86_64 kickstart - System V Release 4 2.1 i386 none - Windows Server 2016 - 2025 x86_64 autounattend Azure, GCP, AWS"},{"location":"reference/supported-os/#distribution-details","title":"Distribution Details","text":""},{"location":"reference/supported-os/#red-hat-enterprise-linux","title":"Red Hat Enterprise Linux","text":"<p>Spec name: <code>rhel</code></p> <p>Include chain: rhel \u2192 linux \u2192 ssh</p> <p>Installer type: kickstart</p> <p>Version ranges: <code>2.1, 3.0, 4.8, 5.[1,9,10,11], 6.[9-10], 7.[5-9], 8.[0,1,2,3,5,6,7,8,9,10], 9.[0-7], 10.[0-1]</code></p> <p>Versions (34): 2.1, 3.0, 4.8, 5.1, 5.9, 5.10, 5.11, 6.9, 6.10, 7.5, 7.6, 7.7, 7.8, 7.9, 8.0, 8.1, 8.2, 8.3, 8.5, 8.6, 8.7, 8.8, 8.9, 8.10, 9.0, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 10.0, 10.1</p> <p>Architectures: i386, x86_64, aarch64</p> <p>Platforms: Local: virtualbox, vmware, qemu, libvirt, xenserver, hyperv | Enterprise: vsphere, proxmox | Cloud: azure, gcp, aws | Other: none</p> <p>Cloud image support:</p> <ul> <li>AZURE: version patterns 10., 7., 8., 9.</li> <li>GCP: version patterns 10., 7., 8., 9.</li> <li>AWS: version patterns 10., 7., 8., 9.</li> </ul> <p>Spec count: 102</p>"},{"location":"reference/supported-os/#almalinux","title":"AlmaLinux","text":"<p>Spec name: <code>alma</code></p> <p>Include chain: alma \u2192 rhel \u2192 linux \u2192 ssh</p> <p>Installer type: kickstart</p> <p>Version ranges: <code>8.[3-10], 9.[0-7], 10.[0-1]</code></p> <p>Versions (18): 8.3, 8.4, 8.5, 8.6, 8.7, 8.8, 8.9, 8.10, 9.0, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 10.0, 10.1</p> <p>Architectures: x86_64, aarch64</p> <p>Platforms: Local: virtualbox, vmware, qemu, libvirt, xenserver, hyperv | Enterprise: vsphere, proxmox | Cloud: azure, gcp, aws | Other: none</p> <p>Cloud image support:</p> <ul> <li>AZURE: version patterns 10., 8., 9.*</li> <li>GCP: version patterns 10., 8., 9.*</li> <li>AWS: version patterns 10., 8., 9.*</li> </ul> <p>Spec count: 36</p>"},{"location":"reference/supported-os/#rocky-linux","title":"Rocky Linux","text":"<p>Spec name: <code>rocky</code></p> <p>Include chain: rocky \u2192 rhel \u2192 linux \u2192 ssh</p> <p>Installer type: kickstart</p> <p>Version ranges: <code>8.[3-9], 9.[0-7], 10.[0-1]</code></p> <p>Versions (17): 8.3, 8.4, 8.5, 8.6, 8.7, 8.8, 8.9, 9.0, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 10.0, 10.1</p> <p>Architectures: x86_64, aarch64</p> <p>Platforms: Local: virtualbox, vmware, qemu, libvirt, xenserver, hyperv | Enterprise: vsphere, proxmox | Cloud: azure, gcp, aws | Other: none</p> <p>Cloud image support:</p> <ul> <li>AZURE: version patterns 10., 8., 9.*</li> <li>GCP: version patterns 10., 8., 9.*</li> <li>AWS: version patterns 10., 8., 9.*</li> </ul> <p>Spec count: 34</p>"},{"location":"reference/supported-os/#centos","title":"CentOS","text":"<p>Spec name: <code>centos</code></p> <p>Include chain: centos \u2192 rhel \u2192 linux \u2192 ssh</p> <p>Installer type: kickstart</p> <p>Version ranges: <code>5.[0-10], 6.[0-10], 7.[0-9], 8.[0-5]</code></p> <p>Versions (38): 5.0, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 5.9, 5.10, 6.0, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8, 6.9, 6.10, 7.0, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 8.0, 8.1, 8.2, 8.3, 8.4, 8.5</p> <p>Architectures: i386, x86_64, aarch64</p> <p>Platforms: Local: virtualbox, vmware, qemu, libvirt, xenserver, hyperv | Enterprise: vsphere, proxmox | Cloud: azure, gcp, aws | Other: none</p> <p>Cloud image support:</p> <ul> <li>AZURE: version patterns 7., 8.</li> <li>GCP: version patterns 7., 8.</li> <li>AWS: version patterns 7., 8.</li> </ul> <p>Spec count: 114</p>"},{"location":"reference/supported-os/#oracle-enterprise-linux","title":"Oracle Enterprise Linux","text":"<p>Spec name: <code>oel</code></p> <p>Include chain: oel \u2192 rhel \u2192 linux \u2192 ssh</p> <p>Installer type: kickstart</p> <p>Version ranges: <code>5.[0-10], 6.[0-10], 7.[0-9], 8.[0-10], 9.[0-7], 10.[0-1]</code></p> <p>Versions (53): 5.0, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 5.9, 5.10, 6.0, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8, 6.9, 6.10, 7.0, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 8.0, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8, 8.9, 8.10, 9.0, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 10.0, 10.1</p> <p>Architectures: i386, x86_64, aarch64</p> <p>Platforms: Local: virtualbox, vmware, qemu, libvirt, xenserver, hyperv | Enterprise: vsphere, proxmox | Cloud: azure, gcp, aws | Other: none</p> <p>Cloud image support:</p> <ul> <li>AZURE: version patterns 10., 7., 8., 9.</li> <li>GCP: version patterns 10., 7., 8., 9.</li> <li>AWS: version patterns 10., 7., 8., 9.</li> </ul> <p>Spec count: 159</p>"},{"location":"reference/supported-os/#debian","title":"Debian","text":"<p>Spec name: <code>debian</code></p> <p>Include chain: debian \u2192 linux \u2192 ssh</p> <p>Installer type: preseed</p> <p>Version ranges: <code>8.[0-11], 9.[0-13], 10.[0-13], 11.[0-11], 12.[0-13], 13.[0-3]</code></p> <p>Versions (70): 8.0, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8, 8.9, 8.10, 8.11, 9.0, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 9.8, 9.9, 9.10, 9.11, 9.12, 9.13, 10.0, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7, 10.8, 10.9, 10.10, 10.11, 10.12, 10.13, 11.0, 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8, 11.9, 11.10, 11.11, 12.0, 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7, 12.8, 12.9, 12.10, 12.11, 12.12, 12.13, 13.0, 13.1, 13.2, 13.3</p> <p>Architectures: i386, x86_64, aarch64</p> <p>Platforms: Local: virtualbox, vmware, qemu, libvirt, xenserver, hyperv | Enterprise: vsphere, proxmox | Cloud: azure, gcp, aws | Other: none</p> <p>Cloud image support:</p> <ul> <li>AZURE: version patterns 11., 12.</li> <li>GCP: version patterns 11., 12.</li> <li>AWS: version patterns 11., 12.</li> </ul> <p>Spec count: 210</p>"},{"location":"reference/supported-os/#ubuntu","title":"Ubuntu","text":"<p>Spec name: <code>ubuntu</code></p> <p>Include chain: ubuntu \u2192 linux \u2192 ssh</p> <p>Installer type: cloud-init</p> <p>Version ranges: <code>18.04, 20.04, 22.04, 24.04</code></p> <p>Versions (4): 18.04, 20.04, 22.04, 24.04</p> <p>Architectures: x86_64, aarch64</p> <p>Platforms: Local: virtualbox, vmware, qemu, libvirt, xenserver, hyperv | Enterprise: vsphere, proxmox | Cloud: azure, gcp, aws | Other: none</p> <p>Cloud image support:</p> <ul> <li>AZURE: version patterns 20.04, 22.04, 24.04</li> <li>GCP: version patterns 20.04, 22.04, 24.04</li> <li>AWS: version patterns 20.04, 22.04, 24.04</li> </ul> <p>Spec count: 8</p>"},{"location":"reference/supported-os/#suse-linux-enterprise-server","title":"SUSE Linux Enterprise Server","text":"<p>Spec name: <code>sles</code></p> <p>Include chain: sles \u2192 linux \u2192 ssh</p> <p>Installer type: autoyast</p> <p>Version ranges: <code>12.[1-5], 15.[0-7], 16.[0-0]</code></p> <p>Versions (14): 12.1, 12.2, 12.3, 12.4, 12.5, 15.0, 15.1, 15.2, 15.3, 15.4, 15.5, 15.6, 15.7, 16.0</p> <p>Architectures: x86_64, aarch64</p> <p>Platforms: Local: virtualbox, vmware, qemu, libvirt, xenserver, hyperv | Enterprise: vsphere, proxmox | Cloud: azure, gcp, aws | Other: none</p> <p>Cloud image support:</p> <ul> <li>AZURE: version patterns 15.*</li> <li>GCP: version patterns 15.*</li> <li>AWS: version patterns 15.*</li> </ul> <p>Spec count: 28</p>"},{"location":"reference/supported-os/#vmware-esxi","title":"VMware ESXi","text":"<p>Spec name: <code>esxi</code></p> <p>Installer type: kickstart</p> <p>Version ranges: <code>5.5U3, 6.0U2, 6.5, 7.0U3n, 8.0U2</code></p> <p>Versions (5): 5.5U3, 6.0U2, 6.5, 7.0U3n, 8.0U2</p> <p>Architectures: x86_64</p> <p>Platforms: Local: vmware | Enterprise: vsphere</p> <p>Spec count: 5</p>"},{"location":"reference/supported-os/#system-v-release-4","title":"System V Release 4","text":"<p>Spec name: <code>sysvr4</code></p> <p>Installer type: none</p> <p>Version ranges: <code>2.1</code></p> <p>Versions (1): 2.1</p> <p>Architectures: i386</p> <p>Platforms: Local: virtualbox, vmware | Enterprise: proxmox</p> <p>Spec count: 1</p>"},{"location":"reference/supported-os/#windows-server","title":"Windows Server","text":"<p>Spec name: <code>windows-server</code></p> <p>Include chain: windows-server \u2192 windows \u2192 winrm</p> <p>Installer type: autounattend</p> <p>Version ranges: <code>2016, 2019, 2022, 2025</code></p> <p>Versions (4): 2016, 2019, 2022, 2025</p> <p>Architectures: x86_64</p> <p>Platforms: Local: virtualbox, vmware, xenserver, hyperv | Enterprise: vsphere, proxmox | Cloud: azure, gcp, aws | Other: none</p> <p>Cloud image support:</p> <ul> <li>AZURE: version patterns 2016, 2019, 2022, 2025</li> <li>GCP: version patterns 2016, 2019, 2022, 2025</li> <li>AWS: version patterns 2016, 2019, 2022, 2025</li> </ul> <p>Spec count: 4</p>"}]}